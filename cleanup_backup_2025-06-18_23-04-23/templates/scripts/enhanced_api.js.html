<script>
/**
 * Enhanced API Client for Server-Specific Operations
 * ==================================================
 * Modular script to enhance existing functionality
 */

// Enhanced API client with server context
class GustBotAPI {
    constructor() {
        this.currentServer = localStorage.getItem('gust_current_server') || null;
        this.currentUser = localStorage.getItem('gust_current_user') || null;
    }

    // Server context management
    setCurrentServer(serverId) {
        this.currentServer = serverId;
        localStorage.setItem('gust_current_server', serverId);
        this.emitServerChange(serverId);
    }

    getCurrentServer() {
        return this.currentServer;
    }

    setCurrentUser(userId) {
        this.currentUser = userId;
        localStorage.setItem('gust_current_user', userId);
        this.emitUserChange(userId);
    }

    getCurrentUser() {
        return this.currentUser;
    }

    // Event emission for component communication
    emitServerChange(serverId) {
        document.dispatchEvent(new CustomEvent('serverChanged', {
            detail: { serverId: serverId }
        }));
    }

    emitUserChange(userId) {
        document.dispatchEvent(new CustomEvent('userChanged', {
            detail: { userId: userId }
        }));
    }

    // Enhanced API methods with server context
    async makeRequest(endpoint, options = {}) {
        const defaultOptions = {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        };

        const finalOptions = { ...defaultOptions, ...options };
        
        try {
            const response = await fetch(endpoint, finalOptions);
            return await response.json();
        } catch (error) {
            console.error('API request failed:', error);
            return { success: false, error: error.message };
        }
    }

    // Server-specific economy methods
    async getBalance(userId = null, serverId = null) {
        const user = userId || this.currentUser;
        const server = serverId || this.currentServer;
        
        if (!user || !server) {
            return { success: false, error: 'User and server required' };
        }

        return this.makeRequest(/api/economy/balance/${user}/${server});
    }

    // Server-specific gambling methods
    async getGamblingStats(userId = null, serverId = null) {
        const user = userId || this.currentUser;
        const server = serverId || this.currentServer;
        
        if (!user || !server) {
            return { success: false, error: 'User and server required' };
        }

        return this.makeRequest(/api/gambling/stats/${user}/${server});
    }

    // User management methods
    async registerUser(userId, nickname) {
        return this.makeRequest('/api/users/register', {
            method: 'POST',
            body: JSON.stringify({ userId, nickname })
        });
    }

    async getUserProfile(userId) {
        return this.makeRequest(/api/users/profile/${userId});
    }

    // Utility methods
    formatCurrency(amount) {
        return new Intl.NumberFormat('en-US').format(amount);
    }
}

// Initialize global API client
if (!window.gustAPI) {
    window.gustAPI = new GustBotAPI();
}

// Server selector functionality
function initializeServerSelector() {
    const serverSelect = document.getElementById('serverSelect');
    const addServerBtn = document.getElementById('addServerBtn');
    const addServerModal = document.getElementById('addServerModal');
    
    if (serverSelect) {
        serverSelect.addEventListener('change', (e) => {
            const serverId = e.target.value;
            window.gustAPI.setCurrentServer(serverId);
            
            // Update server status display
            const serverStatus = document.getElementById('serverStatus');
            if (serverStatus) {
                const selectedOption = e.target.selectedOptions[0];
                serverStatus.textContent = serverId ? selectedOption.textContent : 'No server selected';
            }
        });
    }

    if (addServerBtn) {
        addServerBtn.addEventListener('click', () => {
            addServerModal?.classList.remove('hidden');
        });
    }
}

// User registration functionality
function initializeUserRegistration() {
    const userInfo = document.getElementById('userInfo');
    const profileBtn = document.getElementById('profileBtn');
    const registrationModal = document.getElementById('registrationModal');
    
    if (userInfo) {
        userInfo.addEventListener('click', () => {
            if (!window.gustAPI.getCurrentUser()) {
                registrationModal?.classList.remove('hidden');
            }
        });
    }

    if (profileBtn) {
        profileBtn.addEventListener('click', () => {
            if (window.gustAPI.getCurrentUser()) {
                alert('Profile management coming soon!');
            } else {
                registrationModal?.classList.remove('hidden');
            }
        });
    }
}

// Dashboard enhancement functionality
function enhanceDashboard() {
    // Listen for server changes
    document.addEventListener('serverChanged', (e) => {
        updateDashboardData(e.detail.serverId);
    });

    // Listen for user changes
    document.addEventListener('userChanged', (e) => {
        updateUserDisplay(e.detail.userId);
    });
}

async function updateDashboardData(serverId) {
    if (!serverId || !window.gustAPI.getCurrentUser()) return;

    try {
        // Update user balance
        const balanceData = await window.gustAPI.getBalance();
        if (balanceData.success) {
            const balanceEl = document.getElementById('userBalance');
            const rankEl = document.getElementById('balanceRank');
            if (balanceEl) balanceEl.textContent = window.gustAPI.formatCurrency(balanceData.balance);
            if (rankEl) rankEl.textContent = Rank: ${balanceData.rank || '--'};
        }

        // Update gambling stats
        const gamblingData = await window.gustAPI.getGamblingStats();
        if (gamblingData.success) {
            const winRateEl = document.getElementById('gamblingWinRate');
            const gamesEl = document.getElementById('gamesPlayed');
            if (winRateEl) winRateEl.textContent = <code>${(gamblingData.winRate * 100).toFixed(1)}%;
            if (gamesEl) gamesEl.textContent = </code>${gamblingData.gamesPlayed} games;
        }

    } catch (error) {
        console.error('Error updating dashboard:', error);
    }
}

function updateUserDisplay(userId) {
    const avatar = document.getElementById('userAvatar');
    const displayName = document.getElementById('userDisplayName');
    const subtext = document.getElementById('userSubtext');
    
    if (userId) {
        if (avatar) avatar.textContent = userId.charAt(0).toUpperCase();
        if (displayName) displayName.textContent = userId;
        if (subtext) subtext.textContent = 'Logged in';
    } else {
        if (avatar) avatar.textContent = '?';
        if (displayName) displayName.textContent = 'Not logged in';
        if (subtext) subtext.textContent = 'Click to register';
    }
}

// Initialize all enhanced functionality
document.addEventListener('DOMContentLoaded', function() {
    initializeServerSelector();
    initializeUserRegistration();
    enhanceDashboard();
    
    console.log('🎨 Enhanced modular components initialized');
});
</script>
