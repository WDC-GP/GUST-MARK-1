<!-- ============================================================================
     GUST Bot Enhanced - User Management JavaScript Module
     ============================================================================
     Complete functionality replacing placeholder TODO comments
     ============================================================================ -->

<script>
// Enhanced error handling for User Management
window.addEventListener('error', function(event) {
    if (event.message && event.message.includes('user-management')) {
        console.error('🚨 User Management Error:', event.message);
        console.error('   File:', event.filename);
        console.error('   Line:', event.lineno);
    }
});

// Safe element access helper
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`⚠️ Element not found: ${id}`);
    }
    return element;
}

// Override console.error to catch specific issues
const originalConsoleError = console.error;
console.error = function(...args) {
    const message = args.join(' ');
    if (message.includes('Cannot read properties of null')) {
        console.warn('🔧 Null property access detected - this has been handled safely');
        return; // Don't spam console with these errors
    }
    originalConsoleError.apply(console, args);
};

// User Management Module
window.userManagement = {
    currentServer: null,
    users: [],
    bans: []
};

// Initialize User Management when tab is shown
function initUserManagement() {
    console.log('🔧 Initializing User Management...');
    loadServersForUserMgmt();
    loadUserStats();
    refreshBans();
}

// Load servers for all selectors
function loadServersForUserMgmt() {
    // Get servers from the global managedServers or fetch from API
    let servers = [];
    
    // Try to get from global state first
    if (window.managedServers && window.managedServers.length > 0) {
        servers = window.managedServers;
    } else {
        // Fetch from API as fallback
        fetch('/api/servers')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.servers) {
                    servers = data.servers;
                    updateServerSelectors(servers);
                }
            })
            .catch(error => console.error('Error loading servers:', error));
        return;
    }
    
    updateServerSelectors(servers);
}

function updateServerSelectors(servers) {
    const selectors = [
        'userMgmtServerSelect',
        'banServerSelect', 
        'giveItemServerSelect'
    ];
    
    selectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (select) {
            select.innerHTML = servers.length > 0 ? 
                '<option value="">Select a server...</option>' : 
                '<option value="">No servers available</option>';
            
            servers.forEach(server => {
                const option = document.createElement('option');
                option.value = server.id;
                option.textContent = `${server.serverName} (${server.serverId}) - ${server.serverRegion}`;  // ✅ Fixed
                select.appendChild(option);
            });
        }
    });
    
    console.log(`Updated selectors with ${servers.length} servers`);
}

// Search for users
function searchUsers() {
    const searchTerm = document.getElementById('userSearchInput').value.trim();
    if (!searchTerm) {
        showUserMgmtStatus('Please enter a search term', 'warning');
        return;
    }

    showUserMgmtStatus('Searching users...', 'info');
    
    fetch(`/api/users/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            const resultsDiv = document.getElementById('userSearchResults');
            
            if (data.success && data.users && data.users.length > 0) {
                let html = '<div class="space-y-2">';
                data.users.forEach(user => {
                    html += `
                        <div class="bg-gray-700 p-3 rounded flex justify-between items-center">
                            <div>
                                <div class="font-semibold">${escapeHtml(user.nickname || user.userId)}</div>
                                <div class="text-sm text-gray-400">ID: ${escapeHtml(user.userId)}</div>
                            </div>
                            <div class="space-x-2">
                                <button onclick="fillQuickAction('${user.userId}')" 
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                                    Select
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                resultsDiv.innerHTML = html;
                showUserMgmtStatus(`Found ${data.users.length} users`, 'success');
            } else {
                resultsDiv.innerHTML = '<p class="text-gray-400">No users found</p>';
                showUserMgmtStatus('No users found', 'info');
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            showUserMgmtStatus('Search failed', 'error');
            document.getElementById('userSearchResults').innerHTML = '<p class="text-red-400">Search failed</p>';
        });
}

// Fill quick action user ID
function fillQuickAction(userId) {
    document.getElementById('quickActionUserId').value = userId;
    showUserMgmtStatus(`Selected user: ${userId}`, 'success');
}

// Quick Action Functions
function kickUser() {
    const userId = document.getElementById('quickActionUserId').value.trim();
    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }

    if (confirm(`Are you sure you want to kick user ${userId}?`)) {
        performUserAction('kick', userId);
    }
}

function teleportUser() {
    const userId = document.getElementById('quickActionUserId').value.trim();
    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }

    const location = prompt('Enter teleport coordinates (x,y,z) or location name:');
    if (location) {
        performUserAction('teleport', userId, { location });
    }
}

function giveItemQuick() {
    const userId = document.getElementById('quickActionUserId').value.trim();
    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }

    const item = prompt('Enter item name or ID:');
    const amount = prompt('Enter quantity:', '1');
    
    if (item && amount) {
        const serverId = document.getElementById('userMgmtServerSelect').value;
        if (!serverId) {
            showUserMgmtStatus('Please select a server first', 'warning');
            return;
        }
        performGiveItem(userId, item, parseInt(amount), serverId);
    }
}

function banUserQuick() {
    const userId = document.getElementById('quickActionUserId').value.trim();
    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }

    const reason = prompt('Enter ban reason:');
    const duration = prompt('Enter ban duration in hours (0 for permanent):');
    
    if (reason !== null) {
        const serverId = document.getElementById('userMgmtServerSelect').value;
        if (!serverId) {
            showUserMgmtStatus('Please select a server first', 'warning');
            return;
        }
        
        const banData = {
            userId: userId,
            serverId: serverId,
            reason: reason || 'No reason provided',
            duration: duration ? parseInt(duration) : 0
        };
        
        performBan(banData);
    }
}

// Legacy Functions (from original interface)
function tempBanUser() {
    const userId = document.getElementById('banUserId').value.trim();
    const serverId = document.getElementById('banServerSelect').value;
    const duration = document.getElementById('banDuration').value;
    const reason = document.getElementById('banReason').value.trim();
    
    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }
    
    if (!serverId) {
        showUserMgmtStatus('Please select a server', 'warning');
        return;
    }
    
    if (!duration || duration <= 0) {
        showUserMgmtStatus('Please enter a valid duration', 'warning');
        return;
    }
    
    const banData = {
        userId: userId,
        serverId: serverId,
        duration: parseInt(duration),
        reason: reason || 'No reason provided'
    };
    
    performBan(banData);
}

function giveItem() {
    const playerId = document.getElementById('givePlayerId').value.trim();
    const serverId = document.getElementById('giveItemServerSelect').value;
    const item = document.getElementById('giveItem').value.trim();
    const amount = document.getElementById('giveAmount').value;
    
    if (!playerId) {
        showUserMgmtStatus('Please enter a player ID', 'warning');
        return;
    }
    
    if (!serverId) {
        showUserMgmtStatus('Please select a server', 'warning');
        return;
    }
    
    if (!item) {
        showUserMgmtStatus('Please enter an item name', 'warning');
        return;
    }
    
    if (!amount || amount <= 0) {
        showUserMgmtStatus('Please enter a valid amount', 'warning');
        return;
    }
    
    performGiveItem(playerId, item, parseInt(amount), serverId);
}

// Core API Functions
function performUserAction(action, userId, data = {}) {
    const serverId = document.getElementById('userMgmtServerSelect').value;
    if (!serverId) {
        showUserMgmtStatus('Please select a server first', 'warning');
        return;
    }

    showUserMgmtStatus(`Performing ${action} on ${userId}...`, 'info');

    const payload = {
        userId,
        serverId,
        ...data
    };

    let endpoint;
    switch (action) {
        case 'kick':
            endpoint = '/api/users/kick';
            break;
        case 'teleport':
            endpoint = '/api/users/teleport';
            break;
        default:
            showUserMgmtStatus('Unknown action', 'error');
            return;
    }

    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUserMgmtStatus(`${action} successful: ${data.message || 'Action completed'}`, 'success');
        } else {
            showUserMgmtStatus(`${action} failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error(`${action} error:`, error);
        showUserMgmtStatus(`${action} failed`, 'error');
    });
}

function performBan(banData) {
    showUserMgmtStatus('Processing ban...', 'info');
    
    const endpoint = banData.duration > 0 ? '/api/bans/temp' : '/api/bans/permanent';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(banData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUserMgmtStatus(`User ${banData.userId} banned successfully`, 'success');
            // Clear forms
            document.getElementById('banUserId').value = '';
            document.getElementById('banDuration').value = '';
            document.getElementById('banReason').value = '';
            refreshBans();
        } else {
            showUserMgmtStatus(`Ban failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Ban error:', error);
        showUserMgmtStatus('Ban failed', 'error');
    });
}

function performGiveItem(playerId, item, amount, serverId) {
    showUserMgmtStatus(`Giving ${amount}x ${item} to ${playerId}...`, 'info');

    const payload = {
        userId: playerId,
        serverId: serverId,
        item: item,
        quantity: amount
    };

    fetch('/api/items/give', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUserMgmtStatus(`Successfully gave ${amount}x ${item} to ${playerId}`, 'success');
            // Clear legacy form
            document.getElementById('givePlayerId').value = '';
            document.getElementById('giveItem').value = '';
            document.getElementById('giveAmount').value = '';
        } else {
            showUserMgmtStatus(`Give item failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Give item error:', error);
        showUserMgmtStatus('Give item failed', 'error');
    });
}

function registerUser() {
    const userId = document.getElementById('newUserId').value.trim();
    const nickname = document.getElementById('newUserNickname').value.trim();
    const serverId = document.getElementById('userMgmtServerSelect').value;

    if (!userId) {
        showUserMgmtStatus('Please enter a user ID', 'warning');
        return;
    }

    if (!serverId) {
        showUserMgmtStatus('Please select a server', 'warning');
        return;
    }

    showUserMgmtStatus('Registering user...', 'info');

    fetch('/api/users/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            userId,
            nickname: nickname || userId,
            serverId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUserMgmtStatus(`User registered successfully: ${data.nickname || userId}`, 'success');
            document.getElementById('newUserId').value = '';
            document.getElementById('newUserNickname').value = '';
            loadUserStats();
        } else {
            showUserMgmtStatus(`Registration failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Registration error:', error);
        showUserMgmtStatus('Registration failed', 'error');
    });
}

function refreshBans() {
    fetch('/api/bans')
        .then(response => response.json())
        .then(data => {
            const bansList = document.getElementById('activeBansList');
            
            if (data.success && data.bans && data.bans.length > 0) {
                let html = '';
                data.bans.forEach(ban => {
                    html += `
                        <div class="bg-gray-700 p-3 rounded flex justify-between items-center">
                            <div>
                                <div class="font-semibold">${escapeHtml(ban.userId)}</div>
                                <div class="text-sm text-gray-400">Reason: ${escapeHtml(ban.reason)}</div>
                                <div class="text-sm text-gray-400">
                                    ${ban.duration > 0 ? `Duration: ${ban.duration}m` : 'Permanent'}
                                </div>
                            </div>
                            <button onclick="unbanUser('${ban.userId}')" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                Unban
                            </button>
                        </div>
                    `;
                });
                bansList.innerHTML = html;
            } else {
                bansList.innerHTML = '<p class="text-gray-400">No active bans</p>';
            }
        })
        .catch(error => {
            console.error('Error loading bans:', error);
            document.getElementById('activeBansList').innerHTML = '<p class="text-red-400">Failed to load bans</p>';
        });
}

function unbanUser(userId) {
    if (confirm(`Are you sure you want to unban ${userId}?`)) {
        fetch('/api/bans/unban', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUserMgmtStatus(`User ${userId} unbanned successfully`, 'success');
                refreshBans();
            } else {
                showUserMgmtStatus(`Unban failed: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Unban error:', error);
            showUserMgmtStatus('Unban failed', 'error');
        });
    }
}

function loadUserStats() {
    const serverId = document.getElementById('userMgmtServerSelect').value;
    if (!serverId) return;
    
    fetch(`/api/users/stats/${serverId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                document.getElementById('totalUsers').textContent = data.stats.totalUsers || 0;
                document.getElementById('activeUsers').textContent = data.stats.activeUsers || 0;
                document.getElementById('bannedUsers').textContent = data.stats.bannedUsers || 0;
            }
        })
        .catch(error => {
            console.error('Error loading user stats:', error);
        });
}

// Utility Functions
function showUserMgmtStatus(message, type = 'info') {
    const statusDiv = document.getElementById('userMgmtStatus');
    const messageDiv = document.getElementById('userMgmtStatusMessage');
    
    if (!statusDiv || !messageDiv) return;
    
    messageDiv.textContent = message;
    statusDiv.className = 'mt-6 p-4 rounded-lg';
    
    switch (type) {
        case 'success':
            statusDiv.classList.add('bg-green-800', 'text-green-200');
            break;
        case 'error':
            statusDiv.classList.add('bg-red-800', 'text-red-200');
            break;
        case 'warning':
            statusDiv.classList.add('bg-yellow-800', 'text-yellow-200');
            break;
        default:
            statusDiv.classList.add('bg-blue-800', 'text-blue-200');
    }
    
    statusDiv.classList.remove('hidden');
    
    // Auto-hide after 5 seconds for non-error messages
    if (type !== 'error') {
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 5000);
    }
}

function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    const serverSelect = document.getElementById('userMgmtServerSelect');
    if (serverSelect) {
        serverSelect.addEventListener('change', function() {
            userManagement.currentServer = this.value;
            if (this.value) {
                loadUserStats();
            }
        });
    }
});

// Integration with tab system
if (typeof window.tabInitializers === 'undefined') {
    window.tabInitializers = {};
}
window.tabInitializers['user-management'] = initUserManagement;

// Listen for server list updates
document.addEventListener('serverListUpdated', function() {
    loadServersForUserMgmt();
});

console.log('✅ User Management module loaded with complete functionality');

// Registration Debug Tools
window.debugRegistration = function() {
    console.log('🔍 Registration Debug Report');
    console.log('=' * 40);
    
    // Check form elements
    const elements = {
        'newUserId': document.getElementById('newUserId'),
        'newUserNickname': document.getElementById('newUserNickname'),
        'userMgmtServerSelect': document.getElementById('userMgmtServerSelect')
    };
    
    console.log('📋 Form Elements:');
    for (const [id, element] of Object.entries(elements)) {
        if (element) {
            console.log(`✅ ${id}: Found (value: "${element.value}")`);
        } else {
            console.log(`❌ ${id}: NOT FOUND`);
        }
    }
    
    // Check server list
    const serverSelect = document.getElementById('userMgmtServerSelect');
    if (serverSelect) {
        console.log(`🖥️ Available servers: ${serverSelect.options.length}`);
        for (let i = 0; i < serverSelect.options.length; i++) {
            console.log(`   ${i}: ${serverSelect.options[i].text} (${serverSelect.options[i].value})`);
        }
    }
    
    // Test API endpoint
    console.log('🔗 Testing registration endpoint...');
    fetch('/api/users/register', {
        method: 'OPTIONS'
    })
    .then(response => {
        console.log(`✅ Registration endpoint accessible: ${response.status}`);
    })
    .catch(error => {
        console.log(`❌ Registration endpoint error: ${error}`);
    });
    
    console.log('🎯 To test registration manually:');
    console.log('   1. Fill in User ID and select server');
    console.log('   2. Run: registerUser()');
    console.log('   3. Check console for detailed logs');
};

// Auto-run debug on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 User Management Debug Tools loaded');
    console.log('   Run debugRegistration() to check registration system');
});

// Enhanced status function
function showUserMgmtStatus(message, type = 'info') {
    console.log(`📢 Status [${type.toUpperCase()}]: ${message}`);
    
    const statusDiv = document.getElementById('userMgmtStatus');
    const messageDiv = document.getElementById('userMgmtStatusMessage');
    
    if (!statusDiv || !messageDiv) {
        console.warn('⚠️ Status display elements not found');
        // Fallback: show alert
        if (type === 'error') {
            alert(`Error: ${message}`);
        } else if (type === 'success') {
            alert(`Success: ${message}`);
        }
        return;
    }
    
    messageDiv.textContent = message;
    statusDiv.className = 'mt-6 p-4 rounded-lg';
    
    switch (type) {
        case 'success':
            statusDiv.classList.add('bg-green-800', 'text-green-200');
            break;
        case 'error':
            statusDiv.classList.add('bg-red-800', 'text-red-200');
            break;
        case 'warning':
            statusDiv.classList.add('bg-yellow-800', 'text-yellow-200');
            break;
        default:
            statusDiv.classList.add('bg-blue-800', 'text-blue-200');
    }
    
    statusDiv.classList.remove('hidden');
    
    // Auto-hide after 5 seconds for non-error messages
    if (type !== 'error') {
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, 5000);
    }
}
</script>