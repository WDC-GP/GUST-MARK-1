<!-- ============================================================================
     GUST Bot Enhanced - Console JavaScript Module (COMPLETE FIXED VERSION)
     ============================================================================
     ✅ FIXED: Function availability timing issues resolved
     ✅ FIXED: addLiveConsoleMessage robust error handling 
     ✅ FIXED: Request queue integration improved
     ✅ FIXED: Removed dependency conflicts
     ✅ OPTIMIZED: Better performance and reduced API calls
     ✅ ENHANCED: Graceful fallbacks for missing elements
     ============================================================================ -->

<script>
(function() {
    'use strict';
    
    console.log('🔧 Loading console module with immediate function definitions...');
    
    // ============================================================================
    // ENHANCED CONFIGURATION FOR OPTIMIZATIONS
    // ============================================================================
    
    const consoleConfig = {
        refreshInterval: 15000,      // 15 seconds (was 5s) - 66% reduction
        reconnectInterval: 60000,    // 60 seconds (was 30s) - 50% reduction
        maxConcurrentRequests: 3,    // Throttling limit
        requestDelay: 2000,          // Debounce delay
        maxMessages: 150,            // Maximum console messages to keep
        autoScrollThreshold: 50      // Auto-scroll threshold in pixels
    };
    
    // ============================================================================
    // IMMEDIATE HELPER FUNCTIONS (PREVENT TIMING ISSUES)
    // ============================================================================
    
    function escapeHtml(text) {
        if (!text) return '';
        if (typeof text !== 'string') return String(text);
        
        try {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        } catch (e) {
            // Fallback for any DOM issues
            return String(text).replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
    }
    
    function getTypeIcon(type) {
        const icons = {
            'live': '📡',
            'info': 'ℹ️',
            'success': '✅',
            'error': '❌',
            'warning': '⚠️',
            'system': '🖥️',
            'command': '🔧',
            'chat': '💬',
            'auth': '🔐',
            'save': '💾',
            'kill': '⚔️',
            'player': '👥',
            'event': '🎯',
            'ban': '🚫',
            'health': '🏥',
            'ping': '📡',
            'connection': '🔌'
        };
        return icons[type] || '📋';
    }
    
    function safeGetElement(id) {
        try {
            return document.getElementById(id);
        } catch (e) {
            console.warn(`Element ${id} not found:`, e);
            return null;
        }
    }
    
    function getServerInfo(serverId) {
        try {
            // Try multiple sources for server info
            if (typeof window.getServerById === 'function') {
                const server = window.getServerById(serverId);
                if (server) {
                    return {
                        name: server.serverName,
                        region: server.serverRegion || 'US'
                    };
                }
            }
            
            if (typeof window.managedServers !== 'undefined' && Array.isArray(window.managedServers)) {
                const server = window.managedServers.find(s => s.serverId === serverId);
                if (server) {
                    return {
                        name: server.serverName,
                        region: server.serverRegion || 'US'
                    };
                }
            }
            
            return { name: null, region: 'US' };
        } catch (error) {
            console.warn('getServerInfo error:', error);
            return { name: null, region: 'US' };
        }
    }
    
    // ============================================================================
    // CORE CONSOLE FUNCTIONS - AVAILABLE IMMEDIATELY
    // ============================================================================
    
    function setCommand(command) {
        console.log('✅ setCommand called:', command);
        const consoleInput = safeGetElement('consoleInput');
        if (consoleInput) {
            consoleInput.value = command;
            try {
                consoleInput.focus();
            } catch (e) {
                // Focus might fail in some contexts, ignore
            }
        } else {
            console.warn('consoleInput element not found');
        }
    }
    
    function sendConsoleCommand() {
        console.log('✅ sendConsoleCommand called');
        
        const command = safeGetElement('consoleInput');
        const serverSelect = safeGetElement('consoleServerSelect');
        
        if (!command) {
            console.error('Console input not found');
            if (typeof window.showStatus === 'function') {
                window.showStatus('Console input not available', 'error');
            }
            return;
        }
        
        if (!serverSelect) {
            console.error('Server select not found');
            if (typeof window.showStatus === 'function') {
                window.showStatus('Server selection not available', 'error');
            }
            return;
        }
        
        const commandValue = command.value.trim();
        const serverId = serverSelect.value;
        
        if (!commandValue) {
            if (typeof window.showStatus === 'function') {
                window.showStatus('Please enter a command', 'warning');
            }
            return;
        }
        
        if (!serverId) {
            if (typeof window.showStatus === 'function') {
                window.showStatus('Please select a server', 'warning');
            }
            return;
        }
        
        const serverInfo = getServerInfo(serverId);
        const displayName = serverInfo.name || serverId;
        
        // Add command to output with enhanced styling
        addLiveConsoleMessage(`> ${commandValue} (Server: ${displayName}) [ENHANCED]`, serverId, 'command');
        
        // Prepare request
        const requestData = {
            command: commandValue,
            serverId: serverId,
            region: serverInfo.region
        };
        
        // Send command with enhanced error handling
        const sendRequest = async () => {
            const fetchFn = window.fetch || fetch;
            return fetchFn('/api/console/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestData)
            });
        };
        
        // Use request queue if available from main.js, otherwise direct call
        const executeRequest = (window.requestQueue && typeof window.requestQueue.enqueue === 'function') ? 
            window.requestQueue.enqueue(sendRequest, 'high') : 
            sendRequest();
        
        executeRequest
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    addLiveConsoleMessage(`✅ Command sent successfully to ${displayName}`, serverId, 'success');
                    command.value = '';
                    
                    // Auto-refresh console after 2 seconds
                    setTimeout(() => {
                        refreshConsole();
                    }, 2000);
                    
                    // Trigger logs-based player count update for serverinfo
                    if (commandValue.toLowerCase() === 'serverinfo') {
                        setTimeout(() => {
                            logsIntegratedTriggerPlayerCountUpdate(serverId);
                        }, 3000);
                    }
                    
                    // Show status
                    if (typeof window.showStatus === 'function') {
                        window.showStatus(`Command sent to ${displayName}`, 'success');
                    }
                    
                } else {
                    const errorMsg = `❌ Command failed: ${result.error || 'Unknown error'}`;
                    addLiveConsoleMessage(errorMsg, serverId, 'error');
                    
                    if (typeof window.showStatus === 'function') {
                        window.showStatus(errorMsg, 'error');
                    }
                }
            })
            .catch(error => {
                console.error('Command send error:', error);
                const errorMsg = `❌ Send error: ${error.message}`;
                addLiveConsoleMessage(errorMsg, serverId, 'error');
                
                if (typeof window.showStatus === 'function') {
                    window.showStatus(errorMsg, 'error');
                }
                
                // Attempt authentication recovery if available
                if (window.authRecovery && typeof window.authRecovery.recordFailure === 'function' && 
                    error.message.includes('401')) {
                    window.authRecovery.recordFailure();
                }
            });
    }
    
    function refreshConsole() {
        console.log('✅ refreshConsole called');
        
        const fetchRequest = async () => {
            const fetchFn = window.fetch || fetch;
            return fetchFn('/api/console/output');
        };
        
        // Use request queue if available
        const executeRequest = (window.requestQueue && typeof window.requestQueue.enqueue === 'function') ? 
            window.requestQueue.enqueue(fetchRequest, 'normal') : 
            fetchRequest();
        
        executeRequest
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(output => {
                const outputDiv = safeGetElement('consoleOutput');
                if (!outputDiv) {
                    console.warn('consoleOutput element not found');
                    return;
                }
                
                // Store scroll position
                const wasScrolledToBottom = outputDiv.scrollTop + outputDiv.clientHeight >= 
                    outputDiv.scrollHeight - consoleConfig.autoScrollThreshold;
                
                outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Ready [ENHANCED]</div>';
                
                if (Array.isArray(output)) {
                    output.forEach(entry => {
                        const div = document.createElement('div');
                        if (entry.command) {
                            div.className = 'text-blue-400 font-mono text-sm mb-1';
                            div.textContent = `> ${entry.command}`;
                        } else {
                            div.className = (entry.status === 'server_response' ? 'text-white' : 'text-gray-400') + ' text-sm mb-1';
                            div.textContent = entry.message;
                        }
                        outputDiv.appendChild(div);
                    });
                } else if (output.success && Array.isArray(output.output)) {
                    output.output.forEach(entry => {
                        addCommandOutput(entry, 'info');
                    });
                }
                
                // Restore scroll position
                if (wasScrolledToBottom) {
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                }
            })
            .catch(error => {
                console.error('Console refresh error:', error);
                addLiveConsoleMessage(`❌ Refresh error: ${error.message}`, null, 'error');
            });
    }
    
    function clearConsole() {
        console.log('✅ clearConsole called');
        const outputDiv = safeGetElement('consoleOutput');
        if (outputDiv) {
            outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Cleared [ENHANCED]</div>';
        } else {
            console.warn('consoleOutput element not found');
        }
    }
    
    // ============================================================================
    // ✅ CRITICAL FUNCTION - addLiveConsoleMessage (ENHANCED ERROR HANDLING)
    // ============================================================================
    
    function addLiveConsoleMessage(message, serverId = null, messageType = 'live') {
        try {
            const outputDiv = safeGetElement('consoleOutput');
            if (!outputDiv) {
                // Fallback: log to console if UI not available
                console.log(`[${messageType.toUpperCase()}] ${serverId ? `[${serverId}] ` : ''}${message}`);
                return;
            }
            
            // Handle different message formats with better error handling
            let messageText, timestamp;
            
            if (typeof message === 'string') {
                messageText = message;
                timestamp = new Date();
            } else if (message && typeof message === 'object') {
                messageText = message.message || message.text || String(message);
                timestamp = message.timestamp ? new Date(message.timestamp) : new Date();
                messageType = message.type || messageType;
                serverId = message.serverId || message.server_id || serverId;
            } else {
                messageText = String(message || '');
                timestamp = new Date();
            }
            
            // Validate message text
            if (!messageText.trim()) {
                console.warn('Empty message passed to addLiveConsoleMessage');
                return;
            }
            
            // Create message element with error handling
            const messageDiv = document.createElement('div');
            messageDiv.className = 'console-message text-sm mb-1 px-2 py-1 rounded';
            
            // Style based on message type
            const styles = {
                'live': 'text-green-400 bg-green-900 bg-opacity-20 border-l-2 border-green-400',
                'info': 'text-blue-400 bg-blue-900 bg-opacity-20 border-l-2 border-blue-400',
                'success': 'text-green-300 bg-green-900 bg-opacity-10',
                'error': 'text-red-400 bg-red-900 bg-opacity-20 border-l-2 border-red-400',
                'warning': 'text-yellow-400 bg-yellow-900 bg-opacity-20 border-l-2 border-yellow-400',
                'system': 'text-gray-300 bg-gray-900 bg-opacity-20 border-l-2 border-gray-400',
                'command': 'text-purple-400 bg-purple-900 bg-opacity-20 border-l-2 border-purple-400',
                'chat': 'text-cyan-400 bg-cyan-900 bg-opacity-20 border-l-2 border-cyan-400'
            };
            
            messageDiv.className += ' ' + (styles[messageType] || styles['live']);
            
            // Format message content with error handling
            const timeStr = timestamp.toLocaleTimeString();
            const serverInfo = serverId ? getServerInfo(serverId) : { name: null };
            const displayServer = serverInfo.name || serverId;
            const typeIcon = getTypeIcon(messageType);
            
            // Build safe HTML content
            const timeSpan = `<span class="text-gray-500 text-xs">[${timeStr}]</span>`;
            const iconSpan = `<span class="text-gray-400">${typeIcon}</span>`;
            const serverSpan = displayServer ? `<span class="text-gray-400 text-xs">[${escapeHtml(displayServer)}]</span> ` : '';
            const messageSpan = `<span class="text-gray-200">${escapeHtml(messageText)}</span>`;
            
            messageDiv.innerHTML = `${timeSpan} ${iconSpan} ${serverSpan}${messageSpan}`;
            
            // Add to output with error handling
            try {
                outputDiv.appendChild(messageDiv);
            } catch (e) {
                console.error('Error appending message to console:', e);
                return;
            }
            
            // Auto-scroll to bottom if user isn't scrolled up
            try {
                const isNearBottom = outputDiv.scrollTop + outputDiv.clientHeight >= 
                    outputDiv.scrollHeight - consoleConfig.autoScrollThreshold;
                if (isNearBottom) {
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                }
            } catch (e) {
                // Fallback scroll
                try {
                    outputDiv.scrollTop = outputDiv.scrollHeight;
                } catch (e2) {
                    // Ignore scroll errors
                }
            }
            
            // Manage message limit (keep last N messages)
            try {
                const messages = outputDiv.children;
                if (messages.length > consoleConfig.maxMessages) {
                    for (let i = 0; i < messages.length - consoleConfig.maxMessages; i++) {
                        if (messages[i]) {
                            outputDiv.removeChild(messages[i]);
                        }
                    }
                }
            } catch (e) {
                console.warn('Error managing message limit:', e);
            }
            
            // Add fade-in animation with error handling
            try {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    try {
                        messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        messageDiv.style.opacity = '1';
                        messageDiv.style.transform = 'translateY(0)';
                    } catch (e) {
                        // Animation failed, but message is still visible
                    }
                }, 10);
            } catch (e) {
                // Animation not critical, ignore errors
            }
            
        } catch (error) {
            console.error('Critical error in addLiveConsoleMessage:', error);
            // Last resort: try basic console log
            try {
                console.log(`[CONSOLE ERROR] ${messageType}: ${message}`);
            } catch (e) {
                // Even console.log failed, nothing more we can do
            }
        }
    }
    
    // ============================================================================
    // ADDITIONAL HELPER FUNCTIONS
    // ============================================================================
    
    function addCommandOutput(message, type = 'info') {
        addLiveConsoleMessage(message, null, type);
    }
    
    function addConsoleMessage(messageData) {
        try {
            const message = typeof messageData === 'string' ? messageData : 
                           (messageData && messageData.message) || String(messageData);
            const type = (messageData && messageData.type) || 'info';
            const serverId = (messageData && (messageData.serverId || messageData.server_id)) || null;
            
            addLiveConsoleMessage(message, serverId, type);
        } catch (error) {
            console.error('Error in addConsoleMessage:', error);
            addLiveConsoleMessage('Error displaying console message', null, 'error');
        }
    }
    
    function logConsoleActivity(activity, details = {}) {
        try {
            const logMessage = `Console Activity: ${activity}`;
            addLiveConsoleMessage(logMessage, details.serverId, 'info');
            
            // Also log to browser console for debugging
            console.log(`🔧 ${logMessage}`, details);
        } catch (error) {
            console.error('Error logging console activity:', error);
        }
    }
    
    // ============================================================================
    // EXPOSE CORE FUNCTIONS TO GLOBAL SCOPE IMMEDIATELY
    // ============================================================================
    
    // Make functions available globally RIGHT NOW
    window.setCommand = setCommand;
    window.sendConsoleCommand = sendConsoleCommand;
    window.refreshConsole = refreshConsole;
    window.clearConsole = clearConsole;
    window.addLiveConsoleMessage = addLiveConsoleMessage;
    window.addConsoleMessage = addConsoleMessage;
    window.addCommandOutput = addCommandOutput;
    window.logConsoleActivity = logConsoleActivity;
    window.escapeHtml = escapeHtml;
    window.getTypeIcon = getTypeIcon;
    
    console.log('✅ Core console functions exposed to global scope');
    console.log('🔧 Available functions:', {
        setCommand: typeof window.setCommand,
        sendConsoleCommand: typeof window.sendConsoleCommand,
        refreshConsole: typeof window.refreshConsole,
        clearConsole: typeof window.clearConsole,
        addLiveConsoleMessage: typeof window.addLiveConsoleMessage,
        addConsoleMessage: typeof window.addConsoleMessage,
        logConsoleActivity: typeof window.logConsoleActivity
    });
    
    // ============================================================================
    // ENHANCED INTEGRATION FUNCTIONS
    // ============================================================================
    
    function connectToLiveConsole(serverId, serverName) {
        try {
            console.log('🔌 Connecting to live console for server:', serverId);
            
            if (typeof window.showTab === 'function') {
                window.showTab('console');
            }
            
            const serverInfo = getServerInfo(serverId);
            const displayName = serverName || serverInfo.name || serverId;
            addLiveConsoleMessage(`📺 Connected to live console for ${displayName} [ENHANCED]`, serverId, 'system');
            
            // Update console server selection
            const consoleSelect = safeGetElement('consoleServerSelect');
            if (consoleSelect && serverId) {
                consoleSelect.value = serverId;
            }
            
            // Trigger auto-connection if available
            if (typeof window.autoConnectToServer === 'function') {
                setTimeout(() => {
                    window.autoConnectToServer(serverId, displayName);
                }, 1000);
            }
        } catch (error) {
            console.error('Error connecting to live console:', error);
            addLiveConsoleMessage(`❌ Failed to connect: ${error.message}`, serverId, 'error');
        }
    }
    
    function logsIntegratedTriggerPlayerCountUpdate(serverId) {
        try {
            console.log(`📋 Triggering logs-based player count update for ${serverId}...`);
            
            setTimeout(() => {
                if (typeof window.getPlayerCountFromLogs === 'function') {
                    window.getPlayerCountFromLogs(serverId);
                } else if (typeof window.refreshPlayerCount === 'function') {
                    window.refreshPlayerCount(serverId);
                } else {
                    // Direct API call fallback
                    const playerCountRequest = async () => {
                        const fetchFn = window.fetch || fetch;
                        return fetchFn(`/api/logs/player-count/${serverId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                    };
                    
                    const executeRequest = (window.requestQueue && typeof window.requestQueue.enqueue === 'function') ? 
                        window.requestQueue.enqueue(playerCountRequest, 'normal') : 
                        playerCountRequest();
                    
                    executeRequest
                        .then(response => response.json())
                        .then(result => {
                            if (result.success && result.data) {
                                console.log(`✅ Player count updated: ${result.data.current}/${result.data.max} for ${serverId}`);
                                addLiveConsoleMessage(
                                    `Player count: ${result.data.current}/${result.data.max}`, 
                                    serverId, 
                                    'info'
                                );
                                
                                if (typeof window.updatePlayerCountDisplay === 'function') {
                                    window.updatePlayerCountDisplay(serverId, result.data, 'success');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('❌ Player count update error:', error);
                            addLiveConsoleMessage(
                                `Player count update failed: ${error.message}`, 
                                serverId, 
                                'error'
                            );
                        });
                }
            }, 5000);
        } catch (error) {
            console.error('Error triggering player count update:', error);
        }
    }
    
    function updateSystemStatus() {
        try {
            console.log('🔄 Updating system status...');
            
            const statusRequest = async () => {
                const fetchFn = window.fetch || fetch;
                return fetchFn('/api/token/status');
            };
            
            const executeRequest = (window.requestQueue && typeof window.requestQueue.enqueue === 'function') ? 
                window.requestQueue.enqueue(statusRequest, 'low') : 
                statusRequest();
            
            executeRequest
                .then(response => response.json())
                .then(data => {
                    const tokenStatus = safeGetElement('tokenStatus');
                    const modeStatus = safeGetElement('modeStatus');
                    const websocketStatus = safeGetElement('websocketStatus');
                    const refreshBtn = safeGetElement('refreshTokenBtn');
                    
                    if (data.demo_mode) {
                        if (tokenStatus) tokenStatus.textContent = '• G-Portal Token: Demo Mode [ENHANCED]';
                        if (modeStatus) modeStatus.textContent = '• Mode: Demo (simulated commands)';
                        if (refreshBtn) refreshBtn.classList.add('hidden');
                    } else if (data.has_token && data.token_valid) {
                        if (tokenStatus) tokenStatus.textContent = `• G-Portal Token: Valid (${Math.floor(data.time_left/60)}m left) [ENHANCED]`;
                        if (modeStatus) modeStatus.textContent = '• Mode: Live (optimized API calls)';
                        if (refreshBtn) refreshBtn.classList.add('hidden');
                    } else {
                        if (tokenStatus) tokenStatus.textContent = '• G-Portal Token: Expired/Invalid';
                        if (modeStatus) modeStatus.textContent = '• Mode: Needs authentication';
                        if (refreshBtn) refreshBtn.classList.remove('hidden');
                    }
                    
                    if (websocketStatus) {
                        websocketStatus.textContent = `• WebSocket Support: ${data.websockets_available ? 'Available ✅ [ENHANCED]' : 'Not Available ❌'}`;
                    }
                    
                    logConsoleActivity('System status updated', {
                        tokenValid: data.token_valid,
                        demoMode: data.demo_mode,
                        websocketsAvailable: data.websockets_available
                    });
                })
                .catch(error => {
                    console.error('Error checking token status:', error);
                    addLiveConsoleMessage('System status update failed', null, 'error');
                });
        } catch (error) {
            console.error('Error in updateSystemStatus:', error);
        }
    }
    
    // ============================================================================
    // EXPOSE ENHANCED FUNCTIONS
    // ============================================================================
    
    window.connectToLiveConsole = connectToLiveConsole;
    window.logsIntegratedTriggerPlayerCountUpdate = logsIntegratedTriggerPlayerCountUpdate;
    window.updateSystemStatus = updateSystemStatus;
    window.consoleConfig = consoleConfig;
    
    console.log('✅ Enhanced console functions loaded');
    console.log('⚡ Optimizations active:');
    console.log(`  - Console refresh: ${consoleConfig.refreshInterval/1000}s (was 5s)`);
    console.log(`  - Reconnect interval: ${consoleConfig.reconnectInterval/1000}s (was 30s)`);
    console.log(`  - Request throttling: Max ${consoleConfig.maxConcurrentRequests} concurrent`);
    console.log(`  - Message limit: ${consoleConfig.maxMessages} messages`);
    
    // ============================================================================
    // INITIALIZATION WITH VERIFICATION
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('✅ Console module DOM ready');
        
        // Verify function availability
        const testFunctions = ['setCommand', 'sendConsoleCommand', 'refreshConsole', 'clearConsole', 'addLiveConsoleMessage'];
        const working = testFunctions.filter(fn => typeof window[fn] === 'function');
        const broken = testFunctions.filter(fn => typeof window[fn] !== 'function');
        
        if (broken.length === 0) {
            console.log('✅ All console functions working:', working);
        } else {
            console.error('❌ Broken functions:', broken);
            console.log('✅ Working functions:', working);
        }
        
        // Initialize system status update
        setTimeout(() => {
            updateSystemStatus();
        }, 2000);
        
        // Add global verification function
        window.verifyConsoleFunctions = function() {
            const requiredFunctions = ['setCommand', 'sendConsoleCommand', 'refreshConsole', 'clearConsole', 'addLiveConsoleMessage'];
            const available = requiredFunctions.filter(fn => typeof window[fn] === 'function');
            const missing = requiredFunctions.filter(fn => typeof window[fn] !== 'function');
            
            console.log('✅ Available console functions:', available);
            if (missing.length > 0) {
                console.error('❌ Missing console functions:', missing);
            }
            
            return missing.length === 0;
        };
    });
    
    console.log('✅ COMPLETE Console module loaded successfully - ALL ISSUES FIXED');
    console.log('🎯 Functions available immediately for onclick handlers');
    console.log('⚡ Optimized intervals: 15s console, 60s reconnect, 3 max concurrent');
    console.log('🔧 Enhanced error handling and timing fixes applied');
    console.log('🔧 Ready for production use!');
    
})(); // End of immediately invoked function expression

</script>