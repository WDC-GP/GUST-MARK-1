<!-- ============================================================================
     GUST Bot Enhanced - console JavaScript Module (LOGS-INTEGRATED + MODULAR)
     ============================================================================
     CORRECTED VERSION: Now integrates with logs-based player count system
     MODULAR: Respects modular architecture - console-specific functionality only
     LOGS-INTEGRATED: Triggers logs-based updates instead of parsing console output
     
     FEATURES:
     - Console command execution
     - Logs-based player count triggers
     - Proper modular separation
     - G-Portal command sending
     - Integration with logs system for player data
     ============================================================================ -->

<script>
    // ============================================================================
    // CONSOLE MODULE - LOGS-INTEGRATED VERSION
    // ============================================================================
    
    // ============================================================================
    // Function 1: displayCombinedConsoleOutput (Enhanced)
    // Dependencies: escapeHtml, getTypeIcon
    // ============================================================================

        
        // DISPLAY COMBINED CONSOLE OUTPUT (COMMANDS + LIVE MESSAGES)
        function displayCombinedConsoleOutput(consoleOutput, liveMessages) {
            const outputDiv = document.getElementById('consoleOutput');
            if (!outputDiv) return;
            
            const wasScrolledToBottom = outputDiv.scrollTop + outputDiv.clientHeight >= outputDiv.scrollHeight - 10;
            
            // Clear and add header
            outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Ready (Commands + Live Messages)</div>';
            
            // Add console command output
            consoleOutput.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'mb-1 text-sm';
                
                if (entry.command) {
                    div.className += ' text-blue-400 font-mono';
                    div.textContent = `> ${entry.command}`;
                } else {
                    div.className += entry.status === 'server_response' ? ' text-white' : ' text-gray-400';
                    div.textContent = entry.message;
                }
                
                outputDiv.appendChild(div);
            });
            
            // Add live messages if any
            if (liveMessages.length > 0) {
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'text-yellow-400 text-sm border-t border-gray-600 pt-2 mt-2';
                separator.textContent = 'üì∫ Live Console Messages:';
                outputDiv.appendChild(separator);
                
                // Add live messages
                liveMessages.forEach(message => {
                    const div = document.createElement('div');
                    div.className = 'console-live-message text-sm mb-1 pl-2 border-l-2 border-blue-500';
                    
                    const time = new Date(message.timestamp).toLocaleTimeString();
                    const type = message.type || 'system';
                    const serverId = message.server_id || message.serverId || '';
                    
                    // Format the message with timestamp and type
                    const typeIcon = getTypeIcon(type);
                    const serverInfo = serverId ? ` [${serverId}]` : '';
                    
                    div.innerHTML = `
                        <span class="text-gray-500 text-xs">[${time}]</span>
                        <span class="text-xs bg-gray-700 px-1 rounded">${typeIcon} ${type}</span>
                        ${serverInfo ? `<span class="text-xs text-gray-400">${serverInfo}</span>` : ''}
                        <div class="text-gray-200 font-mono mt-1">${escapeHtml(message.message)}</div>
                    `;
                    
                    outputDiv.appendChild(div);
                });
            }
            
            // Auto-scroll if needed
            if (autoScroll && wasScrolledToBottom) {
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }

            // LOGS-INTEGRATED: Check for serverinfo commands to trigger logs-based updates
            logsIntegratedProcessConsoleForPlayerCount(consoleOutput, liveMessages);
        }

    // ============================================================================
    // Function 2-9: All original console functions (preserved)
    // ============================================================================
        
        // TEST FUNCTION FOR LIVE CONSOLE
        async function testLiveConsole() {
            try {
                const response = await fetch('/api/console/live/test');
                const data = await response.json();
                
                const alertMsg = `Live Console Test Results:
                
‚úÖ Success: ${data.success}
üîå WebSockets Available: ${data.websockets_available}
üì° Active Connections: ${data.total_connections || 0}
üì® Recent Messages: ${data.message_count || 0}

${data.recent_messages && data.recent_messages.length > 0 ? 
  'Latest Message: ' + (data.recent_messages[data.recent_messages.length-1].message || 'N/A').substring(0, 100) : 
  'No recent messages'}

${data.error ? 'Error: ' + data.error : 'Working!'}`;
                
                alert(alertMsg);
                console.log('üîç Live Console Test Data:', data);
                
                // Also refresh the console after test
                if (window.currentTab === 'console') {
                    refreshConsoleWithLiveMessages();
                }
                
            } catch (error) {
                alert(`Test Error: ${error.message}`);
                console.error('Test error:', error);
            }
        }

        async function connectToLiveConsole(serverId) {
            // Just switch to console tab since auto-connection handles the connection
            showTab('console');
            
            addLiveConsoleMessage({
                timestamp: new Date().toISOString(),
                message: `üì∫ Switched to console view. Server ${serverId} is auto-connected for live monitoring.`,
                type: 'system',
                source: 'navigation'
            });
        }

        function clearConsole() {
            const outputDiv = document.getElementById('consoleOutput');
            if (outputDiv) {
                outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Cleared</div>';
            }
        }

        function updateSystemStatus() {
            // Check token status
            fetch('/api/token/status').then(r => r.json()).then(data => {
                const dbStatus = document.getElementById('dbStatus');
                const tokenStatus = document.getElementById('tokenStatus');
                const modeStatus = document.getElementById('modeStatus');
                const websocketStatus = document.getElementById('websocketStatus');
                const refreshBtn = document.getElementById('refreshTokenBtn');
                
                websocketsAvailable = data.websockets_available;
                
                if (data.demo_mode) {
                    tokenStatus.textContent = '‚Ä¢ G-Portal Token: Demo Mode';
                    modeStatus.textContent = '‚Ä¢ Mode: Demo (simulated commands)';
                    if (refreshBtn) refreshBtn.classList.add('hidden');
                } else if (data.has_token && data.token_valid) {
                    tokenStatus.textContent = `‚Ä¢ G-Portal Token: Valid (${Math.floor(data.time_left/60)}m left)`;
                    modeStatus.textContent = '‚Ä¢ Mode: Live (real G-Portal API)';
                    if (refreshBtn) refreshBtn.classList.add('hidden');
                } else {
                    tokenStatus.textContent = '‚Ä¢ G-Portal Token: Expired/Invalid';
                    modeStatus.textContent = '‚Ä¢ Mode: Needs authentication';
                    if (refreshBtn) refreshBtn.classList.remove('hidden');
                }
                
                if (websocketStatus) {
                    websocketStatus.textContent = `‚Ä¢ WebSocket Support: ${websocketsAvailable ? 'Available ‚úÖ' : 'Not Available ‚ùå'}`;
                }
                
                // Update live console description based on WebSocket availability
                const liveConsoleDesc = document.getElementById('liveConsoleDescription');
                const liveConsoleFeatures = document.getElementById('liveConsoleFeatures');
                const websocketStatusDetail = document.getElementById('websocketStatusDetail');
                
                if (!websocketsAvailable) {
                    if (liveConsoleDesc) {
                        liveConsoleDesc.textContent = 'WebSocket support not available. Install with: pip install websockets';
                        liveConsoleDesc.className = 'text-red-200 mb-3';
                    }
                    if (liveConsoleFeatures) {
                        liveConsoleFeatures.innerHTML = `
                            <li>‚Ä¢ Install websockets: pip install websockets</li>
                            <li>‚Ä¢ Then restart the application</li>
                            <li>‚Ä¢ Command console still works normally</li>
                            <li>‚Ä¢ Live monitoring will be available after install</li>
                        `;
                    }
                    if (websocketStatusDetail) {
                        websocketStatusDetail.innerHTML = `
                            <div class="text-red-300">WebSocket support not available</div>
                            <div class="mt-1">Install: pip install websockets</div>
                        `;
                    }
                } else {
                    if (websocketStatusDetail) {
                        websocketStatusDetail.innerHTML = `
                            <div class="text-green-300">WebSocket support available</div>
                            <div class="mt-1">Live console ready</div>
                        `;
                    }
                }
            }).catch(e => console.error('Error checking token status:', e));
            
            // Check health
            fetch('/health').then(r => r.json()).then(data => {
                const dbStatus = document.getElementById('dbStatus');
                const liveConnections = document.getElementById('liveConnections');
                
                if (dbStatus) {
                    dbStatus.textContent = '‚Ä¢ Database: ' + data.database;
                }
                
                if (liveConnections) {
                    liveConnections.textContent = data.live_connections || 0;
                }
            }).catch(e => console.error('Error checking health:', e));
        }

        // Console Functions - Updated to use centralized servers
        function setCommand(command) {
            const consoleInput = document.getElementById('consoleInput');
            if (consoleInput) {
                consoleInput.value = command;
            }
        }

        async function sendConsoleCommand() {
            const command = document.getElementById('consoleInput').value.trim();
            const serverSelect = document.getElementById('consoleServerSelect');
            const serverId = serverSelect.value;
            
            if (!command) {
                alert('Please enter a command');
                return;
            }
            
            if (!serverId) {
                alert('Please select a server from the dropdown');
                return;
            }
            
            const region = getServerRegion(serverId);
            const outputDiv = document.getElementById('consoleOutput');
            
            // Add command to output
            addCommandOutput(`> ${command} (Server: ${serverId})`, 'command');
            
            try {
                const response = await fetch('/api/console/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        command: command,
                        serverId: serverId,
                        region: region
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addCommandOutput(`‚úÖ Command sent successfully to ${getServerById(serverId)?.serverName || serverId}`, 'success');
                    document.getElementById('consoleInput').value = '';
                    
                    // Auto-refresh to show new messages
                    setTimeout(() => {
                        refreshConsoleWithLiveMessages();
                    }, 1000);

                    // LOGS-INTEGRATED: Trigger logs-based player count update for serverinfo
                    if (command.toLowerCase() === 'serverinfo') {
                        logsIntegratedTriggerPlayerCountUpdate(serverId);
                    }
                } else {
                    addCommandOutput(`‚ùå Command failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addCommandOutput(`‚ùå Send error: ${error.message}`, 'error');
            }
        }

        function addCommandOutput(message, type) {
            const outputDiv = document.getElementById('consoleOutput');
            if (!outputDiv) return;
            
            const time = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-300'}`;
            messageDiv.innerHTML = `<span class="text-gray-500">[${time}]</span> ${message}`;
            
            outputDiv.appendChild(messageDiv);
            outputDiv.scrollTop = outputDiv.scrollHeight;

            // LOGS-INTEGRATED: Check if this is a serverinfo command response
            if (type === 'success' && message.toLowerCase().includes('serverinfo')) {
                const consoleServerSelect = document.getElementById('consoleServerSelect');
                const currentServerId = consoleServerSelect ? consoleServerSelect.value : null;
                if (currentServerId) {
                    logsIntegratedTriggerPlayerCountUpdate(currentServerId);
                }
            }
        }

        function refreshConsole() {
            // Fallback console refresh (basic version)
            fetch('/api/console/output').then(r => r.json()).then(output => {
                const outputDiv = document.getElementById('consoleOutput');
                if (!outputDiv) return;
                
                outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Ready</div>';
                output.forEach(entry => {
                    const div = document.createElement('div');
                    if (entry.command) {
                        div.className = 'text-blue-400';
                        div.textContent = `> ${entry.command}`;
                    } else {
                        div.className = entry.status === 'server_response' ? 'text-white' : 'text-gray-400';
                        div.textContent = entry.message;
                    }
                    outputDiv.appendChild(div);
                });
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }).catch(e => console.error('Error refreshing console:', e));
        }

    // ============================================================================
    // LOGS-INTEGRATED PLAYER COUNT SYSTEM
    // ============================================================================

    /**
     * LOGS-INTEGRATED: Process console output to trigger logs-based player count updates
     * Instead of parsing console output, this triggers logs-based API calls
     */
    function logsIntegratedProcessConsoleForPlayerCount(consoleOutput, liveMessages) {
        try {
            // Get current server from console dropdown
            const consoleServerSelect = document.getElementById('consoleServerSelect');
            const currentServerId = consoleServerSelect ? consoleServerSelect.value : null;

            if (!currentServerId) {
                return;
            }

            console.log(`üéØ Console processing for server: ${currentServerId} - logs-integrated mode`);

            // Check console output for serverinfo commands
            let shouldTriggerLogsUpdate = false;
            
            if (consoleOutput && Array.isArray(consoleOutput)) {
                consoleOutput.forEach(entry => {
                    if (entry.command && entry.command.toLowerCase().includes('serverinfo')) {
                        shouldTriggerLogsUpdate = true;
                        console.log('üîç Serverinfo command detected in console output');
                    }
                });
            }
            
            if (liveMessages && Array.isArray(liveMessages)) {
                liveMessages.forEach(message => {
                    if (message.message && message.message.toLowerCase().includes('serverinfo')) {
                        shouldTriggerLogsUpdate = true;
                        console.log('üîç Serverinfo mention detected in live messages');
                    }
                });
            }
            
            if (shouldTriggerLogsUpdate) {
                console.log('üì° Triggering logs-based player count update...');
                logsIntegratedTriggerPlayerCountUpdate(currentServerId);
            }
        } catch (error) {
            console.warn('Logs-integrated console processing error:', error);
        }
    }

    /**
     * LOGS-INTEGRATED: Trigger logs-based player count update
     */
    function logsIntegratedTriggerPlayerCountUpdate(serverId) {
        try {
            console.log(`üìã Triggering logs-based player count update for ${serverId}...`);
            
            // Wait a moment for the command to execute and be logged
            setTimeout(() => {
                // Check if logs module function is available
                if (typeof window.getPlayerCountFromLogs === 'function') {
                    console.log('üìã Using logs module function...');
                    window.getPlayerCountFromLogs(serverId);
                } else if (typeof window.refreshPlayerCount === 'function') {
                    console.log('üìã Using main module refresh function...');
                    window.refreshPlayerCount(serverId);
                } else {
                    // Direct API call fallback
                    console.log('üìã Using direct API call...');
                    fetch(`/api/logs/player-count/${serverId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data) {
                            console.log(`‚úÖ Direct API: Player count ${result.data.current}/${result.data.max} for ${serverId}`);
                            if (typeof window.updatePlayerCountDisplay === 'function') {
                                window.updatePlayerCountDisplay(serverId, result.data, 'success');
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è Direct API failed for ${serverId}: ${result.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Direct API error:', error);
                    });
                }
            }, 4000); // Wait 4 seconds for command to execute and be logged
        } catch (error) {
            console.error('‚ùå Error triggering logs-based update:', error);
        }
    }

    /**
     * LOGS-INTEGRATED: Send serverinfo command for logs-based approach
     */
    async function sendServerInfoCommand(serverId) {
        return new Promise(async (resolve) => {
            try {
                const server = managedServers.find(s => s.serverId === serverId);
                if (!server) {
                    resolve({ success: false, error: 'Server not found' });
                    return;
                }

                console.log(`üì° Console sending serverinfo command to ${serverId} (logs-integrated)...`);

                // Check if we're in demo mode
                if (isDemo) {
                    console.log('üé≠ Console demo mode: will trigger mock logs response');
                    
                    // In demo mode, just return success and let the system handle mock data
                    setTimeout(() => {
                        resolve({ 
                            success: true, 
                            response: 'Demo mode serverinfo sent',
                            source: 'demo'
                        });
                    }, 1000);
                    return;
                }

                // REAL MODE: Send actual serverinfo command and trigger logs-based update
                try {
                    // Set up console for this server
                    const consoleSelect = document.getElementById('consoleServerSelect');
                    if (consoleSelect) {
                        consoleSelect.value = serverId;
                    }

                    const consoleInput = document.getElementById('consoleInput');
                    if (consoleInput) {
                        const originalCommand = consoleInput.value;
                        consoleInput.value = 'serverinfo';

                        // Send the command using this module's function
                        console.log(`üöÄ Console executing serverinfo command for ${serverId}`);
                        await sendConsoleCommand();

                        // Restore original command
                        consoleInput.value = originalCommand;

                        // Trigger logs-based update instead of parsing console output
                        logsIntegratedTriggerPlayerCountUpdate(serverId);

                        resolve({ 
                            success: true, 
                            response: 'Command sent, logs-based update triggered',
                            source: 'logs_integrated'
                        });

                    } else {
                        console.log('‚ö†Ô∏è Console input not available');
                        resolve({ success: false, error: 'Console input not available' });
                    }

                } catch (error) {
                    console.error(`‚ùå Console error sending serverinfo to ${serverId}:`, error);
                    resolve({ success: false, error: error.message });
                }

            } catch (error) {
                resolve({ success: false, error: error.message });
            }
        });
    }

    /**
     * LOGS-INTEGRATED: Get server region (helper function)
     */
    function getServerRegion(serverId) {
        try {
            if (typeof window.getServerById === 'function') {
                const server = window.getServerById(serverId);
                return server ? server.serverRegion : 'US';
            }
            return 'US';
        } catch (error) {
            console.warn('getServerRegion error:', error);
            return 'US';
        }
    }

    /**
     * LOGS-INTEGRATED: Test function for logs integration
     */
    function testLogsIntegratedConsole(serverId) {
        console.log(`üß™ Testing logs-integrated console for ${serverId}...`);
        
        if (!serverId && managedServers && managedServers.length > 0) {
            serverId = managedServers[0].serverId;
        }
        
        if (!serverId) {
            console.log('‚ùå No server ID provided and no servers available');
            return;
        }
        
        console.log(`üéØ Testing serverinfo command with logs integration...`);
        
        // Test the integrated approach
        sendServerInfoCommand(serverId)
            .then(result => {
                console.log('üìä Test result:', result);
                if (result.success) {
                    console.log(`‚úÖ SUCCESS: Command sent and logs update triggered for ${serverId}`);
                } else {
                    console.log(`‚ùå FAILED: ${result.error}`);
                }
            })
            .catch(error => {
                console.error('‚ùå Test failed:', error);
            });
    }

    // ============================================================================
    // MODULE INITIALIZATION (LOGS-INTEGRATED)
    // ============================================================================
    
    console.log('console module loaded - logs-integrated version (no console parsing)');
    
    // Make functions globally accessible (preserve original behavior + logs-integrated)
    if (typeof window !== 'undefined') {
        // Browser environment - attach to window
        window.displayCombinedConsoleOutput = displayCombinedConsoleOutput;
        window.testLiveConsole = testLiveConsole;
        window.connectToLiveConsole = connectToLiveConsole;
        window.clearConsole = clearConsole;
        window.updateSystemStatus = updateSystemStatus;
        window.setCommand = setCommand;
        window.sendConsoleCommand = sendConsoleCommand;
        window.addCommandOutput = addCommandOutput;
        window.refreshConsole = refreshConsole;
        
        // LOGS-INTEGRATED: Player count functions that work with logs system
        window.logsIntegratedProcessConsoleForPlayerCount = logsIntegratedProcessConsoleForPlayerCount;
        window.logsIntegratedTriggerPlayerCountUpdate = logsIntegratedTriggerPlayerCountUpdate;
        window.sendServerInfoCommand = sendServerInfoCommand;
        window.getServerRegion = getServerRegion;
        window.testLogsIntegratedConsole = testLogsIntegratedConsole;
    }
    
    // Initialize module-specific functionality
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ console module initialized with logs integration (no console parsing)');
        
        // Set up integration with logs system
        setTimeout(() => {
            setupLogsIntegration();
        }, 5000); // Wait 5 seconds for everything to load
    });

    /**
     * LOGS-INTEGRATED: Set up integration with logs system
     */
    function setupLogsIntegration() {
        try {
            console.log('üîó Setting up console-logs integration...');
            
            // Check if logs module is available
            if (typeof window.getPlayerCountFromLogs === 'function') {
                console.log('‚úÖ Logs module detected - integration ready');
            } else {
                console.log('‚ö†Ô∏è Logs module not detected - will use direct API calls');
            }
            
            // Set up console monitoring for automatic triggers
            const consoleOutput = document.getElementById('consoleOutput');
            if (consoleOutput) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            mutation.addedNodes.forEach(function(node) {
                                if (node.nodeType === Node.ELEMENT_NODE && node.textContent) {
                                    const text = node.textContent;
                                    
                                    // Check for serverinfo command success
                                    if (text.includes('serverinfo') && text.includes('‚úÖ')) {
                                        const consoleServerSelect = document.getElementById('consoleServerSelect');
                                        const currentServerId = consoleServerSelect ? consoleServerSelect.value : null;
                                        
                                        if (currentServerId) {
                                            console.log(`üéØ Auto-triggered logs update for ${currentServerId}`);
                                            logsIntegratedTriggerPlayerCountUpdate(currentServerId);
                                        }
                                    }
                                }
                            });
                        }
                    });
                });
                
                observer.observe(consoleOutput, {
                    childList: true,
                    subtree: true
                });
                
                console.log('üë• Console-logs integration observer active');
            }
            
            console.log('‚úÖ Console-logs integration setup complete');
        } catch (error) {
            console.warn('Console-logs integration setup error:', error);
        }
    }
    
    console.log('‚úÖ Logs-integrated console module loaded (triggers logs API instead of parsing)');
    
</script>