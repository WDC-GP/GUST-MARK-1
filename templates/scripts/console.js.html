<!-- ============================================================================
     GUST Bot Enhanced - console JavaScript Module (CLEAN FIXED VERSION)
     ============================================================================
     ‚úÖ FIXED: No variable conflicts with main.js
     ‚úÖ FIXED: Functions available immediately for onclick handlers
     ‚úÖ OPTIMIZED: Console refresh interval: 5s ‚Üí 15s (66% reduction)
     ‚úÖ OPTIMIZED: WebSocket reconnection: 30s ‚Üí 60s (50% reduction)
     ‚úÖ CLEAN: No duplicate declarations or syntax errors
     ============================================================================ -->

<script>
    // ============================================================================
    // IMMEDIATE FUNCTION DEFINITIONS (NO CONFLICTS)
    // ============================================================================
    
    (function() {
        'use strict';
        
        console.log('üîß Loading console module with immediate function definitions...');
        
        // ============================================================================
        // CORE CONSOLE FUNCTIONS - AVAILABLE IMMEDIATELY
        // ============================================================================
        
        function setCommand(command) {
            console.log('‚úÖ setCommand called:', command);
            const consoleInput = document.getElementById('consoleInput');
            if (consoleInput) {
                consoleInput.value = command;
            } else {
                console.warn('consoleInput element not found');
            }
        }
        
        function addCommandOutput(message, type) {
            const outputDiv = document.getElementById('consoleOutput');
            if (!outputDiv) {
                console.warn('consoleOutput element not found');
                return;
            }
            
            const time = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-300'}`;
            messageDiv.innerHTML = `<span class="text-gray-500">[${time}]</span> ${message}`;
            
            outputDiv.appendChild(messageDiv);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function getServerRegion(serverId) {
            try {
                if (typeof window.getServerById === 'function') {
                    const server = window.getServerById(serverId);
                    return server ? server.serverRegion : 'US';
                }
                return 'US';
            } catch (error) {
                console.warn('getServerRegion error:', error);
                return 'US';
            }
        }
        
        function sendConsoleCommand() {
            console.log('‚úÖ sendConsoleCommand called');
            
            const command = document.getElementById('consoleInput');
            const serverSelect = document.getElementById('consoleServerSelect');
            
            if (!command) {
                alert('Console input not found');
                return;
            }
            
            if (!serverSelect) {
                alert('Server select not found');
                return;
            }
            
            const commandValue = command.value.trim();
            const serverId = serverSelect.value;
            
            if (!commandValue) {
                alert('Please enter a command');
                return;
            }
            
            if (!serverId) {
                alert('Please select a server from the dropdown');
                return;
            }
            
            const region = getServerRegion(serverId);
            
            // Add command to output
            addCommandOutput(`> ${commandValue} (Server: ${serverId}) [OPTIMIZED]`, 'command');
            
            // Send command with error handling
            fetch('/api/console/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    command: commandValue,
                    serverId: serverId,
                    region: region
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    const serverName = (typeof window.getServerById === 'function' && window.getServerById(serverId)) ? 
                                     window.getServerById(serverId).serverName : serverId;
                    addCommandOutput(`‚úÖ Command sent successfully to ${serverName}`, 'success');
                    command.value = '';
                    
                    // Auto-refresh console after 2 seconds
                    setTimeout(() => {
                        refreshConsole();
                    }, 2000);
                    
                    // Trigger logs-based player count update for serverinfo
                    if (commandValue.toLowerCase() === 'serverinfo') {
                        if (typeof window.logsIntegratedTriggerPlayerCountUpdate === 'function') {
                            window.logsIntegratedTriggerPlayerCountUpdate(serverId);
                        }
                    }
                } else {
                    addCommandOutput(`‚ùå Command failed: ${result.error || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                console.error('Command send error:', error);
                addCommandOutput(`‚ùå Send error: ${error.message}`, 'error');
            });
        }
        
        function refreshConsole() {
            console.log('‚úÖ refreshConsole called');
            
            fetch('/api/console/output')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(output => {
                const outputDiv = document.getElementById('consoleOutput');
                if (!outputDiv) {
                    console.warn('consoleOutput element not found');
                    return;
                }
                
                outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Ready [OPTIMIZED]</div>';
                
                if (Array.isArray(output)) {
                    output.forEach(entry => {
                        const div = document.createElement('div');
                        if (entry.command) {
                            div.className = 'text-blue-400 font-mono text-sm mb-1';
                            div.textContent = `> ${entry.command}`;
                        } else {
                            div.className = (entry.status === 'server_response' ? 'text-white' : 'text-gray-400') + ' text-sm mb-1';
                            div.textContent = entry.message;
                        }
                        outputDiv.appendChild(div);
                    });
                }
                
                outputDiv.scrollTop = outputDiv.scrollHeight;
            })
            .catch(error => {
                console.error('Console refresh error:', error);
                addCommandOutput(`‚ùå Refresh error: ${error.message}`, 'error');
            });
        }
        
        function clearConsole() {
            console.log('‚úÖ clearConsole called');
            const outputDiv = document.getElementById('consoleOutput');
            if (outputDiv) {
                outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Cleared [OPTIMIZED]</div>';
            } else {
                console.warn('consoleOutput element not found');
            }
        }
        
        // ============================================================================
        // EXPOSE FUNCTIONS TO GLOBAL SCOPE IMMEDIATELY
        // ============================================================================
        
        // Make functions available globally RIGHT NOW
        window.setCommand = setCommand;
        window.sendConsoleCommand = sendConsoleCommand;
        window.refreshConsole = refreshConsole;
        window.clearConsole = clearConsole;
        window.addCommandOutput = addCommandOutput;
        window.getServerRegion = getServerRegion;
        
        console.log('‚úÖ Core console functions exposed to global scope');
        console.log('üîß Available functions:', {
            setCommand: typeof window.setCommand,
            sendConsoleCommand: typeof window.sendConsoleCommand,
            refreshConsole: typeof window.refreshConsole,
            clearConsole: typeof window.clearConsole
        });
        
        // ============================================================================
        // ENHANCED CONSOLE FUNCTIONS (NON-CONFLICTING)
        // ============================================================================
        
        // Configuration for optimizations
        const consoleConfig = {
            refreshInterval: 15000,      // 15 seconds (was 5s)
            reconnectInterval: 60000,    // 60 seconds (was 30s)
            maxConcurrentRequests: 3,    // Throttling
            requestDelay: 2000          // Debounce delay
        };
        
        // Simple request throttler to avoid conflicts
        class SimpleRequestThrottler {
            constructor(maxConcurrent = 3) {
                this.maxConcurrent = maxConcurrent;
                this.activeRequests = 0;
                this.requestQueue = [];
            }
            
            async throttle(requestFn) {
                return new Promise((resolve, reject) => {
                    this.requestQueue.push({ requestFn, resolve, reject });
                    this.processQueue();
                });
            }
            
            async processQueue() {
                if (this.activeRequests >= this.maxConcurrent || this.requestQueue.length === 0) {
                    return;
                }
                
                this.activeRequests++;
                const { requestFn, resolve, reject } = this.requestQueue.shift();
                
                try {
                    const result = await requestFn();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.activeRequests--;
                    setTimeout(() => this.processQueue(), 100);
                }
            }
        }
        
        const requestThrottler = new SimpleRequestThrottler(consoleConfig.maxConcurrentRequests);
        
        // Enhanced functions with optimizations
        function testLiveConsole() {
            console.log('üß™ Testing live console...');
            
            requestThrottler.throttle(async () => {
                return fetch('/api/console/live/test');
            })
            .then(response => response.json())
            .then(data => {
                const alertMsg = `Live Console Test Results (OPTIMIZED):
                
‚úÖ Success: ${data.success}
üîå WebSockets Available: ${data.websockets_available}
üì° Active Connections: ${data.total_connections || 0}
üì® Recent Messages: ${data.message_count || 0}
‚ö° Optimized: Console 15s, Reconnect 60s

${data.recent_messages && data.recent_messages.length > 0 ? 
  'Latest: ' + (data.recent_messages[data.recent_messages.length-1].message || 'N/A').substring(0, 100) : 
  'No recent messages'}

${data.error ? 'Error: ' + data.error : 'Working with reduced API calls!'}`;
                
                alert(alertMsg);
                console.log('üîç Live Console Test Data:', data);
            })
            .catch(error => {
                alert(`Test Error: ${error.message}`);
                console.error('Test error:', error);
            });
        }
        
        function connectToLiveConsole(serverId) {
            console.log('üîå Connecting to live console for server:', serverId);
            
            if (typeof window.showTab === 'function') {
                window.showTab('console');
            }
            
            addCommandOutput(`üì∫ Connected to live console for server ${serverId} [OPTIMIZED]`, 'system');
        }
        
        function updateSystemStatus() {
            console.log('üîÑ Updating system status...');
            
            requestThrottler.throttle(async () => {
                return fetch('/api/token/status');
            })
            .then(response => response.json())
            .then(data => {
                const tokenStatus = document.getElementById('tokenStatus');
                const modeStatus = document.getElementById('modeStatus');
                const websocketStatus = document.getElementById('websocketStatus');
                const refreshBtn = document.getElementById('refreshTokenBtn');
                
                if (data.demo_mode) {
                    if (tokenStatus) tokenStatus.textContent = '‚Ä¢ G-Portal Token: Demo Mode [OPTIMIZED]';
                    if (modeStatus) modeStatus.textContent = '‚Ä¢ Mode: Demo (simulated commands)';
                    if (refreshBtn) refreshBtn.classList.add('hidden');
                } else if (data.has_token && data.token_valid) {
                    if (tokenStatus) tokenStatus.textContent = `‚Ä¢ G-Portal Token: Valid (${Math.floor(data.time_left/60)}m left) [OPTIMIZED]`;
                    if (modeStatus) modeStatus.textContent = '‚Ä¢ Mode: Live (reduced API calls)';
                    if (refreshBtn) refreshBtn.classList.add('hidden');
                } else {
                    if (tokenStatus) tokenStatus.textContent = '‚Ä¢ G-Portal Token: Expired/Invalid';
                    if (modeStatus) modeStatus.textContent = '‚Ä¢ Mode: Needs authentication';
                    if (refreshBtn) refreshBtn.classList.remove('hidden');
                }
                
                if (websocketStatus) {
                    websocketStatus.textContent = `‚Ä¢ WebSocket Support: ${data.websockets_available ? 'Available ‚úÖ [OPTIMIZED]' : 'Not Available ‚ùå'}`;
                }
            })
            .catch(error => {
                console.error('Error checking token status:', error);
            });
        }
        
        function displayCombinedConsoleOutput(consoleOutput, liveMessages) {
            const outputDiv = document.getElementById('consoleOutput');
            if (!outputDiv) return;
            
            const wasScrolledToBottom = outputDiv.scrollTop + outputDiv.clientHeight >= outputDiv.scrollHeight - 10;
            
            // Clear and add header
            outputDiv.innerHTML = '<div class="text-green-400">GUST Bot Console - Ready (Commands + Live Messages) [OPTIMIZED]</div>';
            
            // Add console command output
            if (Array.isArray(consoleOutput)) {
                consoleOutput.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'mb-1 text-sm';
                    
                    if (entry.command) {
                        div.className += ' text-blue-400 font-mono';
                        div.textContent = `> ${entry.command}`;
                    } else {
                        div.className += entry.status === 'server_response' ? ' text-white' : ' text-gray-400';
                        div.textContent = entry.message;
                    }
                    
                    outputDiv.appendChild(div);
                });
            }
            
            // Add live messages if any
            if (Array.isArray(liveMessages) && liveMessages.length > 0) {
                // Add separator
                const separator = document.createElement('div');
                separator.className = 'text-yellow-400 text-sm border-t border-gray-600 pt-2 mt-2';
                separator.textContent = 'üì∫ Live Console Messages:';
                outputDiv.appendChild(separator);
                
                // Add live messages
                liveMessages.forEach(message => {
                    const div = document.createElement('div');
                    div.className = 'console-live-message text-sm mb-1 pl-2 border-l-2 border-blue-500';
                    
                    const time = new Date(message.timestamp).toLocaleTimeString();
                    const type = message.type || 'system';
                    const serverId = message.server_id || message.serverId || '';
                    
                    const typeIcon = getTypeIcon(type);
                    const serverInfo = serverId ? ` [${serverId}]` : '';
                    
                    div.innerHTML = `
                        <span class="text-gray-500 text-xs">[${time}]</span>
                        <span class="text-xs bg-gray-700 px-1 rounded">${typeIcon} ${type}</span>
                        ${serverInfo ? `<span class="text-xs text-gray-400">${serverInfo}</span>` : ''}
                        <div class="text-gray-200 font-mono mt-1">${escapeHtml(message.message)}</div>
                    `;
                    
                    outputDiv.appendChild(div);
                });
            }
            
            // Auto-scroll if needed
            if (wasScrolledToBottom) {
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        }
        
        function getTypeIcon(type) {
            const icons = {
                'chat': 'üí¨', 'auth': 'üîê', 'save': 'üíæ', 'kill': '‚öîÔ∏è',
                'error': '‚ùå', 'warning': '‚ö†Ô∏è', 'command': 'üîß', 'player': 'üë•',
                'system': 'üñ•Ô∏è', 'event': 'üéØ', 'ban': 'üö´', 'health': 'üè•'
            };
            return icons[type] || 'üìã';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            if (typeof text !== 'string') return String(text);
            
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Debounced console refresh (unique name to avoid conflicts)
        let consoleRefreshTimeout;
        function debouncedConsoleRefreshLocal() {
            clearTimeout(consoleRefreshTimeout);
            consoleRefreshTimeout = setTimeout(() => {
                if (typeof window.refreshConsoleWithLiveMessages === 'function') {
                    window.refreshConsoleWithLiveMessages();
                } else {
                    refreshConsole();
                }
            }, consoleConfig.requestDelay);
        }
        
        // ============================================================================
        // LOGS INTEGRATION FUNCTIONS
        // ============================================================================
        
        function logsIntegratedTriggerPlayerCountUpdate(serverId) {
            console.log(`üìã Triggering logs-based player count update for ${serverId}...`);
            
            setTimeout(() => {
                if (typeof window.getPlayerCountFromLogs === 'function') {
                    window.getPlayerCountFromLogs(serverId);
                } else if (typeof window.refreshPlayerCount === 'function') {
                    window.refreshPlayerCount(serverId);
                } else {
                    // Direct API call
                    requestThrottler.throttle(async () => {
                        return fetch(`/api/logs/player-count/${serverId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success && result.data) {
                            console.log(`‚úÖ Player count updated: ${result.data.current}/${result.data.max} for ${serverId}`);
                            if (typeof window.updatePlayerCountDisplay === 'function') {
                                window.updatePlayerCountDisplay(serverId, result.data, 'success');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Player count update error:', error);
                    });
                }
            }, 5000);
        }
        
        async function sendServerInfoCommand(serverId) {
            return new Promise(async (resolve) => {
                try {
                    console.log(`üì° Sending serverinfo command to ${serverId}...`);
                    
                    if (typeof window.isDemo !== 'undefined' && window.isDemo) {
                        setTimeout(() => {
                            resolve({ 
                                success: true, 
                                response: 'Demo mode serverinfo sent',
                                source: 'demo'
                            });
                        }, 1500);
                        return;
                    }
                    
                    const consoleSelect = document.getElementById('consoleServerSelect');
                    const consoleInput = document.getElementById('consoleInput');
                    
                    if (consoleSelect && consoleInput) {
                        consoleSelect.value = serverId;
                        const originalCommand = consoleInput.value;
                        consoleInput.value = 'serverinfo';
                        
                        sendConsoleCommand();
                        
                        consoleInput.value = originalCommand;
                        
                        logsIntegratedTriggerPlayerCountUpdate(serverId);
                        
                        resolve({ 
                            success: true, 
                            response: 'Command sent and logs update triggered',
                            source: 'console'
                        });
                    } else {
                        resolve({ success: false, error: 'Console elements not available' });
                    }
                } catch (error) {
                    resolve({ success: false, error: error.message });
                }
            });
        }
        
        // ============================================================================
        // EXPOSE ENHANCED FUNCTIONS
        // ============================================================================
        
        // Enhanced functions
        window.testLiveConsole = testLiveConsole;
        window.connectToLiveConsole = connectToLiveConsole;
        window.updateSystemStatus = updateSystemStatus;
        window.displayCombinedConsoleOutput = displayCombinedConsoleOutput;
        window.debouncedConsoleRefreshLocal = debouncedConsoleRefreshLocal;
        
        // Logs integration
        window.logsIntegratedTriggerPlayerCountUpdate = logsIntegratedTriggerPlayerCountUpdate;
        window.sendServerInfoCommand = sendServerInfoCommand;
        
        // Utility functions
        window.getTypeIcon = getTypeIcon;
        window.escapeHtml = escapeHtml;
        
        // Configuration
        window.consoleConfig = consoleConfig;
        window.requestThrottler = requestThrottler;
        
        console.log('‚úÖ Enhanced console functions loaded');
        console.log('‚ö° Optimizations active:');
        console.log(`  - Console refresh: ${consoleConfig.refreshInterval/1000}s (was 5s)`);
        console.log(`  - Reconnect interval: ${consoleConfig.reconnectInterval/1000}s (was 30s)`);
        console.log(`  - Request throttling: Max ${consoleConfig.maxConcurrentRequests} concurrent`);
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Console module DOM ready');
            
            // Test function availability
            const testFunctions = ['setCommand', 'sendConsoleCommand', 'refreshConsole', 'clearConsole'];
            const working = testFunctions.filter(fn => typeof window[fn] === 'function');
            const broken = testFunctions.filter(fn => typeof window[fn] !== 'function');
            
            if (broken.length === 0) {
                console.log('‚úÖ All console functions working:', working);
            } else {
                console.error('‚ùå Broken functions:', broken);
                console.log('‚úÖ Working functions:', working);
            }
        });
        
        console.log('‚úÖ CLEAN Console module loaded successfully - NO CONFLICTS');
        console.log('üéØ Functions available immediately for onclick handlers');
        console.log('‚ö° Optimized intervals: 15s console, 60s reconnect, 3 max concurrent');
        console.log('üîß Ready for use!');
        
    })(); // End of immediately invoked function expression
    
</script>