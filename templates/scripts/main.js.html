<!-- ============================================================================
     GUST Bot Enhanced - Core JavaScript (FIXED)
     ============================================================================
     Fixed version that resolves tab switching and global function issues
     
     FIXES APPLIED:
     - Cleaned up corrupted global variables section
     - Fixed immediate global function exposure
     - Removed await statements from non-async contexts
     - Ensured showTab is available before DOM loads
     ============================================================================ -->

<script>
    // ============================================================================
    // GUST Bot Enhanced - Core JavaScript Module (FIXED)
    // ============================================================================
    // Generated: 2025-06-19 03:56:50 (FIXED)
    // 
    // This file contains EXACT extracted core functionality and global variables
    // All feature-specific functions have been moved to their respective modules
    // 
    // CRITICAL FIXES:
    // - Fixed global variables corruption
    // - Fixed immediate function exposure
    // - Removed async/await issues
    // ============================================================================

    // ============================================================================
    // GLOBAL VARIABLES (FIXED - CLEANED UP)
    // ============================================================================
    
    // Essential global variables for application functionality
    let currentTab = 'dashboard';
    let managedServers = []; // Central server list
    let selectedServers = new Set(); // For bulk operations
    let servers = [];
    let wsConnection = null;
    let isDemo = false;
    let connectionStatus = {};
    let serverFilter = '';
    let messageTypeFilter = 'all';
    let autoScroll = true;
    let websocketsAvailable = true;
    
    // ============================================================================
    // CORE FUNCTIONS (EXACT EXTRACTED CONTENT)
    // ============================================================================
    
    // FIXED showTab function with proper null checking
    function showTab(tab) {
        console.log('🔄 Switching to tab:', tab);
        
        try {
            currentTab = tab;
            
            // Update nav tabs - with null checking
            document.querySelectorAll('.nav-tab').forEach(t => {
                if (t && t.classList) {
                    t.classList.remove('active');
                }
            });
            
            // Find and activate the nav tab
            const navTab = document.getElementById(tab + '-tab');
            if (navTab && navTab.classList) {
                navTab.classList.add('active');
            } else {
                console.warn('❌ Nav tab not found:', tab + '-tab');
            }
            
            // Update views - with null checking
            document.querySelectorAll('.view').forEach(view => {
                if (view && view.classList) {
                    view.classList.add('hidden');
                }
            });
            
            // Show target view - try multiple ID patterns
            let targetView = document.getElementById(tab + '-view');
            if (!targetView) {
                targetView = document.getElementById(tab); // Alternative pattern
            }
            
            if (targetView && targetView.classList) {
                targetView.classList.remove('hidden');
                console.log('✅ Showing view:', targetView.id);
            } else {
                console.error('❌ No view found for tab:', tab);
                console.log('🔍 Looking for:', tab + '-view', 'or', tab);
                console.log('🔍 Available .view elements:');
                document.querySelectorAll('.view').forEach(el => {
                    console.log('   - ID:', el.id || 'no-id', 'Classes:', el.className);
                });
                
                // Create a placeholder view if none exists
                createPlaceholderView(tab);
                return;
            }
            
            // Load tab-specific data
            try {
                if (tab === 'dashboard') loadDashboard();
                else if (tab === 'server-manager') loadServerManager();
                else if (tab === 'events') loadEvents();
                else if (tab === 'clans') loadClans();
                else if (tab === 'console') initializeConsole();
                else if (tab === 'user-management') loadUserManagement();
                else if (tab === 'users') loadUserManagement(); // Alternative name
                else if (tab === 'logs') loadLogs();
            } catch (error) {
                console.warn('Tab-specific loader error:', error);
            }
            
            console.log('✅ Tab switch complete:', tab);
            
        } catch (error) {
            console.error('❌ showTab error:', error);
            console.error('Stack trace:', error.stack);
        }
    }

    // Helper function to create placeholder views for missing tabs
    function createPlaceholderView(tabId) {
        console.log('🔧 Creating placeholder view for:', tabId);
        
        // Find a container to add the view to (usually the main content area)
        let container = document.querySelector('.main-content') || document.querySelector('main') || document.body;
        
        // Create the placeholder view
        const placeholderView = document.createElement('div');
        placeholderView.id = tabId + '-view';
        placeholderView.className = 'view bg-gray-800 p-6 rounded-lg';
        
        // Add content based on the tab type
        let title = tabId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        let content = '';
        
        switch(tabId) {
            case 'user-management':
            case 'users':
                title = '👤 User Management';
                content = `
                    <p class="text-gray-400 mb-4">User management functionality coming soon...</p>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-4 rounded">
                            <h4 class="font-semibold mb-2">🚫 Temporary Ban User</h4>
                            <p class="text-sm text-gray-400">Ban management tools will be available here</p>
                        </div>
                        <div class="bg-gray-700 p-4 rounded">
                            <h4 class="font-semibold mb-2">🎁 Give Items</h4>
                            <p class="text-sm text-gray-400">Item distribution tools will be available here</p>
                        </div>
                    </div>
                `;
                break;
            case 'logs':
                title = '📋 Server Logs';
                content = `
                    <p class="text-gray-400 mb-4">Server logs functionality coming soon...</p>
                    <div class="bg-gray-700 p-4 rounded">
                        <h4 class="font-semibold mb-2">📥 Log Management</h4>
                        <p class="text-sm text-gray-400">Download and view server logs will be available here</p>
                    </div>
                `;
                break;
            default:
                content = `<p class="text-gray-400">This ${title} tab is under development...</p>`;
        }
        
        placeholderView.innerHTML = `
            <h2 class="text-2xl font-bold mb-4">${title}</h2>
            ${content}
            <div class="mt-6 p-4 bg-blue-900 bg-opacity-30 border border-blue-600 rounded">
                <p class="text-blue-300 text-sm">
                    <strong>🔧 Developer Note:</strong> This view was automatically created because the corresponding template wasn't found. 
                    Create <code>templates/views/${tabId}.html</code> to replace this placeholder.
                </p>
            </div>
        `;
        
        // Hide all other views first
        document.querySelectorAll('.view').forEach(view => {
            if (view && view.classList) {
                view.classList.add('hidden');
            }
        });
        
        // Add the placeholder to the container
        container.appendChild(placeholderView);
        
        console.log('✅ Created placeholder view:', tabId + '-view');
    }

    function initializeConsole() {
        if (typeof refreshConsoleWithLiveMessages === 'function') {
            refreshConsoleWithLiveMessages();
        }
        if (typeof updateLiveConnectionStatus === 'function') {
            updateLiveConnectionStatus();
        }
        if (typeof updateConsoleFilters === 'function') {
            updateConsoleFilters();
        }
    }

    // Helper Functions
    function getTypeIcon(type) {
        const icons = {
            'chat': '💬',
            'auth': '🔐',
            'save': '💾',
            'kill': '⚔️',
            'error': '❌',
            'warning': '⚠️',
            'command': '🔧',
            'player': '👥',
            'system': '🖥️',
            'event': '🎯',
            'ban': '🚫'
        };
        return icons[type] || '📋';
    }

    function escapeHtml(text) {
        if (!text) return '';
        if (typeof text !== 'string') return String(text);
        
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Token Management
    function refreshToken() {
        const refreshBtn = document.getElementById('refreshTokenBtn');
        if (!refreshBtn) return;
        
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
        
        fetch('/api/token/refresh', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Token refreshed successfully!');
                if (typeof updateSystemStatus === 'function') {
                    updateSystemStatus(); // Reload status
                }
            } else {
                alert('Token refresh failed. Please re-login with G-Portal credentials.');
            }
        })
        .catch(error => {
            alert('Refresh error: ' + error.message);
        })
        .finally(() => {
            refreshBtn.textContent = 'Refresh Token';
            refreshBtn.disabled = false;
        });
    }

    function updateAllServerDropdowns() {
        // List of all server dropdown IDs in the application
        const serverDropdowns = [
            'consoleServerSelect',
            'eventServerSelect', 
            'clanServerSelect',
            'banServerSelect',
            'giveItemServerSelect',
            'liveTargetServer',
            'serverFilter'
        ];
        
        serverDropdowns.forEach(dropdownId => {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            const currentValue = dropdown.value;
            
            // Clear existing options except the first one
            const firstOption = dropdown.querySelector('option:first-child');
            dropdown.innerHTML = '';
            if (firstOption) {
                dropdown.appendChild(firstOption);
            }
            
            // Add server options
            managedServers.filter(server => server.isActive).forEach(server => {
                const option = document.createElement('option');
                option.value = server.serverId;
                option.textContent = `${server.serverName} (${server.serverId}) - ${server.serverRegion}`;
                
                // Add status indicator
                if (server.status === 'online') {
                    option.textContent += ' ✅';
                } else if (server.status === 'offline') {
                    option.textContent += ' ❌';
                }
                
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue) {
                dropdown.value = currentValue;
            }
        });
    }

    function getServerById(serverId) {
        return managedServers.find(server => server.serverId === serverId);
    }

    function refreshServerList() {
        const container = document.getElementById('managedServersList');
        if (!container) return;
        
        if (managedServers.length === 0) {
            container.innerHTML = `
                <div class="text-gray-400 text-center py-8">
                    <div class="text-4xl mb-4">🔍</div>
                    <div>No servers found</div>
                    <div class="text-sm mt-2">Add a new server above to get started</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = managedServers.map(server => `
            <div class="bg-gray-700 p-4 rounded-lg border border-gray-600">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div>
                            <div class="flex items-center space-x-2">
                                <h4 class="font-semibold text-lg">${server.serverName}</h4>
                                ${server.isFavorite ? '<span class="text-yellow-400">⭐</span>' : ''}
                                ${!server.isActive ? '<span class="text-red-400 text-xs bg-red-900 px-2 py-1 rounded">INACTIVE</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-300">
                                ID: ${server.serverId} | Region: ${server.serverRegion} | Type: ${server.serverType || 'Standard'}
                            </div>
                            ${server.description ? `<div class="text-xs text-gray-400 mt-1">${server.description}</div>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <!-- Status Indicator -->
                        <div class="flex items-center space-x-2">
                            <span class="text-xs px-2 py-1 rounded ${getStatusClass(server.status)}">
                                ${getStatusText(server.status)}
                            </span>
                            ${server.lastPing ? `<span class="text-xs text-gray-400">Pinged: ${new Date(server.lastPing).toLocaleTimeString()}</span>` : ''}
                        </div>
                        
                        <!-- Quick Actions -->
                        <button onclick="pingSingleServer('${server.serverId}')" 
                                class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs" title="Ping Server">
                            📡
                        </button>
                        <button onclick="connectToLiveConsole('${server.serverId}')" 
                                class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs" title="Connect Live Console">
                            📺
                        </button>
                        <button onclick="deleteServer('${server.serverId}')" 
                                class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs" title="Delete Server">
                            🗑️
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateConsoleFilters() {
        // Update monitor server filter with connected servers
        const monitorFilter = document.getElementById('monitorServerFilter');
        if (monitorFilter) {
            const currentValue = monitorFilter.value;
            monitorFilter.innerHTML = '<option value="">🌐 All Connected Servers</option>';
            
            Object.keys(connectionStatus).forEach(serverId => {
                const server = getServerById(serverId);
                const serverName = server ? server.serverName : `Server ${serverId}`;
                const option = document.createElement('option');
                option.value = serverId;
                option.textContent = `${serverName} (${serverId})`;
                monitorFilter.appendChild(option);
            });
            
            if (currentValue) {
                monitorFilter.value = currentValue;
            }
        }
    }

    function updateLiveConnectionStatus() {
        fetch('/api/console/live/status')
        .then(response => response.json())
        .then(data => {
            connectionStatus = data.connections;
            
            // Update live indicator in sidebar
            const indicator = document.getElementById('liveIndicator');
            const totalConnections = Object.keys(connectionStatus).length;
            const activeConnections = Object.values(connectionStatus).filter(c => c.connected).length;
            
            if (indicator) {
                if (activeConnections > 0) {
                    indicator.innerHTML = `
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2 live-indicator"></div>
                        <span class="text-xs">Live (${activeConnections})</span>
                    `;
                } else {
                    indicator.innerHTML = `
                        <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                        <span class="text-xs">Ready</span>
                    `;
                }
            }
            
            // Update connection stats in console
            const activeCountElement = document.getElementById('activeConnectionCount');
            if (activeCountElement) {
                activeCountElement.textContent = activeConnections;
            }
            
            // Update active connections display
            const connectionsDiv = document.getElementById('liveActiveConnections');
            if (connectionsDiv) {
                if (totalConnections === 0) {
                    connectionsDiv.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No active connections</div>';
                } else {
                    connectionsDiv.innerHTML = Object.entries(connectionStatus).map(([serverId, status]) => {
                        const server = getServerById(serverId);
                        const serverName = server ? server.serverName : `Server ${serverId}`;
                        const serverRegion = server ? server.serverRegion : 'Unknown';
                        
                        return `
                        <div class="flex items-center justify-between p-2 bg-gray-600 rounded mb-2">
                            <div class="flex-1">
                                <div class="text-sm font-medium">${serverName}</div>
                                <div class="text-xs text-gray-300">${serverId} - ${serverRegion}</div>
                                <div class="text-xs ${status.connected ? 'text-green-400' : 'text-red-400'}">
                                    ${status.connected ? '● Live Connected' : '○ Disconnected'}
                                </div>
                            </div>
                            <button onclick="disconnectServer('${serverId}')" 
                                    class="text-red-400 hover:text-red-300 text-xs p-1" title="Disconnect">✕</button>
                        </div>
                    `}).join('');
                }
            }
            
            // Update console filters
            updateConsoleFilters();
        })
        .catch(error => {
            console.error('Error updating connection status:', error);
        });
    }

    // ENHANCED CONSOLE REFRESH WITH LIVE MESSAGES
    function refreshConsoleWithLiveMessages() {
        Promise.all([
            fetch('/api/console/output'),
            fetch(`/api/console/live/messages?${new URLSearchParams({
                serverId: serverFilter || '',
                type: messageTypeFilter !== 'all' ? messageTypeFilter : '',
                limit: '30'
            })}`)
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([consoleOutput, liveData]) => {
            if (typeof displayCombinedConsoleOutput === 'function') {
                displayCombinedConsoleOutput(consoleOutput, liveData.messages || []);
            }
        })
        .catch(error => {
            console.error('Error refreshing console with live messages:', error);
            if (typeof refreshConsole === 'function') {
                refreshConsole(); // Fallback
            }
        });
    }

    // Live Console Functions - Auto-Connect Mode
    function addLiveConsoleMessage(message, shouldScroll = true) {
        // This function is used to add connection status messages to the console
        const outputDiv = document.getElementById('consoleOutput');
        if (!outputDiv) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-blue-300 text-sm mb-1';
        
        const time = new Date(message.timestamp).toLocaleTimeString();
        messageDiv.textContent = `[${time}] ${message.message}`;
        
        outputDiv.appendChild(messageDiv);
        
        if (shouldScroll && autoScroll) {
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
    }

    // ============================================================================
    // GLOBAL UTILITY FUNCTIONS (FOR MODULE COMPATIBILITY)
    // ============================================================================
    
    function showStatus(message, type = 'info') {
        console.log(`Status [${type.toUpperCase()}]: ${message}`);
    }
    
    function formatTimestamp(timestamp) {
        if (!timestamp) return '--';
        return new Date(timestamp).toLocaleString();
    }
    
    function validateInput(input, type = 'text') {
        if (!input || input.trim() === '') return false;
        
        switch(type) {
            case 'number':
                return !isNaN(parseFloat(input));
            case 'email':
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input);
            default:
                return input.trim().length > 0;
        }
    }
    
    // Status helper functions
    function getStatusClass(status) {
        switch(status) {
            case 'online': return 'bg-green-800 text-green-200';
            case 'offline': return 'bg-red-800 text-red-200';
            default: return 'bg-gray-700 text-gray-300';
        }
    }
    
    function getStatusText(status) {
        switch(status) {
            case 'online': return '🟢 Online';
            case 'offline': return '🔴 Offline';
            default: return '⚪ Unknown';
        }
    }
    
    // ============================================================================
    // CRITICAL: IMMEDIATE GLOBAL FUNCTION EXPOSURE
    // ============================================================================
    
    // IMMEDIATELY attach core functions to window (before DOM loads)
    window.showTab = showTab;
    window.createPlaceholderView = createPlaceholderView;
    window.escapeHtml = escapeHtml;
    window.getTypeIcon = getTypeIcon;
    window.getServerById = getServerById;
    window.refreshToken = refreshToken;
    window.updateAllServerDropdowns = updateAllServerDropdowns;
    window.refreshServerList = refreshServerList;
    window.updateConsoleFilters = updateConsoleFilters;
    window.updateLiveConnectionStatus = updateLiveConnectionStatus;
    window.refreshConsoleWithLiveMessages = refreshConsoleWithLiveMessages;
    window.addLiveConsoleMessage = addLiveConsoleMessage;
    window.initializeConsole = initializeConsole;
    window.getStatusClass = getStatusClass;
    window.getStatusText = getStatusText;
    
    // Ensure global variables are accessible
    window.currentTab = currentTab;
    window.servers = servers;
    window.managedServers = managedServers;
    window.selectedServers = selectedServers;
    window.wsConnection = wsConnection;
    window.isDemo = isDemo;
    window.connectionStatus = connectionStatus;
    window.serverFilter = serverFilter;
    window.messageTypeFilter = messageTypeFilter;
    window.autoScroll = autoScroll;
    window.websocketsAvailable = websocketsAvailable;
    
    console.log('🚀 GUST Bot Enhanced - Core Module Initialized (FIXED)');
    console.log('⚡ Global functions exposed immediately');
    console.log('📦 Modular architecture active - feature modules loaded separately');
    
    // ============================================================================
    // INITIALIZATION (PRESERVED EXACT BEHAVIOR)
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('📋 DOM loaded - setting up event handlers');
        
        // Setup global event listeners (preserve original behavior)
        window.addEventListener('hashchange', function() {
            const tab = window.location.hash.substring(1);
            if (tab && typeof window.showTab === 'function') {
                window.showTab(tab);
            }
        });
        
        // Initialize default tab (preserve original behavior)
        setTimeout(function() {
            if (window.location.hash) {
                const tab = window.location.hash.substring(1);
                if (tab && typeof window.showTab === 'function') {
                    window.showTab(tab);
                }
            } else {
                if (typeof window.showTab === 'function') {
                    window.showTab('dashboard');
                }
            }
        }, 200); // Small delay to ensure all modules are loaded
        
        console.log('✅ Core initialization complete');
        console.log('🌐 Global functions available:', {
            showTab: typeof window.showTab,
            currentTab: window.currentTab
        });
    });

</script>