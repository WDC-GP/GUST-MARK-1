<!-- ============================================================================
     GUST Bot Enhanced - Server Health JavaScript Module (FIXED + CONTEXT-AWARE)
     ============================================================================
     ‚úÖ FIXED: Added context-aware DOM element management
     ‚úÖ FIXED: Dynamic player count element creation for selected servers
     ‚úÖ FIXED: Integration with existing player count system
     ‚úÖ FIXED: Proper server selection handling
     ============================================================================ -->

<script>
    // ============================================================================
    // SERVER HEALTH MODULE - CONTEXT-AWARE VERSION
    // ============================================================================
    
    // Global variables for Server Health
    let serverHealthData = {
        currentServer: null,
        charts: {},
        commandFeed: [],
        healthStatus: {},
        autoRefresh: true,
        refreshInterval: null,
        isActive: false,
        filters: { active: 'all' },
        refreshCountdown: 30,
        selectedServerData: null // Track selected server data
    };
    
    // ============================================================================
    // MAIN LOAD FUNCTION - Called by showTab()
    // ============================================================================
    
    function loadServerHealth() {
        console.log('üè• Loading Server Health tab...');
        
        try {
            serverHealthData.isActive = true;
            
            initializeServerHealth();
            loadCurrentServer();
            loadHealthStatus();
            loadHealthCharts();
            loadCommandFeed();
            loadTrendsData();
            
            startAutoRefresh();
            
            console.log('‚úÖ Server Health loaded successfully');
            
        } catch (error) {
            console.error('‚ùå Error loading Server Health:', error);
            showHealthError('Failed to load Server Health: ' + error.message);
        }
    }
    
    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    
    function initializeServerHealth() {
        console.log('üîß Initializing Server Health system...');
        
        setupServerSelector();
        setupCommandFilters();
        
        const refreshBtn = document.getElementById('refresh-health-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', refreshHealthData);
        }
        
        if (typeof Chart !== 'undefined') {
            initializeHealthCharts();
        } else {
            console.warn('‚ö†Ô∏è Chart.js not available - charts will not be displayed');
            showChartsUnavailable();
        }
        
        console.log('‚úÖ Server Health initialization complete');
    }
    
    function setupServerSelector() {
        const serverSelect = document.getElementById('server-health-selector');
        if (!serverSelect) {
            console.warn('‚ö†Ô∏è Health server selector not found');
            return;
        }
        
        serverSelect.innerHTML = '<option value="">Loading servers...</option>';
        
        function populateServers() {
            console.log('üîç Server Health: Attempting to populate server selector...');
            
            if (typeof managedServers !== 'undefined' && managedServers && managedServers.length > 0) {
                console.log(`‚úÖ Server Health: Found ${managedServers.length} managed servers`);
                
                serverSelect.innerHTML = '<option value="">Select a server...</option>';
                
                managedServers.forEach(server => {
                    if (server.isActive) {
                        const option = document.createElement('option');
                        option.value = server.serverId;
                        option.textContent = `${server.serverName} (${server.serverId})`;
                        serverSelect.appendChild(option);
                    }
                });
                
                const activeServers = managedServers.filter(s => s.isActive);
                if (activeServers.length > 0) {
                    const firstServer = activeServers[0];
                    serverSelect.value = firstServer.serverId;
                    serverHealthData.currentServer = firstServer.serverId;
                    serverHealthData.selectedServerData = firstServer;
                    console.log(`üéØ Server Health: Auto-selected server: ${firstServer.serverName} (${firstServer.serverId})`);
                    
                    // ‚úÖ FIXED: Create player count elements for selected server
                    createPlayerCountElementsForSelectedServer(firstServer);
                    
                    setTimeout(() => {
                        refreshHealthData();
                    }, 1000);
                }
                
                return true;
            }
            
            console.log('‚è≥ Server Health: managedServers not ready yet...');
            return false;
        }
        
        if (populateServers()) {
            console.log('‚úÖ Server Health: Servers populated immediately');
        } else {
            console.log('‚è≥ Server Health: Servers not ready, setting up watchers...');
            
            let attempts = 0;
            const maxAttempts = 20;
            
            const serverWatcher = setInterval(() => {
                attempts++;
                console.log(`üîç Server Health: Attempt ${attempts}/${maxAttempts}: Checking for servers...`);
                
                if (populateServers()) {
                    console.log('‚úÖ Server Health: Servers found and populated!');
                    clearInterval(serverWatcher);
                } else if (attempts >= maxAttempts) {
                    console.warn('‚ö†Ô∏è Server Health: Timeout waiting for servers');
                    serverSelect.innerHTML = '<option value="">No servers found - Try refreshing</option>';
                    clearInterval(serverWatcher);
                    showNoServersMessage();
                }
            }, 500);
            
            if (typeof loadManagedServers === 'function') {
                console.log('üöÄ Server Health: Calling loadManagedServers directly...');
                try {
                    const result = loadManagedServers();
                    if (result && typeof result.then === 'function') {
                        result.then(() => {
                            console.log('‚úÖ Server Health: Direct server loading completed');
                            setTimeout(() => {
                                if (populateServers()) {
                                    clearInterval(serverWatcher);
                                }
                            }, 1000);
                        }).catch(error => {
                            console.error('‚ùå Server Health: Error in direct server loading:', error);
                        });
                    } else {
                        setTimeout(() => {
                            if (populateServers()) {
                                clearInterval(serverWatcher);
                            }
                        }, 1000);
                    }
                } catch (error) {
                    console.error('‚ùå Server Health: Error calling loadManagedServers:', error);
                }
            }
        }
        
        // Add change event listener
        serverSelect.addEventListener('change', onServerChange);
    }
    
    // ‚úÖ FIXED: Create dynamic player count elements for selected server
    function createPlayerCountElementsForSelectedServer(server) {
        console.log(`üéØ Creating player count elements for server: ${server.serverName} (${server.serverId})`);
        
        // Show the player count display section
        const playerDisplay = document.getElementById('selected-server-player-count');
        const noServerMessage = document.getElementById('no-server-selected-message');
        
        if (playerDisplay) {
            playerDisplay.classList.remove('hidden');
        }
        if (noServerMessage) {
            noServerMessage.classList.add('hidden');
        }
        
        // Create dynamic DOM elements that match the expected pattern
        const serverId = server.serverId;
        
        // ‚úÖ FIXED: Create the missing DOM elements dynamically
        createDynamicPlayerCountElements(serverId);
        
        // Update the visible display
        updateServerHealthPlayerDisplay(server);
        
        // Initialize player count for this server
        if (typeof window.refreshPlayerCount === 'function') {
            setTimeout(() => {
                window.refreshPlayerCount(serverId);
            }, 2000);
        }
    }
    
    // ‚úÖ FIXED: Create dynamic DOM elements for player count compatibility
    function createDynamicPlayerCountElements(serverId) {
        // Remove any existing dynamic elements first
        removeDynamicPlayerCountElements();
        
        // Create the expected DOM elements
        const hiddenContainer = document.getElementById('server-health-hidden-elements');
        if (!hiddenContainer) {
            console.warn('‚ö†Ô∏è Hidden elements container not found');
            return;
        }
        
        // Create elements with the expected IDs
        const statusElement = document.createElement('span');
        statusElement.id = `player-status-${serverId}`;
        statusElement.className = 'player-count-status text-xs px-2 py-1 rounded bg-gray-700 text-yellow-400';
        statusElement.textContent = '‚è≥ Loading...';
        
        const barElement = document.createElement('div');
        barElement.id = `player-bar-${serverId}`;
        barElement.className = 'player-count-fill bg-gradient-to-r from-green-400 to-cyan-400 rounded-full h-full transition-all duration-500';
        barElement.style.width = '0%';
        
        const sourceElement = document.createElement('span');
        sourceElement.id = `player-source-${serverId}`;
        sourceElement.textContent = 'Server Health';
        
        // Add to hidden container
        hiddenContainer.appendChild(statusElement);
        hiddenContainer.appendChild(barElement);
        hiddenContainer.appendChild(sourceElement);
        
        // Store reference for cleanup
        hiddenContainer.setAttribute('data-current-server', serverId);
        
        console.log(`‚úÖ Created dynamic player count elements for ${serverId}`);
    }
    
    // ‚úÖ FIXED: Remove dynamic DOM elements when switching servers
    function removeDynamicPlayerCountElements() {
        const hiddenContainer = document.getElementById('server-health-hidden-elements');
        if (!hiddenContainer) return;
        
        const currentServerId = hiddenContainer.getAttribute('data-current-server');
        if (currentServerId) {
            // Remove the dynamic elements
            const statusElement = document.getElementById(`player-status-${currentServerId}`);
            const barElement = document.getElementById(`player-bar-${currentServerId}`);
            const sourceElement = document.getElementById(`player-source-${currentServerId}`);
            
            if (statusElement) statusElement.remove();
            if (barElement) barElement.remove();
            if (sourceElement) sourceElement.remove();
            
            hiddenContainer.removeAttribute('data-current-server');
        }
    }
    
    // ‚úÖ FIXED: Update the visible player display in Server Health context
    function updateServerHealthPlayerDisplay(server) {
        const currentElement = document.getElementById('health-player-current');
        const maxElement = document.getElementById('health-player-max');
        const statusElement = document.getElementById('health-player-status');
        const barElement = document.getElementById('health-player-bar');
        const sourceElement = document.getElementById('health-player-source');
        
        if (currentElement) currentElement.textContent = '--';
        if (maxElement) maxElement.textContent = '--';
        if (statusElement) {
            statusElement.textContent = '‚è≥ Loading...';
            statusElement.className = 'player-count-status text-xs px-2 py-1 rounded bg-yellow-900 text-yellow-300';
        }
        if (barElement) barElement.style.width = '0%';
        if (sourceElement) sourceElement.textContent = 'Server Health Monitor';
    }
    
    function setupCommandFilters() {
        const filterButtons = [
            { id: 'filter-all-btn', type: 'all' },
            { id: 'filter-admin-btn', type: 'admin' },
            { id: 'filter-ingame-btn', type: 'ingame' },
            { id: 'filter-auto-btn', type: 'auto' }
        ];
        
        filterButtons.forEach(btn => {
            const element = document.getElementById(btn.id);
            if (element) {
                element.addEventListener('click', () => filterCommands(btn.type));
            }
        });
        
        updateFilterButtons();
    }
    
    // ============================================================================
    // SERVER SELECTION
    // ============================================================================
    
    function loadCurrentServer() {
        const serverSelect = document.getElementById('server-health-selector');
        if (serverSelect && serverSelect.value) {
            serverHealthData.currentServer = serverSelect.value;
            console.log(`üéØ Current server set to: ${serverHealthData.currentServer}`);
        } else {
            console.warn('‚ö†Ô∏è No server selected for health monitoring');
        }
    }
    
    function onServerChange(event) {
        const newServerId = event.target.value;
        
        if (!newServerId) {
            console.log('‚ùå No server selected');
            
            // Hide player count display
            const playerDisplay = document.getElementById('selected-server-player-count');
            const noServerMessage = document.getElementById('no-server-selected-message');
            
            if (playerDisplay) playerDisplay.classList.add('hidden');
            if (noServerMessage) noServerMessage.classList.remove('hidden');
            
            // Remove dynamic elements
            removeDynamicPlayerCountElements();
            
            serverHealthData.currentServer = null;
            serverHealthData.selectedServerData = null;
            return;
        }
        
        console.log(`üîÑ Switching server health to: ${newServerId}`);
        
        // Find the server data
        const server = managedServers.find(s => s.serverId === newServerId);
        if (server) {
            serverHealthData.currentServer = newServerId;
            serverHealthData.selectedServerData = server;
            
            // ‚úÖ FIXED: Create player count elements for new server
            createPlayerCountElementsForSelectedServer(server);
            
            // Reload all data for new server
            refreshHealthData();
        }
    }
    
    // ============================================================================
    // ENHANCED UPDATE PLAYER COUNT DISPLAY (SERVER HEALTH CONTEXT)
    // ============================================================================
    
    // ‚úÖ FIXED: Custom update function for Server Health context
    function updateServerHealthPlayerCount(serverId, playerData, status) {
        console.log(`üè• Updating Server Health player count for ${serverId}:`, playerData, status);
        
        // Only update if this is the currently selected server
        if (serverHealthData.currentServer !== serverId) {
            console.log(`üè• Ignoring update for ${serverId} - not currently selected server`);
            return;
        }
        
        // Update the visible display elements
        const currentElement = document.getElementById('health-player-current');
        const maxElement = document.getElementById('health-player-max');
        const statusElement = document.getElementById('health-player-status');
        const barElement = document.getElementById('health-player-bar');
        const sourceElement = document.getElementById('health-player-source');
        
        // Update status first
        if (statusElement) {
            statusElement.className = 'player-count-status text-xs px-2 py-1 rounded';
            switch (status) {
                case 'loading':
                    statusElement.textContent = '‚è≥ Loading...';
                    statusElement.className += ' bg-yellow-900 text-yellow-300';
                    break;
                case 'success':
                    statusElement.textContent = `‚úÖ ${new Date().toLocaleTimeString()}`;
                    statusElement.className += ' bg-green-900 text-green-300';
                    break;
                case 'error':
                    statusElement.textContent = '‚ùå Error';
                    statusElement.className += ' bg-red-900 text-red-300';
                    break;
            }
        }
        
        // Update values if we have new data
        if (playerData && currentElement && maxElement) {
            currentElement.textContent = playerData.current;
            maxElement.textContent = playerData.max;
            
            if (barElement) {
                barElement.style.width = `${playerData.percentage}%`;
                
                barElement.className = 'player-count-fill bg-gradient-to-r rounded-full h-full transition-all duration-500';
                if (playerData.percentage >= 90) {
                    barElement.className += ' from-red-500 to-red-600';
                } else if (playerData.percentage >= 75) {
                    barElement.className += ' from-orange-500 to-red-500';
                } else if (playerData.percentage >= 50) {
                    barElement.className += ' from-yellow-500 to-orange-500';
                } else {
                    barElement.className += ' from-green-400 to-cyan-400';
                }
            }
            
            if (sourceElement) {
                sourceElement.textContent = playerData.source === 'server_logs' ? 'Server Logs' : 
                                           playerData.source === 'demo_data' ? 'Demo Data' : 
                                           'Server Health Monitor';
            }
            
            console.log(`‚úÖ Server Health display updated: ${playerData.current}/${playerData.max} (${playerData.percentage}%)`);
        }
    }
    
    // ============================================================================
    // HEALTH STATUS CARDS
    // ============================================================================
    
    async function loadHealthStatus() {
        if (!serverHealthData.currentServer) {
            console.warn('‚ö†Ô∏è No server selected for health status');
            showSelectServerMessage();
            return;
        }
        
        try {
            console.log(`üìä Loading health status for server ${serverHealthData.currentServer}...`);
            
            updateHealthStatusDisplay({
                overall_status: 'loading',
                health_data: {
                    metrics: {
                        response_time: '--',
                        memory_usage: '--',
                        cpu_usage: '--',
                        player_count: '--'
                    }
                }
            });
            
            const response = await fetch(`/api/server_health/status/${serverHealthData.currentServer}`);
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Health status loaded:', result.status);
                serverHealthData.healthStatus = result;
                updateHealthStatusDisplay(result);
            } else {
                console.error('‚ùå Health status error:', result.error);
                showHealthError(result.error);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading health status:', error);
            showHealthError('Failed to load health status - using demo data');
            showDemoHealthData();
        }
    }
    
    function updateHealthStatusDisplay(data) {
        const statusElement = document.getElementById('health-status-text');
        const lastCheckElement = document.getElementById('last-health-check');
        const progressBar = document.getElementById('health-progress-bar');
        
        if (statusElement) {
            const status = data.overall_status || 'unknown';
            statusElement.textContent = `System ${status}`;
            statusElement.className = `font-semibold text-${getStatusColor(status)}-400`;
        }
        
        if (lastCheckElement) {
            const lastCheck = new Date().toLocaleTimeString();
            lastCheckElement.textContent = `Last check: ${lastCheck}`;
        }
        
        if (progressBar) {
            const percentage = data.health_data?.health_percentage || 75;
            progressBar.style.width = `${percentage}%`;
            progressBar.className = `h-2 rounded-full transition-all duration-500 ${getHealthBarColor(data.overall_status)}`;
        }
        
        const metrics = data.health_data?.metrics || {};
        updateMetricDisplay('response-time', metrics.response_time, 'ms');
        updateMetricDisplay('memory-usage', metrics.memory_usage, 'MB');
        updateMetricDisplay('cpu-usage', metrics.cpu_usage, '%');
        updateMetricDisplay('player-count', metrics.player_count, '');
    }
    
    function updateMetricDisplay(metricId, value, suffix) {
        const element = document.getElementById(`${metricId}-current`);
        if (element) {
            const displayValue = value !== undefined ? `${value}${suffix}` : '--';
            element.textContent = displayValue;
        }
    }
    
    // ============================================================================
    // TRENDS DATA LOADING
    // ============================================================================

    async function loadTrendsData() {
        if (!serverHealthData.currentServer) {
            console.warn('‚ö†Ô∏è No server selected for trends data');
            return;
        }
        
        try {
            console.log(`üìä Loading trends data for server ${serverHealthData.currentServer}...`);
            
            const response = await fetch(`/api/server_health/trends/${serverHealthData.currentServer}`);
            const result = await response.json();
            
            if (result.success && result.trends) {
                console.log('‚úÖ Trends data loaded successfully');
                updateTrendsDisplay(result.trends);
            } else {
                console.warn('‚ö†Ô∏è Trends API returned no data:', result);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading trends data:', error);
        }
    }

    function updateTrendsDisplay(trends) {
        console.log('üìä Updating trends display with data:', trends);
        
        const responseEl = document.getElementById('trends-response-current');
        if (responseEl && trends.response_time) {
            responseEl.textContent = `${trends.response_time.current}ms`;
            console.log('‚úÖ Updated response time trends:', trends.response_time.current);
        }
        
        const memoryEl = document.getElementById('trends-memory-current');
        if (memoryEl && trends.memory_usage) {
            memoryEl.textContent = `${trends.memory_usage.current}MB`;
            console.log('‚úÖ Updated memory trends:', trends.memory_usage.current);
        }
        
        const cpuEl = document.getElementById('trends-cpu-current');
        if (cpuEl) {
            if (trends.fps && trends.fps.current > 0) {
                const cpuUsage = Math.max(5, 100 - trends.fps.current);
                cpuEl.textContent = `${Math.round(cpuUsage)}%`;
                console.log('‚úÖ Updated CPU trends (from FPS):', Math.round(cpuUsage));
            } else if (trends.memory_usage && trends.memory_usage.current > 0) {
                const cpuUsage = Math.min(95, Math.max(5, trends.memory_usage.current / 50));
                cpuEl.textContent = `${Math.round(cpuUsage)}%`;
                console.log('‚úÖ Updated CPU trends (from memory):', Math.round(cpuUsage));
            } else {
                cpuEl.textContent = '25%';
                console.log('‚úÖ Updated CPU trends (fallback)');
            }
        }
        
        const playersEl = document.getElementById('trends-players-current');
        if (playersEl && trends.player_count !== undefined) {
            playersEl.textContent = `${trends.player_count.current}`;
            console.log('‚úÖ Updated player trends:', trends.player_count.current);
        }
        
        console.log('‚úÖ All trends updated successfully');
    }
    
    // ============================================================================
    // CHARTS INTEGRATION (PRESERVED)
    // ============================================================================
    
    function initializeHealthCharts() {
        console.log('üìä Initializing health charts...');
        
        if (typeof Chart === 'undefined') {
            console.warn('‚ö†Ô∏è Chart.js not available');
            return;
        }
        
        destroyExistingCharts();
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#e5e7eb'
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#374151' }
                },
                y: {
                    beginAtZero: true,
                    ticks: { color: '#9ca3af' },
                    grid: { color: '#374151' }
                }
            }
        };
        
        const fpsCanvas = document.getElementById('fps-chart');
        if (fpsCanvas) {
            try {
                serverHealthData.charts.fps = new Chart(fpsCanvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'FPS',
                            data: [],
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: chartOptions
                });
                console.log('‚úÖ FPS chart created');
            } catch (error) {
                console.error('‚ùå Error creating FPS chart:', error);
            }
        }
        
        const playersCanvas = document.getElementById('players-chart');
        if (playersCanvas) {
            try {
                serverHealthData.charts.players = new Chart(playersCanvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Players',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: chartOptions
                });
                console.log('‚úÖ Players chart created');
            } catch (error) {
                console.error('‚ùå Error creating Players chart:', error);
            }
        }
        
        console.log('‚úÖ Health charts initialized');
    }
    
    function destroyExistingCharts() {
        console.log('üßπ Destroying existing charts...');
        
        Object.keys(serverHealthData.charts).forEach(chartKey => {
            const chart = serverHealthData.charts[chartKey];
            if (chart && typeof chart.destroy === 'function') {
                try {
                    chart.destroy();
                    console.log(`‚úÖ Destroyed ${chartKey} chart`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Error destroying ${chartKey} chart:`, error);
                }
            }
        });
        
        serverHealthData.charts = {};
        
        const canvasElements = ['fps-chart', 'players-chart'];
        canvasElements.forEach(canvasId => {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    try {
                        existingChart.destroy();
                        console.log(`‚úÖ Destroyed orphaned chart on ${canvasId}`);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error destroying orphaned chart on ${canvasId}:`, error);
                    }
                }
            }
        });
    }
    
    async function loadHealthCharts() {
        if (!serverHealthData.currentServer) {
            console.warn('‚ö†Ô∏è No server selected for charts');
            return;
        }
        
        if (typeof Chart === 'undefined') {
            showChartsUnavailable();
            return;
        }
        
        try {
            console.log(`üìà Loading chart data for server ${serverHealthData.currentServer}...`);
            
            const response = await fetch(`/api/server_health/charts/${serverHealthData.currentServer}?hours=6`);
            const result = await response.json();
            
            if (result.success) {
                updateCharts(result.chart_data);
                console.log('‚úÖ Charts updated successfully');
            } else {
                console.error('‚ùå Chart data error:', result.error);
                showDemoChartData();
            }
            
        } catch (error) {
            console.error('‚ùå Error loading charts:', error);
            showDemoChartData();
        }
    }
    
    function updateCharts(chartData) {
        if (serverHealthData.charts.fps && chartData.fps_chart) {
            const fpsChart = serverHealthData.charts.fps;
            fpsChart.data.labels = chartData.fps_chart.labels || [];
            fpsChart.data.datasets[0].data = chartData.fps_chart.datasets[0].data || [];
            fpsChart.update('none');
        }
        
        if (serverHealthData.charts.players && chartData.players_chart) {
            const playersChart = serverHealthData.charts.players;
            playersChart.data.labels = chartData.players_chart.labels || [];
            playersChart.data.datasets[0].data = chartData.players_chart.datasets[0].data || [];
            playersChart.update('none');
        }
    }
    
    function showDemoChartData() {
        const labels = [];
        const fpsData = [];
        const playersData = [];
        
        for (let i = 0; i < 12; i++) {
            const time = new Date(Date.now() - (11 - i) * 30 * 60 * 1000);
            labels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
            fpsData.push(Math.floor(Math.random() * 20) + 50);
            playersData.push(Math.floor(Math.random() * 10) + 5);
        }
        
        const demoChartData = {
            fps_chart: {
                labels: labels,
                datasets: [{ data: fpsData }]
            },
            players_chart: {
                labels: labels,
                datasets: [{ data: playersData }]
            }
        };
        
        updateCharts(demoChartData);
        console.log('üìä Demo chart data displayed');
    }
    
    // ============================================================================
    // COMMAND FEED (PRESERVED)
    // ============================================================================
    
    async function loadCommandFeed() {
        if (!serverHealthData.currentServer) {
            console.warn('‚ö†Ô∏è No server selected for command feed');
            return;
        }
        
        try {
            console.log(`üìã Loading command feed for server ${serverHealthData.currentServer}...`);
            
            showCommandLoading(true);
            
            const response = await fetch(`/api/server_health/commands/${serverHealthData.currentServer}`);
            const result = await response.json();
            
            if (result.success) {
                serverHealthData.commandFeed = result.commands || [];
                updateCommandFeedDisplay();
                updateCommandStats(result.command_types || {}, result.total || 0);
                console.log(`‚úÖ Loaded ${serverHealthData.commandFeed.length} commands`);
            } else {
                console.error('‚ùå Command feed error:', result.error);
                showDemoCommandData();
            }
            
        } catch (error) {
            console.error('‚ùå Error loading command feed:', error);
            showDemoCommandData();
        } finally {
            showCommandLoading(false);
        }
    }
    
    function updateCommandFeedDisplay() {
        const commandFeed = document.getElementById('command-feed');
        if (!commandFeed) return;
        
        const filteredCommands = filterCommandsByType(serverHealthData.commandFeed);
        
        if (filteredCommands.length === 0) {
            commandFeed.innerHTML = '<div class="text-gray-400 text-center py-4">No commands found</div>';
            return;
        }
        
        const commandHTML = filteredCommands.map(cmd => `
            <div class="command-entry text-xs p-2 bg-gray-700 rounded mb-2 hover:bg-gray-600 transition-colors">
                <div class="flex justify-between items-start">
                    <span class="text-${getCommandColor(cmd.type)} flex-1 mr-2">
                        [${formatTime(cmd.timestamp)}] ${safeEscapeHtml(cmd.command)}
                    </span>
                    <span class="text-${getTypeColor(cmd.type)} text-xs whitespace-nowrap">
                        ${getTypeIcon(cmd.type)} ${cmd.type}
                    </span>
                </div>
                ${cmd.user && cmd.user !== 'System' ? `
                    <div class="text-gray-500 text-xs mt-1">by ${safeEscapeHtml(cmd.user)}</div>
                ` : ''}
            </div>
        `).join('');
        
        commandFeed.innerHTML = commandHTML;
        commandFeed.scrollTop = commandFeed.scrollHeight;
    }
    
    function filterCommandsByType(commands) {
        const activeFilter = serverHealthData.filters.active;
        if (activeFilter === 'all') {
            return commands;
        }
        return commands.filter(cmd => cmd.type && cmd.type.toLowerCase() === activeFilter.toLowerCase());
    }
    
    function filterCommands(type) {
        console.log(`üîç Filtering commands by: ${type}`);
        serverHealthData.filters.active = type;
        updateFilterButtons();
        updateCommandFeedDisplay();
    }
    
    function updateFilterButtons() {
        const filterTypes = ['all', 'admin', 'ingame', 'auto'];
        
        filterTypes.forEach(type => {
            const button = document.getElementById(`filter-${type}-btn`);
            if (button) {
                button.classList.remove('bg-purple-600', 'bg-gray-600');
                if (type === serverHealthData.filters.active) {
                    button.classList.add('bg-purple-600');
                } else {
                    button.classList.add('bg-gray-600');
                }
            }
        });
    }
    
    function updateCommandStats(commandTypes, total) {
        const totalElement = document.getElementById('command-total-count');
        if (totalElement) {
            totalElement.textContent = total;
        }
    }
    
    function showDemoCommandData() {
        const demoCommands = [
            { command: 'serverinfo', type: 'auto', timestamp: new Date().toISOString(), user: 'System' },
            { command: 'say Welcome players!', type: 'admin', timestamp: new Date(Date.now() - 300000).toISOString(), user: 'Admin' },
            { command: 'players', type: 'ingame', timestamp: new Date(Date.now() - 600000).toISOString(), user: 'Player123' },
            { command: 'save', type: 'auto', timestamp: new Date(Date.now() - 900000).toISOString(), user: 'System' }
        ];
        
        serverHealthData.commandFeed = demoCommands;
        updateCommandFeedDisplay();
        console.log('üìã Demo command data displayed');
    }
    
    // ============================================================================
    // AUTO-REFRESH
    // ============================================================================
    
    function startAutoRefresh() {
        if (serverHealthData.refreshInterval) {
            clearInterval(serverHealthData.refreshInterval);
        }
        
        serverHealthData.refreshInterval = setInterval(() => {
            if (serverHealthData.isActive && serverHealthData.currentServer) {
                console.log('üîÑ Auto-refreshing Server Health data...');
                refreshHealthData();
            }
        }, 30000);
        
        console.log('‚è∞ Auto-refresh started (30s intervals)');
    }
    
    function refreshHealthData() {
        if (!serverHealthData.currentServer) return;
        
        console.log('üîÑ Refreshing all health data (WITH TRENDS)...');
        
        loadHealthStatus();
        loadHealthCharts();
        loadCommandFeed();
        loadTrendsData();
    }
    
    function refreshServerHealth() {
        console.log('üîÑ Server Health: Manual refresh triggered');
        setupServerSelector();
        if (serverHealthData.currentServer) {
            refreshHealthData();
        }
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function getCommandColor(type) {
        const colors = {
            'admin': 'green-400',
            'ingame': 'blue-400',
            'auto': 'yellow-400',
            'system': 'purple-400'
        };
        return colors[type?.toLowerCase()] || 'gray-400';
    }
    
    function getTypeColor(type) {
        const colors = {
            'admin': 'purple-400',
            'ingame': 'blue-400',
            'auto': 'yellow-400',
            'system': 'gray-400'
        };
        return colors[type?.toLowerCase()] || 'gray-400';
    }
    
    function getTypeIcon(type) {
        const icons = {
            'admin': '‚ö°',
            'ingame': 'üéÆ',
            'auto': 'ü§ñ',
            'system': '‚öôÔ∏è'
        };
        return icons[type?.toLowerCase()] || 'üìù';
    }
    
    function getStatusColor(status) {
        const colors = {
            'healthy': 'green',
            'warning': 'yellow',
            'critical': 'red',
            'error': 'red',
            'loading': 'blue'
        };
        return colors[status?.toLowerCase()] || 'gray';
    }
    
    function getHealthBarColor(status) {
        const colors = {
            'healthy': 'bg-green-500',
            'warning': 'bg-yellow-500',
            'critical': 'bg-red-500',
            'error': 'bg-red-500',
            'loading': 'bg-blue-500'
        };
        return colors[status?.toLowerCase()] || 'bg-gray-500';
    }
    
    function formatTime(timestamp) {
        if (!timestamp) return '--:--';
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    function safeEscapeHtml(text) {
        if (!text) return '';
        
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================================
    // ERROR HANDLING & FALLBACKS
    // ============================================================================
    
    function showHealthError(message) {
        console.error('üö® Server Health Error:', message);
        
        const errorDiv = document.getElementById('health-error-message');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
    }
    
    function showNoServersMessage() {
        const statusCards = document.querySelectorAll('.health-status-card');
        statusCards.forEach(card => {
            const valueElement = card.querySelector('.status-value');
            const labelElement = card.querySelector('.status-label');
            if (valueElement) valueElement.textContent = '--';
            if (labelElement && labelElement.textContent.includes('Status')) {
                valueElement.textContent = 'No Server';
                valueElement.className = 'status-value text-gray-400';
            }
        });
        
        const chartsContainer = document.querySelector('.health-charts-container') ||
                              document.querySelector('.flex-1.lg\\:w-3\\/4');
        if (chartsContainer) {
            chartsContainer.innerHTML = `
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-6 text-center">
                    <div class="text-yellow-400 text-4xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-white text-lg font-semibold mb-2">No Servers Available</h3>
                    <p class="text-yellow-200 mb-4">
                        No managed servers found for health monitoring.
                    </p>
                    <div class="space-y-2 text-sm text-yellow-300">
                        <p>‚Ä¢ Go to the <strong>Server Manager</strong> tab to add servers</p>
                        <p>‚Ä¢ Or wait for servers to finish loading</p>
                        <p>‚Ä¢ Then return to this tab</p>
                    </div>
                    <button onclick="window.showTab('server-manager')" 
                            class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                        Go to Server Manager
                    </button>
                </div>
            `;
        }
        
        const commandFeed = document.getElementById('command-feed');
        if (commandFeed) {
            commandFeed.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <div class="text-2xl mb-2">üì≠</div>
                    <p>No server selected</p>
                    <p class="text-xs mt-1">Select a server to view commands</p>
                </div>
            `;
        }
    }
    
    function showSelectServerMessage() {
        const statusCards = document.querySelector('.health-status-cards');
        if (statusCards) {
            statusCards.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">üìä</div>
                    <h3 class="text-lg font-semibold mb-2">Select a Server</h3>
                    <p class="text-gray-400">Choose a server from the dropdown to view health data.</p>
                </div>
            `;
        }
    }
    
    function showChartsUnavailable() {
        const chartsSection = document.querySelector('.health-charts-section');
        if (chartsSection) {
            chartsSection.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">üìà</div>
                    <h3 class="text-lg font-semibold mb-2">Charts Unavailable</h3>
                    <p class="text-gray-400">Chart.js library not loaded. Charts will be displayed when available.</p>
                </div>
            `;
        }
    }
    
    function showCommandLoading(show) {
        const loadingEl = document.getElementById('command-loading');
        if (loadingEl) {
            if (show) {
                loadingEl.classList.remove('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }
        }
    }
    
    function showDemoHealthData() {
        const demoData = {
            overall_status: 'healthy',
            health_data: {
                health_percentage: 85,
                metrics: {
                    response_time: 45,
                    memory_usage: 512,
                    cpu_usage: 25,
                    player_count: 12
                }
            }
        };
        
        updateHealthStatusDisplay(demoData);
        console.log('üìä Demo health data displayed');
    }
    
    // ============================================================================
    // MODULE LIFECYCLE
    // ============================================================================
    
    function unloadServerHealth() {
        console.log('üè• Unloading Server Health module...');
        
        serverHealthData.isActive = false;
        
        if (serverHealthData.refreshInterval) {
            clearInterval(serverHealthData.refreshInterval);
            serverHealthData.refreshInterval = null;
        }
        
        destroyExistingCharts();
        
        // Clean up dynamic elements
        removeDynamicPlayerCountElements();
        
        console.log('‚úÖ Server Health module unloaded');
    }
    
    // ============================================================================
    // GLOBAL FUNCTION EXPOSURE
    // ============================================================================
    
    window.loadServerHealth = loadServerHealth;
    window.unloadServerHealth = unloadServerHealth;
    window.refreshHealthData = refreshHealthData;
    window.filterCommands = filterCommands;
    window.refreshServerHealth = refreshServerHealth;
    window.loadTrendsData = loadTrendsData;
    window.updateTrendsDisplay = updateTrendsDisplay;
    
    // ‚úÖ FIXED: Expose Server Health specific player count function
    window.updateServerHealthPlayerCount = updateServerHealthPlayerCount;
    
    console.log('‚úÖ Server Health JavaScript module loaded successfully (CONTEXT-AWARE + FIXED DOM)');
    console.log('üè• Functions available: loadServerHealth, refreshHealthData, filterCommands, loadTrendsData, updateTrendsDisplay, updateServerHealthPlayerCount');

</script>