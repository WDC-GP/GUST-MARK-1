<!-- ============================================================================
     GUST Bot Enhanced - Server Manager JavaScript Module (COMPLETE FIXED VERSION)
     ============================================================================
     ✅ FIXED: Enhanced function exposure and error handling
     ✅ FIXED: Better integration with new request queue system
     ✅ FIXED: Improved API endpoint handling
     ✅ FIXED: Compatible with template fallback functions
     ============================================================================ -->

<script>
    // ============================================================================
    // SERVER MANAGER MODULE - ENHANCED WITH FIXES
    // ============================================================================
    
    console.log('📦 Loading Server Manager module with fixes...');
    
    // ============================================================================
    // ENHANCED UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * ✅ ENHANCED: Safe API call wrapper using enhanced fetch
     */
    async function makeServerAPICall(url, options = {}) {
        try {
            // Use enhanced fetch if available, fallback to regular fetch
            if (typeof window.enhancedFetch === 'function') {
                return await window.enhancedFetch(url, options);
            } else {
                const response = await fetch(url, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
        } catch (error) {
            console.error(`❌ API call failed: ${url}`, error);
            throw error;
        }
    }
    
    /**
     * ✅ ENHANCED: Add live console message with better error handling
     */
    function addLiveConsoleMessage(message, serverId = '', type = 'info') {
        try {
            const timestamp = new Date().toISOString();
            const messageObj = {
                timestamp,
                message,
                type,
                source: 'server_manager',
                serverId
            };
            
            // Try multiple methods to add console message
            if (typeof window.addLiveConsoleMessage === 'function') {
                window.addLiveConsoleMessage(messageObj);
            } else if (typeof window.addConsoleMessage === 'function') {
                window.addConsoleMessage(messageObj);
            } else {
                console.log(`📝 Console Message (${type}): ${message}`);
            }
        } catch (error) {
            console.error('❌ Error adding console message:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 1: loadManagedServers (ENHANCED)
    // ============================================================================
    
    async function loadManagedServers() {
        console.log('🔄 Loading managed servers...');
        
        try {
            const servers = await makeServerAPICall('/api/servers');
            
            // Update global variable
            if (window.managedServers) {
                window.managedServers = servers;
            } else {
                window.managedServers = servers;
            }
            
            // Update server dropdowns across the application
            updateAllServerDropdowns();
            
            // Update display
            refreshServerList();
            
            console.log(`✅ Loaded ${servers.length} managed servers`);
            addLiveConsoleMessage(`Loaded ${servers.length} managed servers`, '', 'success');
            
            return servers;
            
        } catch (error) {
            console.error('❌ Error loading managed servers:', error);
            addLiveConsoleMessage(`Error loading servers: ${error.message}`, '', 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 2: autoConnectToAllServers (ENHANCED)
    // ============================================================================
    
    async function autoConnectToAllServers() {
        console.log('🔄 Auto-connecting to all servers...');
        
        try {
            const servers = window.managedServers || [];
            if (servers.length === 0) {
                console.log('ℹ️ No servers to connect to');
                return;
            }
            
            let connectedCount = 0;
            let errorCount = 0;
            
            for (const server of servers) {
                try {
                    await autoConnectToServer(server.serverId);
                    connectedCount++;
                } catch (error) {
                    console.error(`❌ Failed to connect to server ${server.serverId}:`, error);
                    errorCount++;
                }
                
                // Small delay between connections
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const message = `Auto-connect complete: ${connectedCount} connected, ${errorCount} failed`;
            console.log(`✅ ${message}`);
            addLiveConsoleMessage(message, '', connectedCount > 0 ? 'success' : 'warning');
            
        } catch (error) {
            console.error('❌ Error in auto-connect all:', error);
            addLiveConsoleMessage(`Auto-connect error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 3: autoConnectToServer (ENHANCED)
    // ============================================================================
    
    async function autoConnectToServer(serverId) {
        console.log(`🔄 Auto-connecting to server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found in managed servers`);
            }
            
            // Update connection status
            if (!window.connectionStatus) {
                window.connectionStatus = {};
            }
            window.connectionStatus[serverId] = 'connecting';
            
            // Simulate connection logic (replace with actual implementation)
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Update status to connected
            window.connectionStatus[serverId] = 'connected';
            
            console.log(`✅ Connected to server: ${server.serverName} (${serverId})`);
            addLiveConsoleMessage(`Connected to ${server.serverName}`, serverId, 'success');
            
            return true;
            
        } catch (error) {
            console.error(`❌ Failed to connect to server ${serverId}:`, error);
            
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'error';
            }
            
            addLiveConsoleMessage(`Connection failed: ${error.message}`, serverId, 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 4: getServerRegion (ENHANCED)
    // ============================================================================
    
    function getServerRegion(serverId) {
        try {
            const servers = window.managedServers || [];
            const server = servers.find(s => s.serverId === serverId);
            return server ? server.serverRegion : 'US';
        } catch (error) {
            console.error('❌ Error getting server region:', error);
            return 'US';
        }
    }
    
    // ============================================================================
    // FUNCTION 5: addNewServer (ENHANCED - PRIMARY IMPLEMENTATION)
    // ============================================================================
    
    async function addNewServer() {
        console.log('🔄 Adding new server (primary function)...');
        
        try {
            // Get form data
            const serverId = document.getElementById('newServerId').value.trim();
            const serverName = document.getElementById('newServerName').value.trim();
            const serverRegion = document.getElementById('newServerRegion').value;
            const serverType = document.getElementById('newServerType').value;
            const description = document.getElementById('newServerDescription').value.trim();
            
            // Validate
            if (!serverId || !serverName) {
                throw new Error('Server ID and Server Name are required');
            }
            
            if (!/^\d+$/.test(serverId)) {
                throw new Error('Server ID must be numeric');
            }
            
            // Check for duplicates
            const existingServer = (window.managedServers || []).find(s => s.serverId === serverId);
            if (existingServer) {
                throw new Error('A server with this ID already exists!');
            }
            
            // Prepare server data
            const serverData = {
                serverId,
                serverName,
                serverRegion,
                serverType,
                description
            };
            
            // Make API call
            const result = await makeServerAPICall('/api/servers/add', {
                method: 'POST',
                body: JSON.stringify(serverData),
                priority: 'high' // High priority for user actions
            });
            
            if (result.success) {
                // Clear form
                clearServerForm();
                
                // Reload servers
                await loadManagedServers();
                
                // Refresh display
                loadServerManager();
                
                console.log('✅ Server added successfully via primary function');
                addLiveConsoleMessage(`Server "${serverName}" added successfully`, serverId, 'success');
                
                // Show success message if status element exists
                const statusEl = document.getElementById('addServerStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="text-green-400">✅ Server added successfully!</span>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                }
                
                return result;
                
            } else {
                throw new Error(result.error || 'Server addition failed');
            }
            
        } catch (error) {
            console.error('❌ Add server error (primary function):', error);
            addLiveConsoleMessage(`Failed to add server: ${error.message}`, '', 'error');
            
            // Show error message if status element exists
            const statusEl = document.getElementById('addServerStatus');
            if (statusEl) {
                statusEl.innerHTML = `<span class="text-red-400">❌ Error: ${error.message}</span>`;
            }
            
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 6: clearServerForm (ENHANCED)
    // ============================================================================
    
    function clearServerForm() {
        try {
            const fields = [
                { id: 'newServerId', defaultValue: '' },
                { id: 'newServerName', defaultValue: '' },
                { id: 'newServerDescription', defaultValue: '' },
                { id: 'newServerRegion', defaultValue: 'US' },
                { id: 'newServerType', defaultValue: 'Standard' }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.defaultValue;
                }
            });
            
            // Clear status messages
            const statusElements = ['addServerStatus', 'serverFormStatus'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            
            console.log('✅ Server form cleared');
            
        } catch (error) {
            console.error('❌ Error clearing server form:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 7: loadServerManager (ENHANCED)
    // ============================================================================
    
    async function loadServerManager() {
        console.log('🔄 Loading server manager...');
        
        try {
            // Load managed servers first
            await loadManagedServers();
            
            // Refresh the server list display
            refreshServerList();
            
            // Auto-connect to servers if configured
            // (commented out to prevent automatic connections)
            // await autoConnectToAllServers();
            
            console.log('✅ Server manager loaded successfully');
            
        } catch (error) {
            console.error('❌ Error loading server manager:', error);
            addLiveConsoleMessage(`Server manager load error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 8: getStatusClass (ENHANCED)
    // ============================================================================
    
    function getStatusClass(status) {
        const statusClasses = {
            'online': 'bg-green-800 text-green-200 border border-green-600',
            'offline': 'bg-red-800 text-red-200 border border-red-600',
            'connecting': 'bg-yellow-800 text-yellow-200 border border-yellow-600',
            'error': 'bg-red-900 text-red-300 border border-red-700',
            'unknown': 'bg-gray-700 text-gray-300 border border-gray-600'
        };
        
        return statusClasses[status] || statusClasses['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 9: getStatusText (ENHANCED)
    // ============================================================================
    
    function getStatusText(status) {
        const statusTexts = {
            'online': '🟢 Online',
            'offline': '🔴 Offline',
            'connecting': '🟡 Connecting',
            'error': '❌ Error',
            'unknown': '⚪ Unknown'
        };
        
        return statusTexts[status] || statusTexts['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 10: pingSingleServer (ENHANCED)
    // ============================================================================
    
    async function pingSingleServer(serverId) {
        console.log(`🏓 Pinging server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found`);
            }
            
            // Make ping API call
            const result = await makeServerAPICall(`/api/servers/ping/${serverId}`, {
                method: 'POST',
                priority: 'high'
            });
            
            if (result.success) {
                console.log(`✅ Ping successful: ${server.serverName} (${result.response_time_ms}ms)`);
                
                // Update server status if we have the servers array
                if (window.managedServers) {
                    const serverIndex = window.managedServers.findIndex(s => s.serverId === serverId);
                    if (serverIndex !== -1) {
                        window.managedServers[serverIndex].status = result.status;
                        window.managedServers[serverIndex].lastPing = result.ping_time;
                        window.managedServers[serverIndex].responseTime = result.response_time_ms;
                    }
                }
                
                // Update dropdowns and refresh display
                updateAllServerDropdowns();
                refreshServerList();
                
                addLiveConsoleMessage(
                    `Ping successful: ${server.serverName} (${result.response_time_ms}ms)`,
                    serverId,
                    'success'
                );
                
                return result;
                
            } else {
                throw new Error(result.message || 'Ping failed');
            }
            
        } catch (error) {
            console.error(`❌ Ping failed for server ${serverId}:`, error);
            
            // Update server status to error
            if (window.managedServers) {
                const serverIndex = window.managedServers.findIndex(s => s.serverId === serverId);
                if (serverIndex !== -1) {
                    window.managedServers[serverIndex].status = 'error';
                    window.managedServers[serverIndex].lastPing = new Date().toISOString();
                }
            }
            
            updateAllServerDropdowns();
            refreshServerList();
            
            addLiveConsoleMessage(
                `Ping failed: ${error.message}`,
                serverId,
                'error'
            );
            
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 11: deleteServer (ENHANCED)
    // ============================================================================
    
    async function deleteServer(serverId) {
        const server = (window.managedServers || []).find(s => s.serverId === serverId);
        const serverName = server ? server.serverName : `Server ${serverId}`;
        
        if (!confirm(`Are you sure you want to delete "${serverName}"?`)) {
            return;
        }
        
        console.log(`🗑️ Deleting server: ${serverName} (${serverId})`);
        
        try {
            const result = await makeServerAPICall(`/api/servers/delete/${serverId}`, {
                method: 'DELETE',
                priority: 'high'
            });
            
            if (result.success) {
                // Remove from global array
                if (window.managedServers) {
                    window.managedServers = window.managedServers.filter(s => s.serverId !== serverId);
                }
                
                // Update displays
                updateAllServerDropdowns();
                refreshServerList();
                
                console.log(`✅ Server deleted: ${serverName}`);
                addLiveConsoleMessage(`Server "${serverName}" deleted successfully`, serverId, 'success');
                
                return result;
                
            } else {
                throw new Error(result.error || 'Delete failed');
            }
            
        } catch (error) {
            console.error(`❌ Delete server error: ${error.message}`);
            addLiveConsoleMessage(`Failed to delete server: ${error.message}`, serverId, 'error');
            alert(`Error deleting server: ${error.message}`);
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 12: refreshServerList (ENHANCED)
    // ============================================================================
    
    async function refreshServerList() {
        console.log('🔄 Refreshing server list display...');
        
        try {
            const servers = window.managedServers || [];
            const container = document.getElementById('managedServersList');
            
            if (!container) {
                console.warn('⚠️ managedServersList container not found');
                return;
            }
            
            if (servers.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-4">🖥️</div>
                        <div>No servers added yet</div>
                        <div class="text-sm mt-2">Add your first server above to get started</div>
                    </div>
                `;
                return;
            }
            
            // Create server cards
            const serverHTML = servers.map(server => {
                const statusClass = getStatusClass(server.status || 'unknown');
                const statusText = getStatusText(server.status || 'unknown');
                
                return `
                    <div class="bg-gray-700 p-4 rounded-lg border border-gray-600 hover:border-gray-500 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg">${escapeHtml(server.serverName || 'Unknown Server')}</h4>
                                <p class="text-gray-400 text-sm">ID: ${escapeHtml(server.serverId || 'N/A')}</p>
                                <p class="text-gray-400 text-xs">
                                    Region: ${escapeHtml(server.serverRegion || 'Unknown')} | 
                                    Type: ${escapeHtml(server.serverType || 'Standard')}
                                </p>
                                ${server.description ? `<p class="text-gray-300 text-sm mt-1">${escapeHtml(server.description)}</p>` : ''}
                                ${server.lastPing ? `<p class="text-gray-500 text-xs mt-1">Last ping: ${new Date(server.lastPing).toLocaleTimeString()}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded text-xs ${statusClass}">
                                    ${statusText}
                                </span>
                                <button onclick="pingSingleServer('${server.serverId}')" 
                                        class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Ping server">
                                    🏓
                                </button>
                                <button onclick="deleteServer('${server.serverId}')" 
                                        class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Delete server">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = serverHTML;
            
            console.log(`✅ Server list refreshed: ${servers.length} servers displayed`);
            
        } catch (error) {
            console.error('❌ Error refreshing server list:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 13: updateAllServerDropdowns (ENHANCED)
    // ============================================================================
    
    function updateAllServerDropdowns() {
        console.log('🔄 Updating all server dropdowns...');
        
        try {
            const servers = window.managedServers || [];
            const dropdownSelectors = [
                '#serverSelector',
                '#eventServerSelect',
                '#consoleServerSelect',
                '#healthServerSelect',
                '.server-dropdown'
            ];
            
            dropdownSelectors.forEach(selector => {
                const dropdowns = document.querySelectorAll(selector);
                
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    
                    const currentValue = dropdown.value;
                    
                    // Create options HTML
                    const optionsHTML = servers.map(server => {
                        const statusIcon = server.status === 'online' ? '🟢' : server.status === 'offline' ? '🔴' : '⚪';
                        return `<option value="${server.serverId}">${statusIcon} ${escapeHtml(server.serverName)} (${server.serverId})</option>`;
                    }).join('');
                    
                    // Update dropdown
                    dropdown.innerHTML = servers.length > 0 
                        ? `<option value="">Select a server...</option>${optionsHTML}`
                        : '<option value="">No servers available</option>';
                    
                    // Restore selection if still valid
                    if (currentValue && servers.some(s => s.serverId === currentValue)) {
                        dropdown.value = currentValue;
                    }
                });
            });
            
            console.log(`✅ Updated dropdowns for ${servers.length} servers`);
            
        } catch (error) {
            console.error('❌ Error updating server dropdowns:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 14: disconnectServer (ENHANCED)
    // ============================================================================
    
    async function disconnectServer(serverId) {
        console.log(`🔌 Disconnecting from server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            const serverName = server ? server.serverName : `Server ${serverId}`;
            
            // Update connection status
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'disconnecting';
            }
            
            // Simulate disconnection (replace with actual logic)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Update status
            if (window.connectionStatus) {
                delete window.connectionStatus[serverId];
            }
            
            console.log(`✅ Disconnected from server: ${serverName}`);
            addLiveConsoleMessage(`Disconnected from ${serverName}`, serverId, 'info');
            
        } catch (error) {
            console.error(`❌ Disconnect error for server ${serverId}:`, error);
            addLiveConsoleMessage(`Disconnect error: ${error.message}`, serverId, 'error');
        }
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================================
    // ✅ ENHANCED MODULE INITIALIZATION AND FUNCTION EXPOSURE
    // ============================================================================
    
    console.log('📦 Server Manager module loaded - 14 functions available (ENHANCED VERSION)');
    
    // ✅ CRITICAL: Expose all functions to global scope immediately
    if (typeof window !== 'undefined') {
        // Primary functions
        window.loadManagedServers = loadManagedServers;
        window.autoConnectToAllServers = autoConnectToAllServers;
        window.autoConnectToServer = autoConnectToServer;
        window.getServerRegion = getServerRegion;
        window.addNewServer = addNewServer;
        window.clearServerForm = clearServerForm;
        window.loadServerManager = loadServerManager;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.pingSingleServer = pingSingleServer;
        window.deleteServer = deleteServer;
        window.refreshServerList = refreshServerList;
        window.updateAllServerDropdowns = updateAllServerDropdowns;
        window.disconnectServer = disconnectServer;
        
        // Utility functions
        window.addLiveConsoleMessage = addLiveConsoleMessage;
        window.makeServerAPICall = makeServerAPICall;
        
        console.log('✅ All server manager functions exposed to global scope');
        console.log('🔧 Available functions:', {
            addNewServer: typeof window.addNewServer,
            loadServerManager: typeof window.loadServerManager,
            clearServerForm: typeof window.clearServerForm,
            pingSingleServer: typeof window.pingSingleServer,
            deleteServer: typeof window.deleteServer
        });
    }
    
    // ✅ ENHANCED: DOM ready initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('✅ Server Manager module initialized (ENHANCED VERSION)');
        
        // Set up keyboard shortcuts for server form
        const serverFormInputs = ['newServerId', 'newServerName', 'newServerDescription'];
        serverFormInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (typeof window.addNewServer === 'function') {
                            window.addNewServer();
                        }
                    }
                });
            }
        });
        
        console.log('🎯 Server Manager ready - Add Server button should work immediately');
    });
    
    console.log('🚀 Server Manager module fully loaded and enhanced');

</script>