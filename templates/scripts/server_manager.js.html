<!-- ============================================================================
     GUST Bot Enhanced - Server Manager JavaScript Module (COMPLETE FIXED VERSION)
     ============================================================================
     ‚úÖ FIXED: Enhanced function exposure and error handling
     ‚úÖ FIXED: Better integration with new request queue system
     ‚úÖ FIXED: Improved API endpoint handling
     ‚úÖ FIXED: Compatible with template fallback functions
     ‚úÖ NEW: Permanent ping fix with data normalization and type-safe lookups
     ============================================================================ -->

<script>
    // ============================================================================
    // SERVER MANAGER MODULE - ENHANCED WITH PERMANENT PING FIXES
    // ============================================================================
    
    console.log('üì¶ Loading Server Manager module with permanent ping fixes...');
    
    // ============================================================================
    // ENHANCED UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * ‚úÖ ENHANCED: Safe API call wrapper using enhanced fetch
     */
    async function makeServerAPICall(url, options = {}) {
        try {
            // Use enhanced fetch if available, fallback to regular fetch
            if (typeof window.enhancedFetch === 'function') {
                return await window.enhancedFetch(url, options);
            } else {
                const response = await fetch(url, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
        } catch (error) {
            console.error(`‚ùå API call failed: ${url}`, error);
            throw error;
        }
    }
    
    /**
     * ‚úÖ ENHANCED: Add live console message with better error handling
     */
    function addLiveConsoleMessage(message, serverId = '', type = 'info') {
        try {
            const timestamp = new Date().toISOString();
            const messageObj = {
                timestamp,
                message,
                type,
                source: 'server_manager',
                serverId
            };
            
            // Try multiple methods to add console message
            if (typeof window.addLiveConsoleMessage === 'function') {
                window.addLiveConsoleMessage(messageObj);
            } else if (typeof window.addConsoleMessage === 'function') {
                window.addConsoleMessage(messageObj);
            } else {
                console.log(`üìù Console Message (${type}): ${message}`);
            }
        } catch (error) {
            console.error('‚ùå Error adding console message:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 1: loadManagedServers (ENHANCED WITH DATA NORMALIZATION)
    // ============================================================================
    
    async function loadManagedServers() {
        console.log('üîÑ Loading managed servers with data normalization...');
        
        try {
            const response = await makeServerAPICall('/api/servers');
            const rawServers = response.servers || response || [];
            
            // ‚úÖ PERMANENT FIX: Normalize server data structure
            const normalizedServers = rawServers.map(server => ({
                // Handle different ID field names
                serverId: server.serverId || server.id || server.server_id,
                id: server.serverId || server.id || server.server_id,
                
                // Handle different name field names  
                serverName: server.serverName || server.name || server.server_name || 'Unknown Server',
                name: server.serverName || server.name || server.server_name || 'Unknown Server',
                
                // Handle different region field names
                serverRegion: server.serverRegion || server.region || server.server_region || 'US',
                region: server.serverRegion || server.region || server.server_region || 'US',
                
                // Server type and status
                serverType: server.serverType || server.type || 'Standard',
                status: server.status || 'unknown',
                isActive: server.isActive !== false, // Default to true
                
                // Additional fields
                description: server.description || '',
                lastPing: server.lastPing || null,
                responseTime: server.responseTime || 0,
                
                // Copy all original fields
                ...server
            }));
            
            // Update global variable with normalized data
            window.managedServers = normalizedServers;
            
            console.log('‚úÖ Server data normalized:', window.managedServers);
            
            // Update server dropdowns across the application
            updateAllServerDropdowns();
            
            // Update display
            refreshServerList();
            
            console.log(`‚úÖ Loaded ${normalizedServers.length} managed servers`);
            addLiveConsoleMessage(`Loaded ${normalizedServers.length} managed servers`, '', 'success');
            
            // Trigger events for other modules
            document.dispatchEvent(new CustomEvent('managedServersLoaded'));
            if (typeof emitStateEvent === 'function') {
                emitStateEvent('managedServers:updated', normalizedServers);
            }
            
            return normalizedServers;
            
        } catch (error) {
            console.error('‚ùå Error loading managed servers:', error);
            window.managedServers = [];
            addLiveConsoleMessage(`Error loading servers: ${error.message}`, '', 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 2: autoConnectToAllServers (ENHANCED)
    // ============================================================================
    
    async function autoConnectToAllServers() {
        console.log('üîÑ Auto-connecting to all servers...');
        
        try {
            const servers = window.managedServers || [];
            if (servers.length === 0) {
                console.log('‚ÑπÔ∏è No servers to connect to');
                return;
            }
            
            let connectedCount = 0;
            let errorCount = 0;
            
            for (const server of servers) {
                try {
                    await autoConnectToServer(server.serverId);
                    connectedCount++;
                } catch (error) {
                    console.error(`‚ùå Failed to connect to server ${server.serverId}:`, error);
                    errorCount++;
                }
                
                // Small delay between connections
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const message = `Auto-connect complete: ${connectedCount} connected, ${errorCount} failed`;
            console.log(`‚úÖ ${message}`);
            addLiveConsoleMessage(message, '', connectedCount > 0 ? 'success' : 'warning');
            
        } catch (error) {
            console.error('‚ùå Error in auto-connect all:', error);
            addLiveConsoleMessage(`Auto-connect error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 3: autoConnectToServer (ENHANCED)
    // ============================================================================
    
    async function autoConnectToServer(serverId) {
        console.log(`üîÑ Auto-connecting to server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found in managed servers`);
            }
            
            // Update connection status
            if (!window.connectionStatus) {
                window.connectionStatus = {};
            }
            window.connectionStatus[serverId] = 'connecting';
            
            // Simulate connection logic (replace with actual implementation)
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Update status to connected
            window.connectionStatus[serverId] = 'connected';
            
            console.log(`‚úÖ Connected to server: ${server.serverName} (${serverId})`);
            addLiveConsoleMessage(`Connected to ${server.serverName}`, serverId, 'success');
            
            return true;
            
        } catch (error) {
            console.error(`‚ùå Failed to connect to server ${serverId}:`, error);
            
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'error';
            }
            
            addLiveConsoleMessage(`Connection failed: ${error.message}`, serverId, 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 4: getServerRegion (ENHANCED)
    // ============================================================================
    
    function getServerRegion(serverId) {
        try {
            const servers = window.managedServers || [];
            const server = servers.find(s => s.serverId === serverId);
            return server ? server.serverRegion : 'US';
        } catch (error) {
            console.error('‚ùå Error getting server region:', error);
            return 'US';
        }
    }
    
    // ============================================================================
    // FUNCTION 5: addNewServer (ENHANCED - PRIMARY IMPLEMENTATION)
    // ============================================================================
    
    async function addNewServer() {
        console.log('üîÑ Adding new server (primary function)...');
        
        try {
            // Get form data
            const serverId = document.getElementById('newServerId').value.trim();
            const serverName = document.getElementById('newServerName').value.trim();
            const serverRegion = document.getElementById('newServerRegion').value;
            const serverType = document.getElementById('newServerType').value;
            const description = document.getElementById('newServerDescription').value.trim();
            
            // Validate
            if (!serverId || !serverName) {
                throw new Error('Server ID and Server Name are required');
            }
            
            if (!/^\d+$/.test(serverId)) {
                throw new Error('Server ID must be numeric');
            }
            
            // Check for duplicates
            const existingServer = (window.managedServers || []).find(s => s.serverId === serverId);
            if (existingServer) {
                throw new Error('A server with this ID already exists!');
            }
            
            // Prepare server data
            const serverData = {
                serverId,
                serverName,
                serverRegion,
                serverType,
                description
            };
            
            // Make API call
            const result = await makeServerAPICall('/api/servers/add', {
                method: 'POST',
                body: JSON.stringify(serverData),
                priority: 'high' // High priority for user actions
            });
            
            if (result.success) {
                // Clear form
                clearServerForm();
                
                // Reload servers
                await loadManagedServers();
                
                // Refresh display
                loadServerManager();
                
                console.log('‚úÖ Server added successfully via primary function');
                addLiveConsoleMessage(`Server "${serverName}" added successfully`, serverId, 'success');
                
                // Show success message if status element exists
                const statusEl = document.getElementById('addServerStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="text-green-400">‚úÖ Server added successfully!</span>';
                    setTimeout(() => { statusEl.innerHTML = ''; }, 5000);
                }
                
                return result;
                
            } else {
                throw new Error(result.error || 'Server addition failed');
            }
            
        } catch (error) {
            console.error('‚ùå Add server error (primary function):', error);
            addLiveConsoleMessage(`Failed to add server: ${error.message}`, '', 'error');
            
            // Show error message if status element exists
            const statusEl = document.getElementById('addServerStatus');
            if (statusEl) {
                statusEl.innerHTML = `<span class="text-red-400">‚ùå Error: ${error.message}</span>`;
            }
            
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 6: clearServerForm (ENHANCED)
    // ============================================================================
    
    function clearServerForm() {
        try {
            const fields = [
                { id: 'newServerId', defaultValue: '' },
                { id: 'newServerName', defaultValue: '' },
                { id: 'newServerDescription', defaultValue: '' },
                { id: 'newServerRegion', defaultValue: 'US' },
                { id: 'newServerType', defaultValue: 'Standard' }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.defaultValue;
                }
            });
            
            // Clear status messages
            const statusElements = ['addServerStatus', 'serverFormStatus'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            
            console.log('‚úÖ Server form cleared');
            
        } catch (error) {
            console.error('‚ùå Error clearing server form:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 7: loadServerManager (ENHANCED)
    // ============================================================================
    
    async function loadServerManager() {
        console.log('üîÑ Loading server manager...');
        
        try {
            // Load managed servers first
            await loadManagedServers();
            
            // Refresh the server list display
            refreshServerList();
            
            // Auto-connect to servers if configured
            // (commented out to prevent automatic connections)
            // await autoConnectToAllServers();
            
            console.log('‚úÖ Server manager loaded successfully');
            
        } catch (error) {
            console.error('‚ùå Error loading server manager:', error);
            addLiveConsoleMessage(`Server manager load error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 8: getStatusClass (ENHANCED)
    // ============================================================================
    
    function getStatusClass(status) {
        const statusClasses = {
            'online': 'bg-green-800 text-green-200 border border-green-600',
            'offline': 'bg-red-800 text-red-200 border border-red-600',
            'connecting': 'bg-yellow-800 text-yellow-200 border border-yellow-600',
            'error': 'bg-red-900 text-red-300 border border-red-700',
            'unknown': 'bg-gray-700 text-gray-300 border border-gray-600'
        };
        
        return statusClasses[status] || statusClasses['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 9: getStatusText (ENHANCED)
    // ============================================================================
    
    function getStatusText(status) {
        const statusTexts = {
            'online': 'üü¢ Online',
            'offline': 'üî¥ Offline',
            'connecting': 'üü° Connecting',
            'error': '‚ùå Error',
            'unknown': '‚ö™ Unknown'
        };
        
        return statusTexts[status] || statusTexts['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 10: pingSingleServer (COMPLETELY FIXED WITH PERMANENT SOLUTION)
    // ============================================================================
    
    async function pingSingleServer(serverId) {
        console.log(`üèì [FIXED] Pinging server: ${serverId}`);
        
        try {
            // ‚úÖ TYPE-SAFE: Convert serverId to string for comparison
            const serverIdStr = String(serverId);
            
            // ‚úÖ ENHANCED: Multi-field server lookup with type safety
            let server = (window.managedServers || []).find(s => 
                String(s.serverId) === serverIdStr || 
                String(s.id) === serverIdStr ||
                String(s.server_id) === serverIdStr
            );
            
            if (!server) {
                console.warn(`‚ö†Ô∏è Server ${serverId} not found. Reloading server list...`);
                
                // Try to reload servers first
                await loadManagedServers();
                
                // Try lookup again after reload
                server = (window.managedServers || []).find(s => 
                    String(s.serverId) === serverIdStr || 
                    String(s.id) === serverIdStr ||
                    String(s.server_id) === serverIdStr
                );
                
                if (!server) {
                    throw new Error(`Server ${serverId} not found even after reload`);
                }
            }
            
            const serverName = server.serverName || server.name || `Server ${serverId}`;
            const region = server.serverRegion || server.region || 'US';
            
            console.log(`üéØ Pinging: ${serverName} (${serverIdStr}) in region ${region}`);
            
            // Update UI to show pinging
            updateServerStatus(serverIdStr, 'connecting');
            
            // Make ping API call
            const startTime = Date.now();
            const result = await makeServerAPICall(`/api/servers/ping/${serverIdStr}`, {
                method: 'POST',
                priority: 'high'
            });
            
            const responseTime = Date.now() - startTime;
            
            if (result.success) {
                console.log(`‚úÖ Ping successful: ${serverName} (${responseTime}ms)`);
                
                // Update server status in memory with enhanced lookup
                if (window.managedServers) {
                    const serverIndex = window.managedServers.findIndex(s => 
                        String(s.serverId) === serverIdStr || 
                        String(s.id) === serverIdStr ||
                        String(s.server_id) === serverIdStr
                    );
                    if (serverIndex !== -1) {
                        window.managedServers[serverIndex].status = result.status || 'online';
                        window.managedServers[serverIndex].lastPing = new Date().toISOString();
                        window.managedServers[serverIndex].responseTime = responseTime;
                    }
                }
                
                // Update UI
                updateServerStatus(serverIdStr, result.status || 'online');
                
                // Update dropdowns and refresh display
                updateAllServerDropdowns();
                refreshServerList();
                
                addLiveConsoleMessage(
                    `Ping successful: ${serverName} (${responseTime}ms)`,
                    serverIdStr,
                    'success'
                );
                
                return { success: true, status: result.status || 'online', response_time_ms: responseTime };
                
            } else {
                console.log(`‚ùå Ping failed: ${serverName} - ${result.error}`);
                updateServerStatus(serverIdStr, 'offline');
                
                addLiveConsoleMessage(`Ping failed: ${result.error}`, serverIdStr, 'error');
                return { success: false, status: 'offline', error: result.error };
            }
            
        } catch (error) {
            console.error(`‚ùå Ping error for server ${serverId}:`, error);
            
            // Update server status to error with type-safe ID
            const serverIdStr = String(serverId);
            if (window.managedServers) {
                const serverIndex = window.managedServers.findIndex(s => 
                    String(s.serverId) === serverIdStr || 
                    String(s.id) === serverIdStr ||
                    String(s.server_id) === serverIdStr
                );
                if (serverIndex !== -1) {
                    window.managedServers[serverIndex].status = 'error';
                    window.managedServers[serverIndex].lastPing = new Date().toISOString();
                }
            }
            
            updateServerStatus(serverIdStr, 'error');
            updateAllServerDropdowns();
            refreshServerList();
            
            addLiveConsoleMessage(`Ping error: ${error.message}`, serverIdStr, 'error');
            
            return { success: false, error: error.message };
        }
    }
    
    // ============================================================================
    // NEW: updateServerStatus (ENHANCED STATUS UPDATE FUNCTION)
    // ============================================================================
    
    function updateServerStatus(serverId, status) {
        const serverIdStr = String(serverId);
        
        // Update in managedServers array with enhanced lookup
        if (window.managedServers) {
            const serverIndex = window.managedServers.findIndex(s => 
                String(s.serverId) === serverIdStr || 
                String(s.id) === serverIdStr ||
                String(s.server_id) === serverIdStr
            );
            if (serverIndex !== -1) {
                window.managedServers[serverIndex].status = status;
                window.managedServers[serverIndex].lastPing = new Date().toISOString();
            }
        }
        
        // Update UI elements with multiple selector attempts
        const selectors = [
            `[data-server-id="${serverIdStr}"]`,
            `[data-server="${serverIdStr}"]`,
            `#server-${serverIdStr}`,
            `.server-card[data-id="${serverIdStr}"]`
        ];
        
        let serverCard = null;
        for (const selector of selectors) {
            serverCard = document.querySelector(selector);
            if (serverCard) break;
        }
        
        if (serverCard) {
            // Update status text
            const statusElement = serverCard.querySelector('.server-status, .status, .status-text');
            if (statusElement) {
                statusElement.textContent = getStatusText(status);
                statusElement.className = `server-status ${getStatusClass(status)}`;
            }
            
            // Update status indicator
            const statusIndicator = serverCard.querySelector('.status-indicator, .status-dot');
            if (statusIndicator) {
                statusIndicator.className = `status-indicator ${getStatusClass(status)}`;
            }
        }
        
        console.log(`‚úÖ Updated server ${serverIdStr} status to: ${status}`);
    }
    
    // ============================================================================
    // FUNCTION 11: deleteServer (ENHANCED)
    // ============================================================================
    
    async function deleteServer(serverId) {
        const server = (window.managedServers || []).find(s => s.serverId === serverId);
        const serverName = server ? server.serverName : `Server ${serverId}`;
        
        if (!confirm(`Are you sure you want to delete "${serverName}"?`)) {
            return;
        }
        
        console.log(`üóëÔ∏è Deleting server: ${serverName} (${serverId})`);
        
        try {
            const result = await makeServerAPICall(`/api/servers/delete/${serverId}`, {
                method: 'DELETE',
                priority: 'high'
            });
            
            if (result.success) {
                // Remove from global array
                if (window.managedServers) {
                    window.managedServers = window.managedServers.filter(s => s.serverId !== serverId);
                }
                
                // Update displays
                updateAllServerDropdowns();
                refreshServerList();
                
                console.log(`‚úÖ Server deleted: ${serverName}`);
                addLiveConsoleMessage(`Server "${serverName}" deleted successfully`, serverId, 'success');
                
                return result;
                
            } else {
                throw new Error(result.error || 'Delete failed');
            }
            
        } catch (error) {
            console.error(`‚ùå Delete server error: ${error.message}`);
            addLiveConsoleMessage(`Failed to delete server: ${error.message}`, serverId, 'error');
            alert(`Error deleting server: ${error.message}`);
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 12: refreshServerList (ENHANCED)
    // ============================================================================
    
    async function refreshServerList() {
        console.log('üîÑ Refreshing server list display...');
        
        try {
            const servers = window.managedServers || [];
            const container = document.getElementById('managedServersList');
            
            if (!container) {
                console.warn('‚ö†Ô∏è managedServersList container not found');
                return;
            }
            
            if (servers.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-4">üñ•Ô∏è</div>
                        <div>No servers added yet</div>
                        <div class="text-sm mt-2">Add your first server above to get started</div>
                    </div>
                `;
                return;
            }
            
            // Create server cards
            const serverHTML = servers.map(server => {
                const statusClass = getStatusClass(server.status || 'unknown');
                const statusText = getStatusText(server.status || 'unknown');
                
                return `
                    <div class="bg-gray-700 p-4 rounded-lg border border-gray-600 hover:border-gray-500 transition-colors" data-server-id="${server.serverId}">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg">${escapeHtml(server.serverName || 'Unknown Server')}</h4>
                                <p class="text-gray-400 text-sm">ID: ${escapeHtml(server.serverId || 'N/A')}</p>
                                <p class="text-gray-400 text-xs">
                                    Region: ${escapeHtml(server.serverRegion || 'Unknown')} | 
                                    Type: ${escapeHtml(server.serverType || 'Standard')}
                                </p>
                                ${server.description ? `<p class="text-gray-300 text-sm mt-1">${escapeHtml(server.description)}</p>` : ''}
                                ${server.lastPing ? `<p class="text-gray-500 text-xs mt-1">Last ping: ${new Date(server.lastPing).toLocaleTimeString()}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded text-xs server-status ${statusClass}">
                                    ${statusText}
                                </span>
                                <button onclick="pingSingleServer('${server.serverId}')" 
                                        class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Ping server">
                                    üèì
                                </button>
                                <button onclick="deleteServer('${server.serverId}')" 
                                        class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Delete server">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = serverHTML;
            
            console.log(`‚úÖ Server list refreshed: ${servers.length} servers displayed`);
            
        } catch (error) {
            console.error('‚ùå Error refreshing server list:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 13: updateAllServerDropdowns (ENHANCED)
    // ============================================================================
    
    function updateAllServerDropdowns() {
        console.log('üîÑ Updating all server dropdowns...');
        
        try {
            const servers = window.managedServers || [];
            const dropdownSelectors = [
                '#serverSelector',
                '#eventServerSelect',
                '#consoleServerSelect',
                '#healthServerSelect',
                '.server-dropdown'
            ];
            
            dropdownSelectors.forEach(selector => {
                const dropdowns = document.querySelectorAll(selector);
                
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    
                    const currentValue = dropdown.value;
                    
                    // Create options HTML
                    const optionsHTML = servers.map(server => {
                        const statusIcon = server.status === 'online' ? 'üü¢' : server.status === 'offline' ? 'üî¥' : '‚ö™';
                        return `<option value="${server.serverId}">${statusIcon} ${escapeHtml(server.serverName)} (${server.serverId})</option>`;
                    }).join('');
                    
                    // Update dropdown
                    dropdown.innerHTML = servers.length > 0 
                        ? `<option value="">Select a server...</option>${optionsHTML}`
                        : '<option value="">No servers available</option>';
                    
                    // Restore selection if still valid
                    if (currentValue && servers.some(s => s.serverId === currentValue)) {
                        dropdown.value = currentValue;
                    }
                });
            });
            
            console.log(`‚úÖ Updated dropdowns for ${servers.length} servers`);
            
        } catch (error) {
            console.error('‚ùå Error updating server dropdowns:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 14: disconnectServer (ENHANCED)
    // ============================================================================
    
    async function disconnectServer(serverId) {
        console.log(`üîå Disconnecting from server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            const serverName = server ? server.serverName : `Server ${serverId}`;
            
            // Update connection status
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'disconnecting';
            }
            
            // Simulate disconnection (replace with actual logic)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Update status
            if (window.connectionStatus) {
                delete window.connectionStatus[serverId];
            }
            
            console.log(`‚úÖ Disconnected from server: ${serverName}`);
            addLiveConsoleMessage(`Disconnected from ${serverName}`, serverId, 'info');
            
        } catch (error) {
            console.error(`‚ùå Disconnect error for server ${serverId}:`, error);
            addLiveConsoleMessage(`Disconnect error: ${error.message}`, serverId, 'error');
        }
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================================
    // ‚úÖ ENHANCED MODULE INITIALIZATION AND FUNCTION EXPOSURE
    // ============================================================================
    
    console.log('üì¶ Server Manager module loaded - 14 functions available (ENHANCED VERSION WITH PERMANENT PING FIX)');
    
    // ‚úÖ CRITICAL: Expose all functions to global scope immediately
    if (typeof window !== 'undefined') {
        // Primary functions
        window.loadManagedServers = loadManagedServers;
        window.autoConnectToAllServers = autoConnectToAllServers;
        window.autoConnectToServer = autoConnectToServer;
        window.getServerRegion = getServerRegion;
        window.addNewServer = addNewServer;
        window.clearServerForm = clearServerForm;
        window.loadServerManager = loadServerManager;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.pingSingleServer = pingSingleServer;
        window.updateServerStatus = updateServerStatus; // ‚úÖ NEW: Expose new function
        window.deleteServer = deleteServer;
        window.refreshServerList = refreshServerList;
        window.updateAllServerDropdowns = updateAllServerDropdowns;
        window.disconnectServer = disconnectServer;
        
        // Utility functions
        window.addLiveConsoleMessage = addLiveConsoleMessage;
        window.makeServerAPICall = makeServerAPICall;
        
        console.log('‚úÖ All server manager functions exposed to global scope');
        console.log('üîß Available functions:', {
            addNewServer: typeof window.addNewServer,
            loadServerManager: typeof window.loadServerManager,
            clearServerForm: typeof window.clearServerForm,
            pingSingleServer: typeof window.pingSingleServer,
            updateServerStatus: typeof window.updateServerStatus,
            deleteServer: typeof window.deleteServer
        });
    }
    
    // ‚úÖ ENHANCED: DOM ready initialization
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Server Manager module initialized (ENHANCED VERSION WITH PERMANENT PING FIX)');
        
        // Set up keyboard shortcuts for server form
        const serverFormInputs = ['newServerId', 'newServerName', 'newServerDescription'];
        serverFormInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (typeof window.addNewServer === 'function') {
                            window.addNewServer();
                        }
                    }
                });
            }
        });
        
        console.log('üéØ Server Manager ready - Ping button should now work perfectly!');
    });
    
    console.log('üöÄ Server Manager module fully loaded with permanent ping fixes applied');

</script>