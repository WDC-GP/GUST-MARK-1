<!-- ============================================================================
     GUST Bot Enhanced - Server Manager JavaScript Module (FIXED ERROR HANDLING VERSION)
     ============================================================================
     ‚úÖ FIXED: Cannot read properties of undefined (reading 'serverId') error
     ‚úÖ FIXED: Comprehensive null/undefined checks throughout
     ‚úÖ FIXED: Safe response handling for all API calls
     ‚úÖ COMPLETE: Enhanced function exposure and error handling
     ‚úÖ COMPLETE: Service ID Auto-Discovery integration
     ‚úÖ COMPLETE: Retry discovery functionality
     ‚úÖ COMPLETE: Enhanced API endpoint handling
     ‚úÖ COMPLETE: Dual ID system support
     ============================================================================ -->

<script>
    // ============================================================================
    // SERVER MANAGER MODULE - ENHANCED WITH COMPLETE SERVICE ID INTEGRATION + ERROR FIXES
    // ============================================================================
    
    console.log('üì¶ Loading Server Manager module with complete Service ID integration and error fixes...');
    
    // ============================================================================
    // ENHANCED UTILITY FUNCTIONS
    // ============================================================================
    
    /**
     * ‚úÖ ENHANCED: Safe API call wrapper using enhanced fetch
     */
    async function makeServerAPICall(url, options = {}) {
        try {
            // Use enhanced fetch if available, fallback to regular fetch
            if (typeof window.enhancedFetch === 'function') {
                return await window.enhancedFetch(url, options);
            } else {
                const response = await fetch(url, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
        } catch (error) {
            console.error(`‚ùå API call failed: ${url}`, error);
            throw error;
        }
    }
    
    /**
     * ‚úÖ ENHANCED: Add live console message with better error handling
     */
    function addLiveConsoleMessage(message, serverId = '', type = 'info') {
        try {
            const timestamp = new Date().toISOString();
            const messageObj = {
                timestamp,
                message,
                type,
                source: 'server_manager',
                serverId
            };
            
            // Try multiple methods to add console message
            if (typeof window.addLiveConsoleMessage === 'function') {
                window.addLiveConsoleMessage(messageObj);
            } else if (typeof window.addConsoleMessage === 'function') {
                window.addConsoleMessage(messageObj);
            } else {
                console.log(`üìù Console Message (${type}): ${message}`);
            }
        } catch (error) {
            console.error('‚ùå Error adding console message:', error);
        }
    }
    
    /**
     * ‚úÖ FIXED: Safe data extraction with comprehensive null checks
     */
    function safeExtractServerData(result) {
        try {
            // Check if result exists and is valid
            if (!result || typeof result !== 'object') {
                return {
                    valid: false,
                    error: 'Invalid or missing response data',
                    data: null
                };
            }
            
            // Check if the operation was successful
            if (!result.success) {
                return {
                    valid: false,
                    error: result.error || 'Server operation failed',
                    data: null
                };
            }
            
            // Safely extract server data with fallbacks
            const serverData = result.server_data || result.serverData || {};
            const discovery = result.discovery || {};
            
            // Safely extract properties with null checks and defaults
            const extractedData = {
                serverId: serverData.serverId || serverData.server_id || 'Unknown',
                serviceId: serverData.serviceId || serverData.service_id || null,
                serverName: serverData.serverName || serverData.server_name || 'Unnamed Server',
                serverRegion: serverData.serverRegion || serverData.server_region || 'US',
                serverType: serverData.serverType || serverData.server_type || 'Standard',
                description: serverData.description || '',
                
                // Safe discovery status extraction
                discoveryStatus: discovery.status || serverData.discovery_status || 'unknown',
                discoveryMessage: discovery.message || serverData.discovery_message || 'No discovery information',
                hasServiceId: discovery.has_service_id !== undefined ? discovery.has_service_id : (serverData.serviceId !== null)
            };
            
            return {
                valid: true,
                error: null,
                data: extractedData
            };
            
        } catch (error) {
            console.error('‚ùå Error extracting server data:', error);
            return {
                valid: false,
                error: `Data extraction error: ${error.message}`,
                data: null
            };
        }
    }
    
    /**
     * ‚úÖ FIXED: Display Service ID discovery status with comprehensive error handling
     */
    function displayServiceIdDiscoveryStatus(result, fallbackServerData = null) {
        const statusEl = document.getElementById('addServerStatus');
        if (!statusEl) {
            console.warn('‚ö†Ô∏è addServerStatus element not found');
            return;
        }
        
        try {
            // Use safe data extraction
            const extraction = safeExtractServerData(result);
            
            if (!extraction.valid) {
                // Show error status
                statusEl.innerHTML = `
                    <div class="discovery-error bg-red-900 border border-red-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-red-400">‚ùå</span>
                            <span class="font-medium text-red-300">Error Processing Response</span>
                        </div>
                        <div class="text-sm text-red-200">
                            ${escapeHtml(extraction.error)}
                        </div>
                    </div>
                `;
                return;
            }
            
            const serverData = extraction.data;
            let statusHTML = '';
            let statusClass = '';
            
            if (serverData.discoveryStatus === 'success' && serverData.serviceId) {
                statusHTML = `
                    <div class="discovery-success bg-green-900 border border-green-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-green-400">‚úÖ</span>
                            <span class="font-medium text-green-300">Server Added Successfully!</span>
                        </div>
                        <div class="text-sm space-y-1 text-green-200">
                            <div><strong>Server ID:</strong> ${escapeHtml(serverData.serverId)} (for health monitoring)</div>
                            <div><strong>Service ID:</strong> ${escapeHtml(serverData.serviceId)} (for commands)</div>
                            <div><strong>Discovery:</strong> Auto-discovered successfully</div>
                        </div>
                        <div class="mt-2 text-xs">
                            <div class="flex space-x-4">
                                <span class="text-green-400">Health Monitoring ‚úì</span>
                                <span class="text-green-400">Commands ‚úì</span>
                            </div>
                        </div>
                    </div>
                `;
                statusClass = 'success';
                
                // Add console message
                addLiveConsoleMessage(
                    `Server "${serverData.serverName}" added with Service ID ${serverData.serviceId}`, 
                    serverData.serverId, 
                    'success'
                );
                
            } else if (serverData.discoveryStatus === 'failed' || !serverData.serviceId) {
                statusHTML = `
                    <div class="discovery-partial bg-yellow-900 border border-yellow-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-yellow-400">‚ö†</span>
                            <span class="font-medium text-yellow-300">Server Added (Partial Setup)</span>
                        </div>
                        <div class="text-sm space-y-1 text-yellow-200">
                            <div><strong>Server ID:</strong> ${escapeHtml(serverData.serverId)} ‚úì</div>
                            <div><strong>Service ID:</strong> <span class="text-yellow-400">Not discovered</span></div>
                            <div class="text-xs text-gray-400">${escapeHtml(serverData.discoveryMessage)}</div>
                        </div>
                        <div class="mt-2 flex justify-between items-center">
                            <div class="text-xs">
                                <span class="text-green-400">Health Monitoring ‚úì</span>
                                <span class="text-yellow-400 ml-3">Commands ‚ö†</span>
                            </div>
                            <button onclick="retryServiceIdDiscovery('${escapeHtml(serverData.serverId)}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                üîÑ Retry Discovery
                            </button>
                        </div>
                    </div>
                `;
                statusClass = 'warning';
                
                addLiveConsoleMessage(
                    `Server "${serverData.serverName}" added but Service ID discovery failed`, 
                    serverData.serverId, 
                    'warning'
                );
                
            } else {
                statusHTML = `
                    <div class="discovery-error bg-red-900 border border-red-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-red-400">‚ùå</span>
                            <span class="font-medium text-red-300">Server Added (Discovery Error)</span>
                        </div>
                        <div class="text-sm space-y-1 text-red-200">
                            <div><strong>Server ID:</strong> ${escapeHtml(serverData.serverId)} ‚úì</div>
                            <div><strong>Service ID:</strong> <span class="text-red-400">Discovery error</span></div>
                            <div class="text-xs text-gray-400">${escapeHtml(serverData.discoveryMessage)}</div>
                        </div>
                        <div class="mt-2 flex justify-between items-center">
                            <div class="text-xs">
                                <span class="text-green-400">Health Monitoring ‚úì</span>
                                <span class="text-red-400 ml-3">Commands ‚ùå</span>
                            </div>
                            <button onclick="retryServiceIdDiscovery('${escapeHtml(serverData.serverId)}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                üîÑ Retry Discovery
                            </button>
                        </div>
                    </div>
                `;
                statusClass = 'error';
                
                addLiveConsoleMessage(
                    `Server "${serverData.serverName}" added with discovery error`, 
                    serverData.serverId, 
                    'error'
                );
            }
            
            statusEl.innerHTML = statusHTML;
            statusEl.className = `discovery-status ${statusClass}`;
            
            // Auto-clear after 10 seconds
            setTimeout(() => {
                if (statusEl.innerHTML === statusHTML) {
                    statusEl.innerHTML = '';
                    statusEl.className = '';
                }
            }, 10000);
            
        } catch (error) {
            console.error('‚ùå Error displaying Service ID discovery status:', error);
            statusEl.innerHTML = `
                <div class="discovery-error bg-red-900 border border-red-600 rounded-lg p-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-red-400">‚ùå</span>
                        <span class="font-medium text-red-300">Status Display Error</span>
                    </div>
                    <div class="text-sm text-red-200 mt-1">
                        ${escapeHtml(error.message)}
                    </div>
                </div>
            `;
        }
    }
    
    // ============================================================================
    // FUNCTION 1: loadManagedServers (ENHANCED)
    // ============================================================================
    
    async function loadManagedServers() {
        console.log('üîÑ Loading managed servers...');
        
        try {
            const servers = await makeServerAPICall('/api/servers');
            
            // Update global variable
            if (window.managedServers) {
                window.managedServers = servers;
            } else {
                window.managedServers = servers;
            }
            
            // Update server dropdowns across the application
            updateAllServerDropdowns();
            
            // Update display
            refreshServerList();
            
            console.log(`‚úÖ Loaded ${servers.length} managed servers`);
            addLiveConsoleMessage(`Loaded ${servers.length} managed servers`, '', 'success');
            
            return servers;
            
        } catch (error) {
            console.error('‚ùå Error loading managed servers:', error);
            addLiveConsoleMessage(`Error loading servers: ${error.message}`, '', 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 2: autoConnectToAllServers (ENHANCED)
    // ============================================================================
    
    async function autoConnectToAllServers() {
        console.log('üîÑ Auto-connecting to all servers...');
        
        try {
            const servers = window.managedServers || [];
            if (servers.length === 0) {
                console.log('‚ÑπÔ∏è No servers to connect to');
                return;
            }
            
            let connectedCount = 0;
            let errorCount = 0;
            
            for (const server of servers) {
                try {
                    await autoConnectToServer(server.serverId);
                    connectedCount++;
                } catch (error) {
                    console.error(`‚ùå Failed to connect to server ${server.serverId}:`, error);
                    errorCount++;
                }
                
                // Small delay between connections
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const message = `Auto-connect complete: ${connectedCount} connected, ${errorCount} failed`;
            console.log(`‚úÖ ${message}`);
            addLiveConsoleMessage(message, '', connectedCount > 0 ? 'success' : 'warning');
            
        } catch (error) {
            console.error('‚ùå Error in auto-connect all:', error);
            addLiveConsoleMessage(`Auto-connect error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 3: autoConnectToServer (ENHANCED)
    // ============================================================================
    
    async function autoConnectToServer(serverId) {
        console.log(`üîÑ Auto-connecting to server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found in managed servers`);
            }
            
            // Update connection status
            if (!window.connectionStatus) {
                window.connectionStatus = {};
            }
            window.connectionStatus[serverId] = 'connecting';
            
            // Simulate connection logic (replace with actual implementation)
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Update status to connected
            window.connectionStatus[serverId] = 'connected';
            
            console.log(`‚úÖ Connected to server: ${server.serverName} (${serverId})`);
            addLiveConsoleMessage(`Connected to ${server.serverName}`, serverId, 'success');
            
            return true;
            
        } catch (error) {
            console.error(`‚ùå Failed to connect to server ${serverId}:`, error);
            
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'error';
            }
            
            addLiveConsoleMessage(`Connection failed: ${error.message}`, serverId, 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 4: getServerRegion (ENHANCED)
    // ============================================================================
    
    function getServerRegion(serverId) {
        try {
            const servers = window.managedServers || [];
            const server = servers.find(s => s.serverId === serverId);
            return server ? server.serverRegion : 'US';
        } catch (error) {
            console.error('‚ùå Error getting server region:', error);
            return 'US';
        }
    }
    
    // ============================================================================
    // FUNCTION 5: addNewServer (FIXED WITH COMPREHENSIVE ERROR HANDLING)
    // ============================================================================
    
    async function addNewServer() {
        console.log('üîÑ Adding new server with Service ID Auto-Discovery...');
        
        const btn = document.getElementById('addServerBtn') || document.querySelector('[onclick="addNewServer()"]');
        const status = document.getElementById('addServerStatus');
        
        try {
            // Show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = 'üîç Discovering...';
            }
            
            if (status) {
                status.innerHTML = '<div class="text-blue-400 flex items-center gap-2"><div class="animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full"></div>üîç Discovering Service ID...</div>';
            }
            
            // Get form data with validation
            const serverId = document.getElementById('newServerId')?.value?.trim() || '';
            const serverName = document.getElementById('newServerName')?.value?.trim() || '';
            const serverRegion = document.getElementById('newServerRegion')?.value || 'US';
            const serverType = document.getElementById('newServerType')?.value || 'Standard';
            const description = document.getElementById('newServerDescription')?.value?.trim() || '';
            
            // Validate form data
            if (!serverId || !serverName) {
                throw new Error('Server ID and Server Name are required');
            }
            
            if (!/^\d+$/.test(serverId)) {
                throw new Error('Server ID must be numeric');
            }
            
            // Check for duplicates
            const existingServer = (window.managedServers || []).find(s => s.serverId === serverId);
            if (existingServer) {
                throw new Error('A server with this ID already exists!');
            }
            
            // Prepare server data
            const serverData = {
                serverId,
                serverName,
                serverRegion,
                serverType,
                description
            };
            
            console.log('üöÄ Making enhanced server addition API call with Service ID discovery...');
            
            // Make API call with Service ID discovery
            const result = await makeServerAPICall('/api/servers/add', {
                method: 'POST',
                body: JSON.stringify(serverData),
                priority: 'high' // High priority for user actions
            });
            
            // ‚úÖ FIXED: Safe response handling with comprehensive null checks
            if (result && result.success) {
                console.log('‚úÖ Server added successfully with Service ID discovery');
                console.log('üîç Discovery result:', result.discovery);
                
                // ‚úÖ FIXED: Use safe display function with fallback data
                displayServiceIdDiscoveryStatus(result, serverData);
                
                // Clear form
                clearServerForm();
                
                // Reload servers
                try {
                    await loadManagedServers();
                } catch (loadError) {
                    console.warn('‚ö†Ô∏è Failed to reload servers after addition:', loadError);
                }
                
                // Refresh display
                try {
                    loadServerManager();
                } catch (displayError) {
                    console.warn('‚ö†Ô∏è Failed to refresh display after addition:', displayError);
                }
                
                return result;
                
            } else {
                // ‚úÖ FIXED: Handle unsuccessful response safely
                const errorMsg = (result && result.error) ? result.error : 'Server addition failed - no response data';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            console.error('‚ùå Add server error with Service ID discovery:', error);
            addLiveConsoleMessage(`Failed to add server: ${error.message}`, '', 'error');
            
            // Show error message if status element exists
            if (status) {
                status.innerHTML = `
                    <div class="discovery-error bg-red-900 border border-red-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-400">‚ùå</span>
                            <span class="font-medium text-red-300">Error Adding Server</span>
                        </div>
                        <div class="text-sm text-red-200 mt-1">
                            ${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
            }
            
            throw error;
            
        } finally {
            // Reset button state
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '‚ûï Add Server';
            }
        }
    }
    
    // ============================================================================
    // FUNCTION 6: ‚úÖ FIXED - Retry Service ID Discovery with Error Handling
    // ============================================================================
    
    async function retryServiceIdDiscovery(serverId) {
        console.log(`üîÑ Retrying Service ID discovery for server: ${serverId}`);
        
        try {
            // ‚úÖ FIXED: Safe server lookup with validation
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found`);
            }
            
            const region = server.serverRegion || 'US';
            
            // Show retry status
            addLiveConsoleMessage(
                `Retrying Service ID discovery for ${server.serverName}...`, 
                serverId, 
                'info'
            );
            
            // Make retry API call
            const result = await makeServerAPICall(`/api/servers/discover-service-id/${serverId}`, {
                method: 'POST',
                body: JSON.stringify({ region: region }),
                priority: 'high'
            });
            
            // ‚úÖ FIXED: Safe result validation
            if (result && result.success && result.service_id) {
                console.log(`‚úÖ Service ID discovery retry successful: ${result.service_id}`);
                
                addLiveConsoleMessage(
                    `Service ID discovered: ${result.service_id} for ${server.serverName}`, 
                    serverId, 
                    'success'
                );
                
                // Show success notification
                const statusEl = document.getElementById('addServerStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <div class="bg-green-900 border border-green-600 rounded-lg p-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-400">‚úÖ</span>
                                <span class="font-medium text-green-300">Service ID Discovery Successful!</span>
                            </div>
                            <div class="text-sm text-green-200 mt-1">
                                Service ID ${escapeHtml(result.service_id)} discovered for ${escapeHtml(server.serverName)}
                            </div>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        statusEl.innerHTML = '';
                    }, 5000);
                }
                
                // Reload server manager to show updated capabilities
                try {
                    await loadManagedServers();
                    refreshServerList();
                    updateAllServerDropdowns();
                } catch (reloadError) {
                    console.warn('‚ö†Ô∏è Failed to reload after retry success:', reloadError);
                }
                
                return result;
                
            } else {
                const errorMsg = (result && result.error) ? result.error : 'Discovery retry failed - no valid response';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            console.error(`‚ùå Service ID discovery retry failed:`, error);
            addLiveConsoleMessage(
                `Service ID retry failed: ${error.message}`, 
                serverId, 
                'error'
            );
            
            // Show error notification
            const statusEl = document.getElementById('addServerStatus');
            if (statusEl) {
                statusEl.innerHTML = `
                    <div class="bg-red-900 border border-red-600 rounded-lg p-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-red-400">‚ùå</span>
                            <span class="font-medium text-red-300">Service ID Discovery Failed</span>
                        </div>
                        <div class="text-sm text-red-200 mt-1">
                            ${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    statusEl.innerHTML = '';
                }, 5000);
            }
            
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 7: ‚úÖ NEW - Bulk Service ID Discovery
    // ============================================================================
    
    async function bulkDiscoverServiceIds() {
        console.log('üîÑ Starting bulk Service ID discovery...');
        
        try {
            addLiveConsoleMessage('Starting bulk Service ID discovery...', '', 'info');
            
            const result = await makeServerAPICall('/api/servers/discover-all-service-ids', {
                method: 'POST',
                priority: 'high'
            });
            
            if (result && result.success) {
                console.log(`‚úÖ Bulk discovery complete: ${result.discovered}/${result.total} successful`);
                
                addLiveConsoleMessage(
                    `Bulk discovery complete: ${result.discovered} Service IDs discovered`, 
                    '', 
                    'success'
                );
                
                // Reload servers to show updated capabilities
                try {
                    await loadManagedServers();
                    refreshServerList();
                } catch (reloadError) {
                    console.warn('‚ö†Ô∏è Failed to reload after bulk discovery:', reloadError);
                }
                
                return result;
                
            } else {
                const errorMsg = (result && result.error) ? result.error : 'Bulk discovery failed - no valid response';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            console.error('‚ùå Bulk Service ID discovery error:', error);
            addLiveConsoleMessage(`Bulk discovery failed: ${error.message}`, '', 'error');
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 8: clearServerForm (ENHANCED)
    // ============================================================================
    
    function clearServerForm() {
        try {
            const fields = [
                { id: 'newServerId', defaultValue: '' },
                { id: 'newServerName', defaultValue: '' },
                { id: 'newServerDescription', defaultValue: '' },
                { id: 'newServerRegion', defaultValue: 'US' },
                { id: 'newServerType', defaultValue: 'Standard' }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.defaultValue;
                }
            });
            
            // Clear status messages
            const statusElements = ['addServerStatus', 'serverFormStatus'];
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            
            console.log('‚úÖ Server form cleared');
            
        } catch (error) {
            console.error('‚ùå Error clearing server form:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 9: loadServerManager (ENHANCED)
    // ============================================================================
    
    async function loadServerManager() {
        console.log('üîÑ Loading server manager...');
        
        try {
            // Load managed servers first
            await loadManagedServers();
            
            // Refresh the server list display
            refreshServerList();
            
            // Auto-connect to servers if configured
            // (commented out to prevent automatic connections)
            // await autoConnectToAllServers();
            
            console.log('‚úÖ Server manager loaded successfully');
            
        } catch (error) {
            console.error('‚ùå Error loading server manager:', error);
            addLiveConsoleMessage(`Server manager load error: ${error.message}`, '', 'error');
        }
    }
    
    // ============================================================================
    // FUNCTION 10: getStatusClass (ENHANCED)
    // ============================================================================
    
    function getStatusClass(status) {
        const statusClasses = {
            'online': 'bg-green-800 text-green-200 border border-green-600',
            'offline': 'bg-red-800 text-red-200 border border-red-600',
            'connecting': 'bg-yellow-800 text-yellow-200 border border-yellow-600',
            'error': 'bg-red-900 text-red-300 border border-red-700',
            'unknown': 'bg-gray-700 text-gray-300 border border-gray-600'
        };
        
        return statusClasses[status] || statusClasses['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 11: getStatusText (ENHANCED)
    // ============================================================================
    
    function getStatusText(status) {
        const statusTexts = {
            'online': 'üü¢ Online',
            'offline': 'üî¥ Offline',
            'connecting': 'üü° Connecting',
            'error': '‚ùå Error',
            'unknown': '‚ö™ Unknown'
        };
        
        return statusTexts[status] || statusTexts['unknown'];
    }
    
    // ============================================================================
    // FUNCTION 12: ‚úÖ FIXED - Get Service ID Status Indicators with Error Handling
    // ============================================================================
    
    function getServiceIdStatusIndicator(server) {
        try {
            // ‚úÖ FIXED: Safe server validation
            if (!server || typeof server !== 'object') {
                return {
                    icon: '‚ùì',
                    text: 'Unknown Status',
                    class: 'text-gray-400',
                    serviceId: null
                };
            }
            
            const hasServiceId = server.serviceId !== null && server.serviceId !== undefined && server.serviceId !== '';
            const discoveryStatus = server.discovery_status || 'unknown';
            
            if (hasServiceId) {
                return {
                    icon: '‚úÖ',
                    text: 'Full Capabilities',
                    class: 'text-green-400',
                    serviceId: server.serviceId
                };
            } else if (discoveryStatus === 'failed') {
                return {
                    icon: '‚ö†Ô∏è',
                    text: 'Partial Capabilities',
                    class: 'text-yellow-400',
                    serviceId: null
                };
            } else if (discoveryStatus === 'error') {
                return {
                    icon: '‚ùå',
                    text: 'Discovery Error',
                    class: 'text-red-400',
                    serviceId: null
                };
            } else {
                return {
                    icon: '‚ùì',
                    text: 'Unknown Status',
                    class: 'text-gray-400',
                    serviceId: null
                };
            }
        } catch (error) {
            console.error('‚ùå Error getting Service ID status:', error);
            return {
                icon: '‚ùì',
                text: 'Error',
                class: 'text-gray-400',
                serviceId: null
            };
        }
    }
    
    // ============================================================================
    // FUNCTION 13: pingSingleServer (ENHANCED)
    // ============================================================================
    
    async function pingSingleServer(serverId) {
        console.log(`üèì Pinging server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            if (!server) {
                throw new Error(`Server ${serverId} not found`);
            }
            
            // Make ping API call
            const result = await makeServerAPICall(`/api/servers/ping/${serverId}`, {
                method: 'POST',
                priority: 'high'
            });
            
            if (result && result.success) {
                console.log(`‚úÖ Ping successful: ${server.serverName} (${result.response_time_ms || 'N/A'}ms)`);
                
                // Update server status if we have the servers array
                if (window.managedServers) {
                    const serverIndex = window.managedServers.findIndex(s => s.serverId === serverId);
                    if (serverIndex !== -1) {
                        window.managedServers[serverIndex].status = result.status;
                        window.managedServers[serverIndex].lastPing = result.ping_time;
                        window.managedServers[serverIndex].responseTime = result.response_time_ms;
                    }
                }
                
                // Update dropdowns and refresh display
                updateAllServerDropdowns();
                refreshServerList();
                
                addLiveConsoleMessage(
                    `Ping successful: ${server.serverName} (${result.response_time_ms || 'N/A'}ms)`,
                    serverId,
                    'success'
                );
                
                return result;
                
            } else {
                const errorMsg = (result && result.message) ? result.message : 'Ping failed - no valid response';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            console.error(`‚ùå Ping failed for server ${serverId}:`, error);
            
            // Update server status to error
            if (window.managedServers) {
                const serverIndex = window.managedServers.findIndex(s => s.serverId === serverId);
                if (serverIndex !== -1) {
                    window.managedServers[serverIndex].status = 'error';
                    window.managedServers[serverIndex].lastPing = new Date().toISOString();
                }
            }
            
            updateAllServerDropdowns();
            refreshServerList();
            
            addLiveConsoleMessage(
                `Ping failed: ${error.message}`,
                serverId,
                'error'
            );
            
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 14: deleteServer (ENHANCED)
    // ============================================================================
    
    async function deleteServer(serverId) {
        const server = (window.managedServers || []).find(s => s.serverId === serverId);
        const serverName = server ? server.serverName : `Server ${serverId}`;
        
        if (!confirm(`Are you sure you want to delete "${serverName}"?`)) {
            return;
        }
        
        console.log(`üóëÔ∏è Deleting server: ${serverName} (${serverId})`);
        
        try {
            const result = await makeServerAPICall(`/api/servers/delete/${serverId}`, {
                method: 'DELETE',
                priority: 'high'
            });
            
            if (result && result.success) {
                // Remove from global array
                if (window.managedServers) {
                    window.managedServers = window.managedServers.filter(s => s.serverId !== serverId);
                }
                
                // Update displays
                updateAllServerDropdowns();
                refreshServerList();
                
                console.log(`‚úÖ Server deleted: ${serverName}`);
                addLiveConsoleMessage(`Server "${serverName}" deleted successfully`, serverId, 'success');
                
                return result;
                
            } else {
                const errorMsg = (result && result.error) ? result.error : 'Delete failed - no valid response';
                throw new Error(errorMsg);
            }
            
        } catch (error) {
            console.error(`‚ùå Delete server error: ${error.message}`);
            addLiveConsoleMessage(`Failed to delete server: ${error.message}`, serverId, 'error');
            alert(`Error deleting server: ${error.message}`);
            throw error;
        }
    }
    
    // ============================================================================
    // FUNCTION 15: refreshServerList (ENHANCED WITH SERVICE ID DISPLAY)
    // ============================================================================
    
    async function refreshServerList() {
        console.log('üîÑ Refreshing server list display with Service ID information...');
        
        try {
            const servers = window.managedServers || [];
            const container = document.getElementById('managedServersList');
            
            if (!container) {
                console.warn('‚ö†Ô∏è managedServersList container not found');
                return;
            }
            
            if (servers.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 text-center py-8">
                        <div class="text-4xl mb-4">üñ•Ô∏è</div>
                        <div>No servers added yet</div>
                        <div class="text-sm mt-2">Add your first server above to get started</div>
                    </div>
                `;
                return;
            }
            
            // Create server cards with Service ID information
            const serverHTML = servers.map(server => {
                // ‚úÖ FIXED: Safe server data handling
                const serverId = server.serverId || 'Unknown';
                const serverName = server.serverName || 'Unknown Server';
                const serverRegion = server.serverRegion || 'Unknown';
                const serverType = server.serverType || 'Standard';
                const description = server.description || '';
                const serviceId = server.serviceId || null;
                
                const statusClass = getStatusClass(server.status || 'unknown');
                const statusText = getStatusText(server.status || 'unknown');
                const serviceIdStatus = getServiceIdStatusIndicator(server);
                
                return `
                    <div class="bg-gray-700 p-4 rounded-lg border border-gray-600 hover:border-gray-500 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg">${escapeHtml(serverName)}</h4>
                                <div class="text-gray-400 text-sm space-y-1">
                                    <div>Server ID: ${escapeHtml(serverId)} (for health monitoring)</div>
                                    ${serviceId ? 
                                        `<div>Service ID: ${escapeHtml(serviceId)} (for commands)</div>` :
                                        `<div>Service ID: <span class="text-yellow-400">Not available</span></div>`
                                    }
                                    <div>Region: ${escapeHtml(serverRegion)} | Type: ${escapeHtml(serverType)}</div>
                                </div>
                                ${description ? `<p class="text-gray-300 text-sm mt-1">${escapeHtml(description)}</p>` : ''}
                                
                                <!-- Service ID Capabilities -->
                                <div class="mt-2 flex items-center space-x-3 text-xs">
                                    <span class="${serviceIdStatus.class}">
                                        ${serviceIdStatus.icon} ${serviceIdStatus.text}
                                    </span>
                                    ${serviceId ? 
                                        '<span class="text-green-400">‚úì Commands Ready</span>' : 
                                        '<span class="text-yellow-400">‚ö† Commands Limited</span>'
                                    }
                                </div>
                                
                                ${server.lastPing ? `<p class="text-gray-500 text-xs mt-1">Last ping: ${new Date(server.lastPing).toLocaleTimeString()}</p>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 rounded text-xs ${statusClass}">
                                    ${statusText}
                                </span>
                                ${!serviceId && server.discovery_status !== 'success' ? 
                                    `<button onclick="retryServiceIdDiscovery('${escapeHtml(serverId)}')" 
                                            class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs transition-colors"
                                            title="Retry Service ID discovery">
                                        üîÑ
                                    </button>` : ''
                                }
                                <button onclick="pingSingleServer('${escapeHtml(serverId)}')" 
                                        class="bg-green-600 hover:bg-green-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Ping server">
                                    üèì
                                </button>
                                <button onclick="deleteServer('${escapeHtml(serverId)}')" 
                                        class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs transition-colors"
                                        title="Delete server">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = serverHTML;
            
            console.log(`‚úÖ Server list refreshed: ${servers.length} servers displayed with Service ID information`);
            
        } catch (error) {
            console.error('‚ùå Error refreshing server list:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 16: updateAllServerDropdowns (ENHANCED)
    // ============================================================================
    
    function updateAllServerDropdowns() {
        console.log('üîÑ Updating all server dropdowns...');
        
        try {
            const servers = window.managedServers || [];
            const dropdownSelectors = [
                '#serverSelector',
                '#eventServerSelect',
                '#consoleServerSelect',
                '#healthServerSelect',
                '#server-health-selector',
                '.server-dropdown'
            ];
            
            dropdownSelectors.forEach(selector => {
                const dropdowns = document.querySelectorAll(selector);
                
                dropdowns.forEach(dropdown => {
                    if (!dropdown) return;
                    
                    const currentValue = dropdown.value;
                    
                    // Create options HTML with Service ID indicators
                    const optionsHTML = servers.map(server => {
                        // ‚úÖ FIXED: Safe server data access
                        const serverId = server.serverId || 'unknown';
                        const serverName = server.serverName || 'Unknown Server';
                        const serviceId = server.serviceId || null;
                        
                        const statusIcon = server.status === 'online' ? 'üü¢' : server.status === 'offline' ? 'üî¥' : '‚ö™';
                        const serviceIdIcon = serviceId ? '‚úÖ' : '‚ö†Ô∏è';
                        return `<option value="${escapeHtml(serverId)}">${statusIcon}${serviceIdIcon} ${escapeHtml(serverName)} (${escapeHtml(serverId)})</option>`;
                    }).join('');
                    
                    // Update dropdown
                    dropdown.innerHTML = servers.length > 0 
                        ? `<option value="">Select a server...</option>${optionsHTML}`
                        : '<option value="">No servers available</option>';
                    
                    // Restore selection if still valid
                    if (currentValue && servers.some(s => s.serverId === currentValue)) {
                        dropdown.value = currentValue;
                    }
                });
            });
            
            console.log(`‚úÖ Updated dropdowns for ${servers.length} servers with Service ID indicators`);
            
        } catch (error) {
            console.error('‚ùå Error updating server dropdowns:', error);
        }
    }
    
    // ============================================================================
    // FUNCTION 17: disconnectServer (ENHANCED)
    // ============================================================================
    
    async function disconnectServer(serverId) {
        console.log(`üîå Disconnecting from server: ${serverId}`);
        
        try {
            const server = (window.managedServers || []).find(s => s.serverId === serverId);
            const serverName = server ? server.serverName : `Server ${serverId}`;
            
            // Update connection status
            if (window.connectionStatus) {
                window.connectionStatus[serverId] = 'disconnecting';
            }
            
            // Simulate disconnection (replace with actual logic)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Update status
            if (window.connectionStatus) {
                delete window.connectionStatus[serverId];
            }
            
            console.log(`‚úÖ Disconnected from server: ${serverName}`);
            addLiveConsoleMessage(`Disconnected from ${serverName}`, serverId, 'info');
            
        } catch (error) {
            console.error(`‚ùå Disconnect error for server ${serverId}:`, error);
            addLiveConsoleMessage(`Disconnect error: ${error.message}`, serverId, 'error');
        }
    }
    
    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    function escapeHtml(text) {
        if (!text || typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================================
    // ‚úÖ ENHANCED MODULE INITIALIZATION AND FUNCTION EXPOSURE
    // ============================================================================
    
    console.log('üì¶ Server Manager module loaded - 17 functions available (FIXED ERROR HANDLING VERSION)');
    
    // ‚úÖ CRITICAL: Expose all functions to global scope immediately
    if (typeof window !== 'undefined') {
        // Primary functions
        window.loadManagedServers = loadManagedServers;
        window.autoConnectToAllServers = autoConnectToAllServers;
        window.autoConnectToServer = autoConnectToServer;
        window.getServerRegion = getServerRegion;
        window.addNewServer = addNewServer;
        window.clearServerForm = clearServerForm;
        window.loadServerManager = loadServerManager;
        window.getStatusClass = getStatusClass;
        window.getStatusText = getStatusText;
        window.pingSingleServer = pingSingleServer;
        window.deleteServer = deleteServer;
        window.refreshServerList = refreshServerList;
        window.updateAllServerDropdowns = updateAllServerDropdowns;
        window.disconnectServer = disconnectServer;
        
        // ‚úÖ NEW: Service ID functions
        window.retryServiceIdDiscovery = retryServiceIdDiscovery;
        window.bulkDiscoverServiceIds = bulkDiscoverServiceIds;
        window.getServiceIdStatusIndicator = getServiceIdStatusIndicator;
        
        // Utility functions
        window.addLiveConsoleMessage = addLiveConsoleMessage;
        window.makeServerAPICall = makeServerAPICall;
        window.displayServiceIdDiscoveryStatus = displayServiceIdDiscoveryStatus;
        window.safeExtractServerData = safeExtractServerData;
        
        console.log('‚úÖ All server manager functions exposed to global scope with error handling');
        console.log('üîß Available functions:', {
            addNewServer: typeof window.addNewServer,
            loadServerManager: typeof window.loadServerManager,
            clearServerForm: typeof window.clearServerForm,
            pingSingleServer: typeof window.pingSingleServer,
            deleteServer: typeof window.deleteServer,
            retryServiceIdDiscovery: typeof window.retryServiceIdDiscovery,
            bulkDiscoverServiceIds: typeof window.bulkDiscoverServiceIds,
            safeExtractServerData: typeof window.safeExtractServerData
        });
    }
    
    // ============================================================================
    // ‚úÖ ENHANCED: DOM READY INITIALIZATION WITH SERVICE ID SUPPORT
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('‚úÖ Server Manager module initialized (FIXED ERROR HANDLING VERSION)');
        
        // Set up keyboard shortcuts for server form
        const serverFormInputs = ['newServerId', 'newServerName', 'newServerDescription'];
        serverFormInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (typeof window.addNewServer === 'function') {
                            window.addNewServer();
                        }
                    }
                });
            }
        });
        
        // Add bulk discovery button if container exists
        const bulkDiscoveryContainer = document.getElementById('bulk-discovery-container');
        if (bulkDiscoveryContainer) {
            bulkDiscoveryContainer.innerHTML = `
                <button onclick="bulkDiscoverServiceIds()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                    üîç Discover All Service IDs
                </button>
            `;
        }
        
        console.log('üéØ Server Manager ready - All Service ID features available with comprehensive error handling');
        console.log('üöÄ Service ID Auto-Discovery system integrated and functional with safety checks');
    });
    
    console.log('üöÄ Server Manager module fully loaded with complete Service ID Auto-Discovery integration and comprehensive error handling');

</script>